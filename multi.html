<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de devis modulable — 3D & Design</title>
  <style>
    :root {
      --bg-1: #e6f0ff;
      --bg-2: #d8dcff;
      --bg-3: #f3f7ff;
      --bg-4: #d3f4ff;
      --glass: rgba(255, 255, 255, 0.35);
      --glass-strong: rgba(255, 255, 255, 0.65);
      --border: rgba(255, 255, 255, 0.5);
      --shadow: 0 24px 60px rgba(12, 25, 58, 0.16);
      --accent: #3b82f6;
      --accent-2: #7c3aed;
      --accent-3: #06b6d4;
      --success: #14b8a6;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #6b7280;
      --radius-xl: 26px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --transition: 180ms ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", Roboto, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.18), transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(6, 182, 212, 0.2), transparent 35%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.16), transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-3) 55%, #ffffff 100%);
      min-height: 100vh;
      padding: 28px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.6), transparent 38%),
        radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.45), transparent 35%),
        radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.35), transparent 40%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      z-index: -1;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 10% 10% auto auto;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.35), transparent 70%);
      filter: blur(25px);
      opacity: 0.6;
      pointer-events: none;
      z-index: -1;
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .content {
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 12px 18px;
      border-radius: var(--radius-xl);
      background: rgba(255, 255, 255, 0.25);
      border: none;
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(14px);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .subtle {
      color: var(--muted);
    }

    .glass {
      border: none;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px) saturate(160%);
      -webkit-backdrop-filter: blur(22px) saturate(160%);
      position: relative;
      overflow: hidden;
    }

    .glass::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: none;
      pointer-events: none;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6),
        inset 0 -10px 20px rgba(255, 255, 255, 0.15);
    }

    .glass::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.5), transparent 45%);
      opacity: 0.7;
      pointer-events: none;
    }

    .panel {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .panel h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .toggle-group {
      display: inline-flex;
      align-self: flex-start;
      width: fit-content;
      background: rgba(255, 255, 255, 0.35);
      border: none;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.6);
    }

    .toggle-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
    }

    .toggle-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: #1d4ed8;
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.2);
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.55);
      border: none;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(59, 130, 246, 0.2);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .grid > div {
      flex: 1 1 220px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .form-item {
      flex: 1 1 240px;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .is-disabled {
      opacity: 0.45;
      filter: grayscale(0.4);
      position: relative;
      pointer-events: none;
    }

    .is-disabled input,
    .is-disabled select,
    .is-disabled button {
      background: rgba(255, 255, 255, 0.35);
      box-shadow: none;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px;
      font-size: 1rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.55);
      transition: var(--transition);
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      padding: 0;
      margin: 0;
      border-radius: 4px;
      box-shadow: none;
      background: rgba(255, 255, 255, 0.9);
      accent-color: var(--accent-2);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(255, 255, 255, 0.92);
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stepper button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.6);
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .stepper button:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 16px rgba(16, 24, 40, 0.12);
    }

    .helper {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .options > label {
      flex: 1 1 180px;
      min-width: 180px;
    }

    .module-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 16px;
    }

    .module-card {
      padding: 18px;
      border-radius: var(--radius-xl);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .module-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .module-title input {
      font-weight: 600;
      min-width: 200px;
    }

    .module-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .module-body {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .module-section {
      padding: 12px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .module-section h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .module-summary {
      padding: 12px;
      border-radius: 14px;
      background: rgba(59, 130, 246, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .module-typology-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .module-typology-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.68);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
      overflow-wrap: anywhere;
    }

    .module-typology-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .module-typology-title {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .module-typology-title input {
      flex: 1;
      min-width: 180px;
    }

    .module-typology-tag {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.14);
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .module-typology-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: start;
    }

    .module-typology-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .module-typology-row input,
    .module-typology-row select {
      min-width: 0;
    }

    .module-typology-variations {
      padding: 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .module-typology-variations .inline {
      gap: 8px;
    }

    .module-typology-row button {
      padding: 8px 12px;
    }

    .module-animation-row {
      display: none;
      align-items: center;
      gap: 8px;
    }

    .module-typology-row small {
      color: var(--muted);
    }

    .module-collapsed .module-body {
      display: none;
    }

    .module-collapsed .module-collapse {
      background: rgba(59, 130, 246, 0.12);
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 13.5px 12px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.5);
      border: none;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .checkbox input {
      flex: 0 0 auto;
    }

    .checkbox:hover {
      background: rgba(255, 255, 255, 0.85);
    }

    .sidebar {
      position: sticky;
      top: 24px;
      height: fit-content;
      flex: 0 0 360px;
    }

    .summary {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-currency {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .total {
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-align: right;
    }

    .total strong {
      font-size: 2.3rem;
    }

    .summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      max-width: 100%;
    }

    .summary-item.sub {
      color: var(--muted);
      font-size: 0.82rem;
      padding-left: 10px;
    }

    .summary-item.total {
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      font-weight: 800;
    }

    .summary-item span {
      min-width: 0;
      overflow-wrap: anywhere;
    }

    .summary-item .price-label {
      white-space: nowrap;
    }

    .summary-toggle {
      border: none;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
    }

    .summary-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .summary-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .deliverables {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .deliverables-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .deliverables-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .deliverables h3 {
      margin: 0;
      font-size: 1rem;
    }

    .deliverables-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 0.9rem;
    }

    .deliverables-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
    }

    .deliverables-section h4 {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .deliverables-section ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
    }

    .deliverables-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .deliverables-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .deliverables-badge--warn {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
    }

    .deliverables-note {
      display: block;
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .deliverables-empty {
      margin: 0;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.45);
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
    }

    .deliverables-toggle {
      border: none;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.78rem;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
      display: none;
    }

    .deliverables-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.12);
      color: var(--success);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      font-size: 0.85rem;
      display: none;
    }

    .drawer {
      display: none;
    }

    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 20px;
    }

    .settings-panel {
      width: min(980px, 95vw);
      max-height: 85vh;
      overflow: auto;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px) saturate(170%);
    }

    .billing-panel {
      width: min(1100px, 96vw);
    }

    .billing-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(280px, 1fr);
      gap: 20px;
      align-items: start;
    }

    .billing-section {
      padding: 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .billing-section h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .billing-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .billing-preview {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 18px;
      padding: 20px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
    }

    .invoice {
      font-family: "Segoe UI", "Inter", sans-serif;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 18px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(15, 23, 42, 0.12);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(16px) saturate(140%);
    }

    .invoice-hero {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding: 12px 14px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.55);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .invoice-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 220px;
    }

    .invoice-logo {
      width: 48px;
      height: 48px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.85);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #1d4ed8;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12);
    }

    .invoice-brand span {
      display: block;
      font-size: 0.75rem;
      color: #475569;
    }

    .invoice-brand strong {
      font-size: 1.05rem;
      display: block;
    }

    .invoice-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .invoice-status {
      padding: 6px 12px;
      border-radius: 0;
      background: rgba(16, 185, 129, 0.16);
      color: #0f766e;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .invoice-status.is-draft {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .invoice-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      width: min(360px, 100%);
    }

    .invoice-meta-item {
      padding: 8px 10px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(15, 23, 42, 0.1);
      font-size: 0.82rem;
    }

    .invoice-meta-item strong {
      display: block;
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .invoice-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .invoice-card {
      padding: 10px 12px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .invoice-card h4 {
      margin: 0 0 6px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .invoice-total-card {
      padding: 12px;
      border-radius: 0;
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      text-align: right;
    }

    .invoice-total-card span {
      font-size: 0.8rem;
      color: #1d4ed8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .invoice-total-amount {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .invoice-block {
      flex: 1 1 220px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .invoice-block h4 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .invoice-table th,
    .invoice-table td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      text-align: left;
    }

    .invoice-table th {
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #334155;
    }

    .invoice-table td:last-child,
    .invoice-table th:last-child {
      text-align: right;
    }

    .invoice-total {
      font-weight: 700;
      font-size: 1rem;
    }

    .invoice-total td {
      border-top: 1px solid rgba(15, 23, 42, 0.2);
    }

    .invoice-footer {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .invoice-note {
      font-size: 0.85rem;
      color: var(--muted);
      white-space: pre-wrap;
    }

    .custom-field-row {
      display: grid;
      grid-template-columns: minmax(120px, 1fr) minmax(120px, 1fr) auto;
      gap: 10px;
      align-items: center;
    }

    .custom-field-row button {
      padding: 10px 12px;
    }

    @media (max-width: 980px) {
      .billing-layout {
        grid-template-columns: 1fr;
      }
    }

    .settings-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .settings-grid > div {
      flex: 1 1 220px;
      min-width: 220px;
    }

    .section-divider {
      margin-top: 8px;
      border-top: none;
      padding-top: 16px;
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .inline input,
    .inline select,
    .inline textarea {
      width: auto;
      flex: 1 1 120px;
      min-width: 0;
    }

    .inline .helper {
      white-space: nowrap;
    }

    .tag {
      background: rgba(99, 102, 241, 0.12);
      color: #4338ca;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
    }

    .tag.is-capped {
      background: rgba(248, 113, 113, 0.16);
      color: #b91c1c;
    }

    @media print {
      body { padding: 0; background: #fff !important; }
      .settings-overlay { position: static; inset: auto; background: none; }
      .billing-panel { box-shadow: none; }
      .invoice { box-shadow: none; border: none; }
      button, .billing-actions { display: none !important; }
    }


    @media (max-width: 980px) {
      .content {
        flex-direction: column;
        padding-bottom: 160px;
      }

      .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        padding: 16px;
        z-index: 20;
      }

      .summary {
        border-radius: 22px 22px 0 0;
        background: var(--glass-strong);
      }

      .drawer {
        display: block;
        margin-bottom: 6px;
      }

      .deliverables-toggle {
        display: inline-flex;
      }

      .module-typology-row {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Calculateur de devis modulable</h1>
        <p class="subtle">Modules multi-services · Masterplan · Rendus & livrables</p>
      </div>
      <div class="inline">
        <button class="btn" id="open-settings" type="button">⚙ Paramètres</button>
      </div>
    </header>

    <div class="content">
      <main style="display: flex; flex-direction: column; gap: 24px;">
        <section class="glass panel" aria-label="Identité">
          <h2>Projet</h2>
          <div class="grid">
            <div>
              <label for="client-name">Nom client / Projet</label>
              <input id="client-name" type="text" placeholder="Villa Oceanis" autocomplete="off" />
            </div>
          </div>
        </section>

      <section class="glass panel" aria-label="Modules">
        <div class="inline" style="justify-content: space-between;">
          <div>
            <h2>Modules du projet</h2>
            <p class="helper">Composez un projet multi-services avec des sous-totaux par module.</p>
          </div>
          <div class="inline">
            <label for="preset-select">Préréglage</label>
            <select id="preset-select"></select>
            <button class="btn" id="apply-preset" type="button">Appliquer</button>
            <button class="btn btn-primary" id="add-module" type="button">+ Ajouter un module</button>
          </div>
        </div>
        <p class="helper" id="modules-empty">Ajoutez un module pour démarrer le devis.</p>
        <div id="modules-container" class="module-list"></div>
      </section>

      <template id="module-template">
        <div class="module-card glass">
          <div class="module-header">
            <div class="module-title">
              <span class="tag">Module</span>
              <span class="tag is-capped module-cap-tag" style="display: none;">Plafonné</span>
              <input class="module-name" type="text" placeholder="Nom du module" />
            </div>
            <div class="module-actions">
              <select class="module-type">
                <option value="masterplan">Masterplan du site / Volumétrie 3D</option>
                <option value="exterior">Extérieur</option>
                <option value="interior">Intérieur</option>
                <option value="visual">Visuels / Rendus</option>
              </select>
              <button class="btn module-duplicate" type="button">Dupliquer</button>
              <button class="btn module-collapse" type="button">Réduire</button>
              <button class="btn module-remove" type="button">Supprimer</button>
            </div>
          </div>
          <div class="module-body">
            <div class="grid">
              <div>
                <label>Pack</label>
                <select class="module-pack">
                  <option value="concept">Concept</option>
                  <option value="standard">Standard</option>
                  <option value="premium">Premium</option>
                </select>
              </div>
              <div>
                <label>Résolution</label>
                <select class="module-resolution">
                  <option value="HD">HD</option>
                  <option value="2K">2K</option>
                  <option value="4K">4K</option>
                </select>
              </div>
              <div>
                <label>Complexité</label>
                <select class="module-complexity">
                  <option value="simple">Simple</option>
                  <option value="standard">Standard</option>
                  <option value="complex">Complexe</option>
                </select>
              </div>
              <div>
                <label>Détails</label>
                <select class="module-details">
                  <option value="concept">Concept</option>
                  <option value="realistic">Réaliste</option>
                  <option value="photoreal">Photoréaliste</option>
                </select>
              </div>
              <div>
                <label>Usage</label>
                <select class="module-usage">
                  <option value="personal">Personnel</option>
                  <option value="commercial">Commercial</option>
                  <option value="ads">Publicité</option>
                </select>
              </div>
              <div>
                <label>Délais</label>
                <select class="module-delay">
                  <option value="standard">Standard</option>
                  <option value="express">Express</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>

            <div class="module-section module-masterplan" data-section="masterplan">
              <h4>Site masterplan (générique)</h4>
              <div class="grid">
                <div>
                  <label>Surface de site</label>
                  <div class="inline">
                    <input class="module-site-area" type="number" min="0" value="0" />
                    <select class="module-site-unit">
                      <option value="m2">m²</option>
                      <option value="ha">hectares</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label>Topographie</label>
                  <select class="module-topography">
                    <option value="flat">Plate</option>
                    <option value="mild">Modérée</option>
                    <option value="complex">Complexe</option>
                  </select>
                </div>
                <div>
                  <label>Circulation</label>
                  <select class="module-circulation">
                    <option value="simple">Simple</option>
                    <option value="standard">Standard</option>
                    <option value="complex">Complexe</option>
                  </select>
                </div>
                <div>
                  <label>Densité paysagère</label>
                  <select class="module-landscape-density">
                    <option value="low">Faible</option>
                    <option value="medium">Moyenne</option>
                    <option value="high">Élevée</option>
                  </select>
                </div>
              </div>
              <div class="grid">
                <div>
                  <label>Structures principales</label>
                  <input class="module-primary-structures" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Structures secondaires</label>
                  <input class="module-secondary-structures" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Aménagements extérieurs</label>
                  <input class="module-outdoor-features" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Zones parking</label>
                  <input class="module-parking-zones" type="number" min="0" value="0" />
                </div>
              </div>
            </div>

            <div class="module-section module-volumes" data-section="volumes">
              <h4>Volumes (S/M/L)</h4>
              <div class="grid">
                <div>
                  <label>Petit</label>
                  <input class="module-volume-small" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Moyen</label>
                  <input class="module-volume-medium" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Grand</label>
                  <input class="module-volume-large" type="number" min="0" value="0" />
                </div>
                <div class="module-m2-toggle">
                  <label class="checkbox">
                    <input class="module-use-m2" type="checkbox" />
                    Tarification au m²
                  </label>
                </div>
                <div class="module-m2-field">
                  <label>Surface (m²)</label>
                  <input class="module-m2-value" type="number" min="0" value="0" />
                </div>
              </div>
            </div>

            <div class="module-section module-scenes" data-section="scenes">
              <h4>Scènes 3D (S/M/L)</h4>
              <div class="grid">
                <div>
                  <label>Petit</label>
                  <input class="module-scene-small" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Moyen</label>
                  <input class="module-scene-medium" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Grand</label>
                  <input class="module-scene-large" type="number" min="0" value="0" />
                </div>
              </div>
            </div>

            <div class="module-section module-renders" data-section="renders">
              <h4>Rendus finaux</h4>
              <div class="grid">
                <div>
                  <label>Vue aérienne</label>
                  <input class="module-render-aerial" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Extérieur</label>
                  <input class="module-render-exterior" type="number" min="0" value="0" />
                </div>
                <div>
                  <label>Intérieur</label>
                  <input class="module-render-interior" type="number" min="0" value="0" />
                </div>
              </div>
            </div>

            <div class="module-section module-typologies" data-section="typologies">
              <div class="inline" style="justify-content: space-between;">
                <div>
                  <h4>Typologies d'assets</h4>
                  <p class="helper">Décrivez les familles d'assets, même avec des intitulés longs.</p>
                </div>
                <label class="checkbox">
                  <input class="module-typologies-toggle" type="checkbox" />
                  Activer les typologies
                </label>
              </div>
              <div class="module-typology-list"></div>
              <button class="btn module-add-typology" type="button">+ Ajouter une typologie</button>
            </div>

            <div class="module-section module-options" data-section="options">
              <h4>Options</h4>
              <div class="options">
                <label class="checkbox"><input type="checkbox" class="module-opt-moodboard" /> Moodboard</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-plan" /> Plan 2D</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-shopping" /> Liste shopping</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-modeling" /> Modélisation sur mesure</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-furniture" /> Mobilier / déco</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-landscape" /> Paysage / végétation</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-sources" /> Fichiers sources</label>
                <label class="checkbox"><input type="checkbox" class="module-opt-animation" /> Animation</label>
              </div>
              <div class="inline module-animation-row">
                <input class="module-animation-seconds" type="number" min="0" max="120" value="0" />
                <span class="helper">secondes (0-120)</span>
              </div>
            </div>

            <div class="module-section module-revisions" data-section="revisions">
              <h4>Retours & logistique</h4>
              <div class="grid">
                <div>
                  <label>Cycles demandés</label>
                  <input class="module-cycles" type="number" min="1" value="2" />
                </div>
              </div>
              <span class="helper">Cycles inclus : <strong class="module-cycles-included">2</strong></span>
            </div>

            <div class="module-section module-deliverables" data-section="deliverables">
              <h4>Livrables du module</h4>
              <div class="module-deliverables-body"></div>
            </div>

            <div class="module-summary">
              <div class="summary-item"><span>Sous-total module</span><span class="module-subtotal price-label">0 Ar</span></div>
            </div>
          </div>
        </div>
      </template>

      <section class="glass panel" aria-label="Export">
        <h2>Export devis</h2>
        <div class="inline">
          <button class="btn btn-primary" id="export-snapshot" type="button">Exporter le devis</button>
          <label class="btn" style="cursor:pointer;">
            Importer un devis
            <input type="file" id="import-snapshot" accept="application/json" style="display:none;" />
          </label>
          <button class="btn" id="open-billing" type="button">Générer une facture</button>
        </div>
      </section>
      </main>

      <aside class="sidebar">
        <div class="glass summary">
          <div class="drawer">
            <span class="tag">Récapitulatif</span>
          </div>
          <div class="total">
            <span class="subtle" id="total-label">Total HT</span>
            <strong id="total-main">0 Ar</strong>
            <span class="helper" id="total-alt">≈ 0 €</span>
          </div>
          <div class="sidebar-currency">
            <label for="currency">Devise d'affichage</label>
            <div class="toggle-group" role="tablist" aria-label="Devise">
              <button class="toggle-btn active" id="currency-mga" role="tab" aria-selected="true">MGA</button>
              <button class="toggle-btn" id="currency-eur" role="tab" aria-selected="false">EUR</button>
            </div>
          </div>
          <div class="alert" id="empty-warning">Ajoutez au moins 1 volume, 1 rendu ou 1 typologie.</div>
          <div class="alert" id="calc-warning" style="display:none;"></div>
          <div class="pill" id="minimum-pill" style="display:none;">Minimum appliqué</div>
          <div class="summary-list" id="summary-modules"></div>
          <button class="summary-toggle" id="summary-toggle" type="button">Afficher le détail</button>
          <div class="summary-details" id="summary-details"></div>
          <div class="deliverables" id="deliverables">
            <div class="deliverables-header">
              <h3>Résumé des livrables</h3>
              <div class="deliverables-header-actions">
                <div class="deliverables-badges" id="deliverables-badges"></div>
                <button class="deliverables-toggle" id="deliverables-toggle" type="button" aria-expanded="true">
                  Masquer les livrables
                </button>
              </div>
            </div>
            <div class="deliverables-body" id="deliverables-body"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="settings-overlay" id="settings-overlay" aria-modal="true" role="dialog">
    <div class="settings-panel">
      <div class="inline" style="justify-content: space-between;">
        <h2>Paramètres</h2>
        <div class="inline">
          <button class="btn" id="export-config" type="button">Exporter JSON</button>
          <label class="btn" style="cursor:pointer;">
            Importer JSON
            <input type="file" id="import-config" accept="application/json" style="display:none;" />
          </label>
          <button class="btn" id="reset-config" type="button">Réinitialiser</button>
          <button class="btn btn-primary" id="save-config" type="button">Sauvegarder</button>
        </div>
      </div>
      <div id="settings-form" class="section-divider"></div>
    </div>
  </div>

  <div class="settings-overlay" id="billing-overlay" aria-modal="true" role="dialog">
    <div class="settings-panel billing-panel">
      <div class="inline" style="justify-content: space-between;">
        <div>
          <h2>Informations de facturation</h2>
          <p class="helper">Les données sont stockées localement sur ce navigateur.</p>
        </div>
        <div class="billing-actions">
          <button class="btn" id="copy-invoice" type="button">Copier facture</button>
          <button class="btn" id="download-invoice" type="button">Télécharger .html</button>
          <button class="btn btn-primary" id="print-invoice" type="button">Imprimer / PDF</button>
        </div>
      </div>
      <div class="billing-layout section-divider">
        <div class="billing-section">
          <h3>Émetteur (entreprise)</h3>
          <div class="grid">
            <div>
              <label for="company-name">Nom / Société</label>
              <input id="company-name" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-address">Adresse</label>
              <input id="company-address" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-country">Pays</label>
              <input id="company-country" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-postal">Code postal</label>
              <input id="company-postal" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-phone">Numéro / téléphone</label>
              <input id="company-phone" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-nif">NIF/STAT</label>
              <input id="company-nif" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-email">Email (optionnel)</label>
              <input id="company-email" type="email" autocomplete="off" />
            </div>
          </div>
        </div>
        <div class="billing-section">
          <h3>Client</h3>
          <div class="grid">
            <div>
              <label for="client-billing-name">Nom</label>
              <input id="client-billing-name" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-address">Adresse</label>
              <input id="client-billing-address" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-country">Pays</label>
              <input id="client-billing-country" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-postal">Code postal</label>
              <input id="client-billing-postal" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-phone">Téléphone</label>
              <input id="client-billing-phone" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-nif">NIF/STAT</label>
              <input id="client-billing-nif" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-email">Email (optionnel)</label>
              <input id="client-billing-email" type="email" autocomplete="off" />
            </div>
          </div>
        </div>
        <div class="billing-section">
          <h3>Facture</h3>
          <div class="grid">
            <div>
              <label for="invoice-number">Numéro</label>
              <input id="invoice-number" type="text" placeholder="FAC-YYYYMMDD-XXX" autocomplete="off" />
            </div>
            <div>
              <label for="invoice-date">Date</label>
              <input id="invoice-date" type="date" />
            </div>
            <div>
              <label for="invoice-due-date">Échéance (optionnel)</label>
              <input id="invoice-due-date" type="date" />
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" id="invoice-show-details" />
            Afficher détail (Base/Production/Options/Retours/TVA)
          </label>
          <div>
            <label for="invoice-notes">Notes / conditions</label>
            <textarea id="invoice-notes" rows="4" placeholder="Conditions de paiement, modalités..."></textarea>
          </div>
        </div>
        <div class="billing-section">
          <h3>Champs personnalisés</h3>
          <div id="custom-fields"></div>
          <button class="btn" id="add-custom-field" type="button">+ Ajouter un champ</button>
        </div>
        <div class="billing-preview">
          <div class="inline" style="justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Aperçu facture</h3>
            <span class="tag" id="invoice-status">Brouillon</span>
          </div>
          <div id="invoice-preview" class="section-divider"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const CONFIG_DEFAULT = {
      version: 2,
      base: { visual: 250000, interior: 300000, exterior: 350000 },
      packs: {
        interior: {
          concept: { small: 250000, medium: 420000, large: 650000 },
          standard: { small: 380000, medium: 650000, large: 980000 },
          premium: { small: 520000, medium: 920000, large: 1400000 }
        },
        exterior: {
          concept: { small: 320000, medium: 560000, large: 900000 },
          standard: { small: 480000, medium: 850000, large: 1350000 },
          premium: { small: 650000, medium: 1200000, large: 1900000 }
        }
      },
      scenes: { small: 220000, medium: 420000, large: 850000 },
      render_tiers: {
        aerial: [
          { upTo: 2, unit: 220000 },
          { upTo: 6, unit: 180000 },
          { upTo: 12, unit: 150000 },
          { upTo: Infinity, unit: 120000 }
        ],
        exterior: [
          { upTo: 2, unit: 300000 },
          { upTo: 6, unit: 240000 },
          { upTo: 12, unit: 200000 },
          { upTo: Infinity, unit: 160000 }
        ],
        interior: [
          { upTo: 2, unit: 260000 },
          { upTo: 6, unit: 210000 },
          { upTo: 12, unit: 170000 },
          { upTo: Infinity, unit: 140000 }
        ]
      },
      resolution_pricing: {
        mode: "uplift",
        uplifts_default: { HD: 0, "2K": 30000, "4K": 70000 },
        uplifts_by_category: {
          aerial: { HD: 0, "2K": 30000, "4K": 70000 },
          exterior: { HD: 0, "2K": 35000, "4K": 80000 },
          interior: { HD: 0, "2K": 30000, "4K": 70000 }
        },
        per_resolution_units: {
          aerial: {
            HD: [220000, 180000, 150000, 120000],
            "2K": [260000, 210000, 175000, 140000],
            "4K": [320000, 260000, 210000, 170000]
          },
          exterior: {
            HD: [300000, 240000, 200000, 160000],
            "2K": [340000, 275000, 230000, 185000],
            "4K": [420000, 340000, 280000, 220000]
          },
          interior: {
            HD: [260000, 210000, 170000, 140000],
            "2K": [300000, 240000, 200000, 160000],
            "4K": [360000, 290000, 240000, 190000]
          }
        }
      },
      multipliers: {
        complexity: { simple: 1.0, standard: 1.2, complex: 1.5 },
        details: { concept: 1.0, realistic: 1.25, photoreal: 1.6 },
        delay: { standard: 1.0, express: 1.2, urgent: 1.35 },
        usage: { personal: 1.0, commercial: 1.15, ads: 1.3 },
        topography: { flat: 1.0, mild: 1.15, complex: 1.35 },
        circulation: { simple: 1.0, standard: 1.15, complex: 1.3 },
        landscape: { low: 1.0, medium: 1.1, high: 1.25 }
      },
      masterplan: {
        base_fee: 380000,
        area_tiers: [
          { upTo: 10000, unit: 1200 },
          { upTo: 30000, unit: 900 },
          { upTo: Infinity, unit: 700 }
        ],
        area_tiers_ha: [
          { upTo: 30, unit: 100000 },
          { upTo: 80, unit: 60000 },
          { upTo: 200, unit: 30000 },
          { upTo: Infinity, unit: 20000 }
        ],
        unit_costs: {
          primary_structures: 180000,
          secondary_structures: 120000,
          outdoor_features: 90000,
          parking_zones: 60000
        }
      },
      typologies: {
        categories: ["Bâtiment", "Unité", "Pavillon", "Élément paysager", "Ensemble mobilier"],
        complexity_costs: { simple: 180000, standard: 260000, complex: 380000 },
        duplication_mode: "fixed",
        duplication_fee: { simple: 60000, standard: 80000, complex: 120000 },
        duplication_tiers: [
          { upTo: 5, unit: 60000 },
          { upTo: 12, unit: 45000 },
          { upTo: Infinity, unit: 35000 }
        ],
        variation_mode: "percent",
        variation_value: 12,
        variation_scope: "per_instance"
      },
      options: {
        moodboard: 120000,
        plan2d: 220000,
        shopping: 150000,
        modeling_pct: 0.2,
        furniture_pct: 0.15,
        landscape_pct: 0.18,
        sources_pct: 0.2,
        animation_sec: 40000
      },
      revisions: { included: 2, rate: 0.1 },
      minimum: 350000,
      vat_enabled: false,
      vat_rate: 0,
      eur_mga_rate: 4800,
      toggles: { enable_tiered_m2: true },
      tiered_m2: [
        { upTo: 30, unit: 18000 },
        { upTo: 80, unit: 14000 },
        { upTo: Infinity, unit: 11000 }
      ],
      presets: [
        {
          name: "Masterplan du site",
          modules: [
            {
              type: "masterplan",
              name: "Masterplan du site",
              resolution: "2K",
              renders: { aerial: 3, exterior: 1, interior: 0 },
              masterplan: {
                area: 20000,
                areaUnit: "m2",
                primary_structures: 6,
                secondary_structures: 4,
                outdoor_features: 5,
                parking_zones: 2
              },
              typologiesEnabled: true,
              typologies: [
                {
                  id: "preset-typology-1",
                  name: "Typologie A",
                  category: "Bâtiment",
                  complexity: "standard",
                  instances: 8,
                  variationsEnabled: false,
                  variationMode: "percent",
                  variationValue: 12,
                  variationScope: "per_instance"
                }
              ]
            }
          ]
        },
        {
          name: "Pack visuels marketing",
          modules: [
            {
              type: "visual",
              name: "Pack visuels",
              pack: "premium",
              resolution: "4K",
              multipliers: { details: "photoreal" },
              renders: { aerial: 2, exterior: 4, interior: 2 },
              scenes: { small: 1, medium: 2, large: 0 }
            }
          ]
        },
        {
          name: "Pack site complet",
          modules: [
            {
              type: "masterplan",
              name: "Masterplan du site",
              pack: "premium",
              resolution: "4K",
              multipliers: { details: "photoreal" },
              renders: { aerial: 3, exterior: 2, interior: 0 },
              masterplan: {
                area: 35000,
                areaUnit: "m2",
                primary_structures: 8,
                secondary_structures: 5,
                outdoor_features: 6,
                parking_zones: 3
              },
              typologiesEnabled: true,
              typologies: [
                {
                  id: "preset-typology-2",
                  name: "Typologie A",
                  category: "Bâtiment",
                  complexity: "standard",
                  instances: 12,
                  variationsEnabled: true,
                  variationMode: "percent",
                  variationValue: 10,
                  variationScope: "per_instance"
                }
              ]
            },
            {
              type: "exterior",
              name: "Extérieur",
              pack: "premium",
              resolution: "4K",
              multipliers: { details: "photoreal" },
              renders: { aerial: 2, exterior: 4, interior: 0 },
              volumes: { small: 1, medium: 2, large: 1 }
            },
            {
              type: "interior",
              name: "Intérieur",
              pack: "premium",
              resolution: "4K",
              multipliers: { details: "photoreal" },
              renders: { aerial: 0, exterior: 0, interior: 4 },
              volumes: { small: 2, medium: 2, large: 1 }
            }
          ]
        }
      ]
    };

    const DELIVERABLES = {
      masterplan: [
        "Zonage & découpage du site",
        "Massing volumétrique",
        "Schéma de circulation & accès",
        "Organisation paysagère générale"
      ],
      interior: {
        concept: [
          "Concept board d'ambiance",
          "Agencement initial par zone",
          "Rendus d'intention"
        ],
        standard: [
          "Direction artistique détaillée",
          "Plans d'implantation optimisés",
          "Rendus réalistes"
        ],
        premium: [
          "DA complète + variantes",
          "Rendus photoréalistes premium",
          "Synthèse matériaux et mobilier"
        ]
      },
      exterior: {
        concept: [
          "Palette extérieure & moodboard",
          "Zoning paysager général",
          "Rendus d'intention"
        ],
        standard: [
          "DA extérieure structurée",
          "Implantation détaillée des volumes",
          "Rendus réalistes"
        ],
        premium: [
          "Direction artistique premium",
          "Rendus photoréalistes jour/nuit",
          "Synthèse matériaux & paysage"
        ]
      },
      visual: {
        concept: [
          "Storyboard visuel d'intention",
          "Angles de vue clés",
          "Rendus HD prêts à partager"
        ],
        standard: [
          "Angles de vue optimisés",
          "Rendus 2K haute définition",
          "Formats web & présentation"
        ],
        premium: [
          "Mise en scène premium",
          "Rendus 4K photoréalistes",
          "Formats print & web"
        ]
      }
    };

    const UI_DEFAULT = {
      currency: "MGA",
      deliverablesExpanded: true,
      summaryExpanded: false,
      modules: [],
      clientName: ""
    };

    const BILLING_DEFAULT = {
      issuer: {
        company_name: "",
        company_address: "",
        company_country: "",
        company_postal: "",
        company_phone: "",
        company_nif: "",
        company_email: ""
      },
      client: {
        client_name: "",
        client_address: "",
        client_country: "",
        client_postal: "",
        client_phone: "",
        client_nif: "",
        client_email: ""
      },
      invoice: {
        invoice_number: "",
        invoice_date: "",
        due_date: "",
        notes: "",
        show_details: true
      },
      customFields: []
    };

    const LIMITS = {
      renders: { min: 0, max: 200 },
      volumes: { min: 0, max: 200 },
      scenes: { min: 0, max: 200 },
      animationSeconds: { min: 0, max: 120 },
      masterplanAreaM2: { min: 0, max: 5000000 },
      masterplanAreaHa: { min: 0, max: 500 },
      masterplanStructures: { min: 0, max: 200 },
      m2Value: { min: 0, max: 5000 },
      typologyInstances: { min: 0, max: 300 },
      typologyVariationPercent: { min: 0, max: 100 }
    };

    const MAX_MODULE_TOTAL_MGA = 120000000;
    const MAX_PROJECT_TOTAL_MGA = 250000000;
    const MAX_TYPOLOGY_VARIATION_FIXED = 5000000;

    const calcWarningState = {
      adjusted: false,
      capped: false
    };
    let pendingAdjustment = false;

    function generateId() {
      if (window.crypto?.randomUUID) return window.crypto.randomUUID();
      return `m_${Math.random().toString(36).slice(2, 10)}`;
    }

    const clone = obj => {
      if (window.structuredClone) return structuredClone(obj);
      return JSON.parse(JSON.stringify(obj));
    };

    let CONFIG = loadConfig();
    let UI_STATE = loadUIState();
    let BILLING = loadBilling();
    let moduleElements = new Map();
    let debouncedCalculateAndRender;

    const elements = {
      clientName: document.getElementById("client-name"),
      presetSelect: document.getElementById("preset-select"),
      applyPreset: document.getElementById("apply-preset"),
      addModule: document.getElementById("add-module"),
      modulesContainer: document.getElementById("modules-container"),
      modulesEmpty: document.getElementById("modules-empty"),
      moduleTemplate: document.getElementById("module-template"),
      currencyMga: document.getElementById("currency-mga"),
      currencyEur: document.getElementById("currency-eur"),
      summaryModules: document.getElementById("summary-modules"),
      summaryToggle: document.getElementById("summary-toggle"),
      summaryDetails: document.getElementById("summary-details"),
      deliverables: document.getElementById("deliverables"),
      deliverablesBody: document.getElementById("deliverables-body"),
      deliverablesToggle: document.getElementById("deliverables-toggle"),
      deliverablesBadges: document.getElementById("deliverables-badges"),
      totalMain: document.getElementById("total-main"),
      totalAlt: document.getElementById("total-alt"),
      totalLabel: document.getElementById("total-label"),
      minimumPill: document.getElementById("minimum-pill"),
      emptyWarning: document.getElementById("empty-warning"),
      calcWarning: document.getElementById("calc-warning"),
      openSettings: document.getElementById("open-settings"),
      settingsOverlay: document.getElementById("settings-overlay"),
      settingsForm: document.getElementById("settings-form"),
      saveConfig: document.getElementById("save-config"),
      resetConfig: document.getElementById("reset-config"),
      exportConfig: document.getElementById("export-config"),
      importConfig: document.getElementById("import-config"),
      exportSnapshot: document.getElementById("export-snapshot"),
      importSnapshot: document.getElementById("import-snapshot"),
      openBilling: document.getElementById("open-billing"),
      billingOverlay: document.getElementById("billing-overlay"),
      copyInvoice: document.getElementById("copy-invoice"),
      downloadInvoice: document.getElementById("download-invoice"),
      printInvoice: document.getElementById("print-invoice"),
      companyName: document.getElementById("company-name"),
      companyAddress: document.getElementById("company-address"),
      companyCountry: document.getElementById("company-country"),
      companyPostal: document.getElementById("company-postal"),
      companyPhone: document.getElementById("company-phone"),
      companyNif: document.getElementById("company-nif"),
      companyEmail: document.getElementById("company-email"),
      clientBillingName: document.getElementById("client-billing-name"),
      clientBillingAddress: document.getElementById("client-billing-address"),
      clientBillingCountry: document.getElementById("client-billing-country"),
      clientBillingPostal: document.getElementById("client-billing-postal"),
      clientBillingPhone: document.getElementById("client-billing-phone"),
      clientBillingNif: document.getElementById("client-billing-nif"),
      clientBillingEmail: document.getElementById("client-billing-email"),
      invoiceNumber: document.getElementById("invoice-number"),
      invoiceDate: document.getElementById("invoice-date"),
      invoiceDueDate: document.getElementById("invoice-due-date"),
      invoiceNotes: document.getElementById("invoice-notes"),
      invoiceShowDetails: document.getElementById("invoice-show-details"),
      customFields: document.getElementById("custom-fields"),
      addCustomField: document.getElementById("add-custom-field"),
      invoicePreview: document.getElementById("invoice-preview"),
      invoiceStatus: document.getElementById("invoice-status")
    };

    const MODULE_LABELS = {
      masterplan: "Masterplan du site / Volumétrie 3D",
      exterior: "Extérieur",
      interior: "Intérieur",
      visual: "Visuels / Rendus"
    };

    const RENDER_LABELS = {
      aerial: "Aérien",
      exterior: "Extérieur",
      interior: "Intérieur"
    };

    function deepMerge(target, source) {
      if (typeof target !== "object" || target === null) return source;
      const output = Array.isArray(target) ? [...target] : { ...target };
      if (typeof source !== "object" || source === null) return output;
      Object.keys(source).forEach(key => {
        if (Array.isArray(source[key])) {
          output[key] = source[key].map(item => (typeof item === "object" ? { ...item } : item));
        } else if (typeof source[key] === "object" && source[key] !== null) {
          output[key] = deepMerge(output[key], source[key]);
        } else {
          output[key] = source[key];
        }
      });
      return output;
    }

    function ensureConfigDefaults(config) {
      return deepMerge(clone(CONFIG_DEFAULT), config || {});
    }

    function migrateConfig(config) {
      if (!config) return clone(CONFIG_DEFAULT);
      if (config.version === 2) return ensureConfigDefaults(config);
      const migrated = {
        version: 2,
        base: { ...CONFIG_DEFAULT.base, ...(config.base || {}) },
        packs: config.packs || CONFIG_DEFAULT.packs,
        scenes: config.scenes || CONFIG_DEFAULT.scenes,
        render_tiers: {
          aerial: config.render_tiers?.aerial || CONFIG_DEFAULT.render_tiers.aerial,
          exterior: config.render_tiers?.exterior || CONFIG_DEFAULT.render_tiers.exterior,
          interior: config.render_tiers?.interior || CONFIG_DEFAULT.render_tiers.interior
        },
        resolution_pricing: clone(CONFIG_DEFAULT.resolution_pricing),
        multipliers: deepMerge(CONFIG_DEFAULT.multipliers, config.multipliers || {}),
        masterplan: clone(CONFIG_DEFAULT.masterplan),
        typologies: clone(CONFIG_DEFAULT.typologies),
        options: deepMerge(CONFIG_DEFAULT.options, config.options || {}),
        revisions: config.revisions || CONFIG_DEFAULT.revisions,
        minimum: config.minimum ?? CONFIG_DEFAULT.minimum,
        vat_enabled: config.vat_enabled ?? CONFIG_DEFAULT.vat_enabled,
        vat_rate: config.vat_rate ?? CONFIG_DEFAULT.vat_rate,
        eur_mga_rate: config.eur_mga_rate ?? CONFIG_DEFAULT.eur_mga_rate,
        toggles: { ...CONFIG_DEFAULT.toggles, ...(config.toggles || {}) },
        tiered_m2: config.tiered_m2 || CONFIG_DEFAULT.tiered_m2,
        presets: clone(CONFIG_DEFAULT.presets)
      };
      return ensureConfigDefaults(migrated);
    }

    function loadConfig() {
      const stored = localStorage.getItem("tk_quote_calc_config_v1");
      if (!stored) return clone(CONFIG_DEFAULT);
      try {
        const parsed = JSON.parse(stored);
        return migrateConfig(parsed);
      } catch (error) {
        showToast("Configuration locale invalide. Valeurs par défaut appliquées.");
        return clone(CONFIG_DEFAULT);
      }
    }

    function saveConfig() {
      localStorage.setItem("tk_quote_calc_config_v1", JSON.stringify(CONFIG));
    }

    function resetConfig() {
      CONFIG = clone(CONFIG_DEFAULT);
      saveConfig();
      buildSettingsForm();
      buildPresetSelect();
      calculateAndRender();
    }

    function loadUIState() {
      const stored = localStorage.getItem("tk_quote_calc_ui_v1");
      if (!stored) {
        const fallback = { ...UI_DEFAULT };
        fallback.modules = [createModule("masterplan")];
        return fallback;
      }
      try {
        const parsed = JSON.parse(stored);
        const merged = { ...UI_DEFAULT, ...migrateLegacyUIState(parsed) };
        return sanitizeState(merged);
      } catch (error) {
        return { ...UI_DEFAULT };
      }
    }

    function saveUIState() {
      localStorage.setItem("tk_quote_calc_ui_v1", JSON.stringify(UI_STATE));
    }

    function loadBilling() {
      const stored = localStorage.getItem("tk_quote_calc_billing_v1");
      if (!stored) return clone(BILLING_DEFAULT);
      try {
        const parsed = JSON.parse(stored);
        return {
          ...clone(BILLING_DEFAULT),
          ...parsed,
          issuer: { ...BILLING_DEFAULT.issuer, ...parsed.issuer },
          client: { ...BILLING_DEFAULT.client, ...parsed.client },
          invoice: { ...BILLING_DEFAULT.invoice, ...parsed.invoice },
          customFields: Array.isArray(parsed.customFields) ? parsed.customFields : []
        };
      } catch (error) {
        return clone(BILLING_DEFAULT);
      }
    }

    function saveBilling() {
      localStorage.setItem("tk_quote_calc_billing_v1", JSON.stringify(BILLING));
    }

    function showToast(message) {
      const alert = document.createElement("div");
      alert.textContent = message;
      alert.style.position = "fixed";
      alert.style.bottom = "24px";
      alert.style.right = "24px";
      alert.style.padding = "12px 16px";
      alert.style.background = "rgba(15, 23, 42, 0.9)";
      alert.style.color = "#fff";
      alert.style.borderRadius = "12px";
      alert.style.zIndex = "40";
      alert.style.fontSize = "0.85rem";
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3200);
    }

    function toNumberSafe(value, fallback = 0) {
      const number = Number(value);
      return Number.isFinite(number) ? number : fallback;
    }

    function clampNumber(value, min, max) {
      const number = toNumberSafe(value, min);
      return Math.min(max, Math.max(min, number));
    }

    function sanitizeInt(value, min, max) {
      const number = Math.round(toNumberSafe(value, min));
      return Math.min(max, Math.max(min, number));
    }

    function markAdjustment() {
      calcWarningState.adjusted = true;
    }

    function markPendingAdjustment() {
      pendingAdjustment = true;
    }

    function markCapped() {
      calcWarningState.capped = true;
    }

    function resetCalcWarnings() {
      calcWarningState.adjusted = false;
      calcWarningState.capped = false;
    }

    function updateCalcWarning() {
      if (!elements.calcWarning) return;
      if (calcWarningState.capped) {
        elements.calcWarning.textContent = "Le total a été plafonné pour rester dans une limite réaliste.";
        elements.calcWarning.style.display = "block";
        return;
      }
      if (calcWarningState.adjusted) {
        elements.calcWarning.textContent = "Certaines valeurs ont été ajustées pour rester dans des limites réalistes.";
        elements.calcWarning.style.display = "block";
        return;
      }
      elements.calcWarning.style.display = "none";
    }

    function ensureFinite(value, label, context) {
      if (Number.isFinite(value)) return value;
      console.warn(`Valeur non finie détectée (${label}).`, context);
      return 0;
    }

    function clamp(n, min, max) {
      return clampNumber(n, min, max);
    }

    function debounce(fn, wait = 60) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), wait);
      };
    }

    function sanitizeIntWithFlag(value, min, max) {
      const before = toNumberSafe(value, min);
      const after = sanitizeInt(value, min, max);
      if (value !== undefined && value !== null && before !== after) {
        markAdjustment();
      }
      return after;
    }

    function sanitizeNumberWithFlag(value, min, max) {
      const before = toNumberSafe(value, min);
      const after = clampNumber(value, min, max);
      if (value !== undefined && value !== null && before !== after) {
        markAdjustment();
      }
      return after;
    }

    function validateTiers(tiers) {
      if (!Array.isArray(tiers) || tiers.length === 0) {
        return { valid: false, tiers: [], lastUnit: 0 };
      }
      let previousLimit = 0;
      let lastUnit = 0;
      const normalized = [];
      for (let i = 0; i < tiers.length; i += 1) {
        const tier = tiers[i] || {};
        const unit = toNumberSafe(tier.unit, NaN);
        if (Number.isFinite(unit)) lastUnit = unit;
        const rawUpTo = tier.upTo;
        const upTo = rawUpTo === Infinity ? Infinity : toNumberSafe(rawUpTo, NaN);
        const isInfinite = upTo === Infinity;
        if (!Number.isFinite(unit) || unit < 0) {
          return { valid: false, tiers: [], lastUnit };
        }
        if (!isInfinite && (!Number.isFinite(upTo) || upTo <= previousLimit)) {
          return { valid: false, tiers: [], lastUnit };
        }
        if (isInfinite && i !== tiers.length - 1) {
          return { valid: false, tiers: [], lastUnit };
        }
        normalized.push({ upTo, unit });
        previousLimit = upTo;
      }
      return { valid: true, tiers: normalized, lastUnit };
    }

    function sanitizeTypologyState(typology) {
      const categories = CONFIG.typologies.categories || [];
      const safeCategory = categories.includes(typology.category) ? typology.category : categories[0];
      if (typology.category && safeCategory !== typology.category) {
        markAdjustment();
      }
      const safeComplexity = ["simple", "standard", "complex"].includes(typology.complexity)
        ? typology.complexity
        : "standard";
      if (typology.complexity && safeComplexity !== typology.complexity) {
        markAdjustment();
      }
      const variationMode = ["percent", "fixed"].includes(typology.variationMode)
        ? typology.variationMode
        : CONFIG.typologies.variation_mode;
      const variationScope = ["per_instance", "per_typology"].includes(typology.variationScope)
        ? typology.variationScope
        : CONFIG.typologies.variation_scope;
      const instances = sanitizeIntWithFlag(typology.instances, LIMITS.typologyInstances.min, LIMITS.typologyInstances.max);
      const variationValue =
        variationMode === "percent"
          ? sanitizeNumberWithFlag(typology.variationValue, LIMITS.typologyVariationPercent.min, LIMITS.typologyVariationPercent.max)
          : sanitizeNumberWithFlag(typology.variationValue, 0, MAX_TYPOLOGY_VARIATION_FIXED);
      return {
        id: typology.id || generateId(),
        name: typology.name || "",
        category: safeCategory || "",
        complexity: safeComplexity,
        instances,
        variationsEnabled: Boolean(typology.variationsEnabled),
        variationMode,
        variationValue,
        variationScope
      };
    }

    function sanitizeModuleState(module) {
      const baseModule = createModule(module?.type || "masterplan", module || {});
      const safeType = MODULE_LABELS[baseModule.type] ? baseModule.type : "masterplan";
      if (safeType !== baseModule.type) {
        markAdjustment();
      }
      baseModule.type = safeType;
      baseModule.name = baseModule.name || MODULE_LABELS[safeType];
      baseModule.renders = {
        aerial: sanitizeIntWithFlag(baseModule.renders?.aerial, LIMITS.renders.min, LIMITS.renders.max),
        exterior: sanitizeIntWithFlag(baseModule.renders?.exterior, LIMITS.renders.min, LIMITS.renders.max),
        interior: sanitizeIntWithFlag(baseModule.renders?.interior, LIMITS.renders.min, LIMITS.renders.max)
      };
      baseModule.volumes = {
        small: sanitizeIntWithFlag(baseModule.volumes?.small, LIMITS.volumes.min, LIMITS.volumes.max),
        medium: sanitizeIntWithFlag(baseModule.volumes?.medium, LIMITS.volumes.min, LIMITS.volumes.max),
        large: sanitizeIntWithFlag(baseModule.volumes?.large, LIMITS.volumes.min, LIMITS.volumes.max)
      };
      baseModule.scenes = {
        small: sanitizeIntWithFlag(baseModule.scenes?.small, LIMITS.scenes.min, LIMITS.scenes.max),
        medium: sanitizeIntWithFlag(baseModule.scenes?.medium, LIMITS.scenes.min, LIMITS.scenes.max),
        large: sanitizeIntWithFlag(baseModule.scenes?.large, LIMITS.scenes.min, LIMITS.scenes.max)
      };
      baseModule.animationSeconds = sanitizeIntWithFlag(
        baseModule.animationSeconds,
        LIMITS.animationSeconds.min,
        LIMITS.animationSeconds.max
      );
      baseModule.m2 = {
        enabled: Boolean(baseModule.m2?.enabled),
        value: sanitizeIntWithFlag(baseModule.m2?.value, LIMITS.m2Value.min, LIMITS.m2Value.max)
      };
      const areaUnit = baseModule.masterplan?.areaUnit === "ha" ? "ha" : "m2";
      if (baseModule.masterplan?.areaUnit && baseModule.masterplan.areaUnit !== areaUnit) {
        markAdjustment();
      }
      baseModule.masterplan = {
        ...baseModule.masterplan,
        areaUnit,
        area:
          areaUnit === "ha"
            ? sanitizeNumberWithFlag(baseModule.masterplan?.area, LIMITS.masterplanAreaHa.min, LIMITS.masterplanAreaHa.max)
            : sanitizeNumberWithFlag(baseModule.masterplan?.area, LIMITS.masterplanAreaM2.min, LIMITS.masterplanAreaM2.max),
        primary_structures: sanitizeIntWithFlag(
          baseModule.masterplan?.primary_structures,
          LIMITS.masterplanStructures.min,
          LIMITS.masterplanStructures.max
        ),
        secondary_structures: sanitizeIntWithFlag(
          baseModule.masterplan?.secondary_structures,
          LIMITS.masterplanStructures.min,
          LIMITS.masterplanStructures.max
        ),
        outdoor_features: sanitizeIntWithFlag(
          baseModule.masterplan?.outdoor_features,
          LIMITS.masterplanStructures.min,
          LIMITS.masterplanStructures.max
        ),
        parking_zones: sanitizeIntWithFlag(
          baseModule.masterplan?.parking_zones,
          LIMITS.masterplanStructures.min,
          LIMITS.masterplanStructures.max
        )
      };
      baseModule.typologiesEnabled = Boolean(baseModule.typologiesEnabled);
      baseModule.typologies = Array.isArray(baseModule.typologies)
        ? baseModule.typologies.map(item => sanitizeTypologyState(item || {}))
        : [];
      const revisionCycles = sanitizeIntWithFlag(baseModule.revisions?.cycles, 1, 999);
      baseModule.revisions = { cycles: revisionCycles };
      return baseModule;
    }

    function sanitizeState(state) {
      const sanitized = { ...state };
      if (Array.isArray(state?.modules)) {
        sanitized.modules = state.modules.map(module => sanitizeModuleState(module));
      } else {
        sanitized.modules = [];
      }
      return sanitized;
    }

    function sanitizeConfigPresets(config) {
      if (!Array.isArray(config?.presets)) {
        return config;
      }
      const sanitizedPresets = config.presets.map(preset => ({
        ...preset,
        name: preset?.name || "Preset",
        modules: Array.isArray(preset?.modules) ? preset.modules.map(module => sanitizeModuleState(module)) : []
      }));
      return { ...config, presets: sanitizedPresets };
    }

    function applyTieredPricing(qty, tiers) {
      const safeQty = Math.max(0, toNumberSafe(qty, 0));
      const { valid, tiers: safeTiers, lastUnit } = validateTiers(tiers);
      if (!valid) {
        return lastUnit ? safeQty * lastUnit : 0;
      }
      let remaining = safeQty;
      let total = 0;
      let previousLimit = 0;
      for (const tier of safeTiers) {
        const tierLimit = tier.upTo === Infinity ? remaining : Math.max(0, tier.upTo - previousLimit);
        const units = Math.min(remaining, tierLimit);
        if (units <= 0) {
          previousLimit = tier.upTo;
          continue;
        }
        total += units * tier.unit;
        remaining -= units;
        previousLimit = tier.upTo;
        if (remaining <= 0) break;
      }
      return total;
    }

    function applyTieredUnits(qty, tiers, units) {
      const safeQty = Math.max(0, toNumberSafe(qty, 0));
      const { valid, tiers: safeTiers } = validateTiers(tiers);
      if (!valid || !Array.isArray(units) || units.length !== safeTiers.length) {
        return applyTieredPricing(safeQty, tiers);
      }
      const safeUnits = units.map(unit => toNumberSafe(unit, NaN));
      if (safeUnits.some(unit => !Number.isFinite(unit))) {
        return applyTieredPricing(safeQty, tiers);
      }
      let remaining = safeQty;
      let total = 0;
      let previousLimit = 0;
      safeTiers.forEach((tier, index) => {
        const tierLimit = tier.upTo === Infinity ? remaining : Math.max(0, tier.upTo - previousLimit);
        const unitsQty = Math.min(remaining, tierLimit);
        if (unitsQty > 0) {
          total += unitsQty * safeUnits[index];
          remaining -= unitsQty;
        }
        previousLimit = tier.upTo;
      });
      return total;
    }

    function formatCurrency(valueMga) {
      const rate = Number(CONFIG.eur_mga_rate) || CONFIG_DEFAULT.eur_mga_rate;
      const safeValue = toNumberSafe(valueMga, 0);
      const displayCurrency = UI_STATE.currency;
      if (displayCurrency === "MGA") {
        return `${Math.round(safeValue).toLocaleString("fr-FR")} Ar`;
      }
      const eur = safeValue / rate;
      return `${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
    }

    function formatAltCurrency(valueMga) {
      const rate = Number(CONFIG.eur_mga_rate) || CONFIG_DEFAULT.eur_mga_rate;
      const safeValue = toNumberSafe(valueMga, 0);
      if (UI_STATE.currency === "MGA") {
        const eur = safeValue / rate;
        return `≈ ${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
      }
      return `≈ ${Math.round(safeValue).toLocaleString("fr-FR")} Ar`;
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getPackResolution(packKey) {
      const map = { concept: "HD", standard: "2K", premium: "4K" };
      return map[packKey] || "2K";
    }

    function setDeliverablesExpanded(expanded) {
      UI_STATE.deliverablesExpanded = expanded;
      elements.deliverablesBody.hidden = !expanded;
      elements.deliverablesToggle.textContent = expanded ? "Masquer les livrables" : "Voir les livrables";
      elements.deliverablesToggle.setAttribute("aria-expanded", String(expanded));
      saveUIState();
    }

    function setSummaryExpanded(expanded) {
      UI_STATE.summaryExpanded = expanded;
      elements.summaryDetails.style.display = expanded ? "flex" : "none";
      elements.summaryToggle.textContent = expanded ? "Masquer le détail" : "Afficher le détail";
      saveUIState();
    }

    function createModule(type = "masterplan", overrides = {}) {
      const defaultModule = {
        id: generateId(),
        type,
        name: MODULE_LABELS[type],
        collapsed: false,
        pack: "standard",
        resolution: "2K",
        multipliers: {
          complexity: "standard",
          details: "realistic",
          usage: "commercial",
          delay: "standard"
        },
        masterplan: {
          area: 0,
          areaUnit: "m2",
          topography: "flat",
          circulation: "standard",
          landscape: "medium",
          primary_structures: 0,
          secondary_structures: 0,
          outdoor_features: 0,
          parking_zones: 0
        },
        volumes: { small: 0, medium: 0, large: 0 },
        scenes: { small: 0, medium: 0, large: 0 },
        renders: { aerial: 0, exterior: 0, interior: 0 },
        m2: { enabled: false, value: 0 },
        typologiesEnabled: type === "masterplan",
        typologies: [],
        options: {
          moodboard: false,
          plan2d: false,
          shopping: false,
          modeling: false,
          furniture: false,
          landscape: false,
          sources: false,
          animation: false
        },
        animationSeconds: 0,
        revisions: { cycles: CONFIG.revisions?.included ?? 2 }
      };
      return deepMerge(defaultModule, overrides);
    }

    function migrateLegacyFormToModule(form) {
      const service = form?.service || "visual";
      const module = createModule(service, {
        pack: form.pack || "standard",
        resolution: form.opt4k ? "4K" : getPackResolution(form.pack || "standard"),
        multipliers: {
          complexity: form.complexity || "standard",
          details: form.details || "realistic",
          usage: form.usage || "commercial",
          delay: form.delay || "standard"
        },
        m2: {
          enabled: Boolean(form.toggleM2),
          value: sanitizeInt(form.m2Value, LIMITS.m2Value.min, LIMITS.m2Value.max)
        },
        revisions: { cycles: sanitizeInt(form.cycles, 1, 999) || CONFIG.revisions.included },
        options: {
          moodboard: Boolean(form.optMoodboard),
          plan2d: Boolean(form.optPlan),
          shopping: Boolean(form.optShopping),
          modeling: Boolean(form.optModeling),
          furniture: Boolean(form.optFurniture),
          landscape: Boolean(form.optLandscape),
          sources: Boolean(form.optSources),
          animation: Boolean(form.optAnimation)
        },
        animationSeconds: sanitizeInt(form.animSeconds, LIMITS.animationSeconds.min, LIMITS.animationSeconds.max)
      });

      if (service === "visual") {
        module.scenes = {
          small: sanitizeInt(form.scenesSmall, LIMITS.scenes.min, LIMITS.scenes.max),
          medium: sanitizeInt(form.scenesMedium, LIMITS.scenes.min, LIMITS.scenes.max),
          large: sanitizeInt(form.scenesLarge, LIMITS.scenes.min, LIMITS.scenes.max)
        };
        module.renders.exterior = sanitizeInt(form.nbVisuels, LIMITS.renders.min, LIMITS.renders.max);
      }
      if (service === "interior") {
        module.volumes = {
          small: sanitizeInt(form.piecesSmall, LIMITS.volumes.min, LIMITS.volumes.max),
          medium: sanitizeInt(form.piecesMedium, LIMITS.volumes.min, LIMITS.volumes.max),
          large: sanitizeInt(form.piecesLarge, LIMITS.volumes.min, LIMITS.volumes.max)
        };
        module.renders.interior = sanitizeInt(form.nbVisuels, LIMITS.renders.min, LIMITS.renders.max);
      }
      if (service === "exterior") {
        module.volumes = {
          small: sanitizeInt(form.zonesSmall, LIMITS.volumes.min, LIMITS.volumes.max),
          medium: sanitizeInt(form.zonesMedium, LIMITS.volumes.min, LIMITS.volumes.max),
          large: sanitizeInt(form.zonesLarge, LIMITS.volumes.min, LIMITS.volumes.max)
        };
        module.renders.exterior = sanitizeInt(form.nbVisuels, LIMITS.renders.min, LIMITS.renders.max);
      }
      return module;
    }

    function migrateLegacyUIState(state) {
      const migrated = { ...state };
      if (!Array.isArray(migrated.modules) || migrated.modules.length === 0) {
        if (migrated.form) {
          migrated.modules = [migrateLegacyFormToModule(migrated.form)];
        } else {
          migrated.modules = [createModule("masterplan")];
        }
      }
      return migrated;
    }

    function applyUIState() {
      elements.clientName.value = UI_STATE.clientName || "";
      if (!Array.isArray(UI_STATE.modules) || UI_STATE.modules.length === 0) {
        UI_STATE.modules = [createModule("masterplan")];
      }
      renderModules();
      buildPresetSelect();
    }

    function getTodayInputValue() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function buildInvoiceNumber() {
      const today = new Date();
      const dateStamp = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(
        today.getDate()
      ).padStart(2, "0")}`;
      const randomSuffix = String(Math.floor(Math.random() * 900) + 100);
      return `FAC-${dateStamp}-${randomSuffix}`;
    }

    function ensureInvoiceDefaults() {
      let updated = false;
      if (!BILLING.invoice.invoice_date) {
        BILLING.invoice.invoice_date = getTodayInputValue();
        updated = true;
      }
      if (!BILLING.invoice.invoice_number) {
        BILLING.invoice.invoice_number = buildInvoiceNumber();
        updated = true;
      }
      if (updated) {
        saveBilling();
      }
      elements.invoiceDate.value = BILLING.invoice.invoice_date;
      elements.invoiceNumber.value = BILLING.invoice.invoice_number;
    }

    function applyBillingState() {
      elements.companyName.value = BILLING.issuer.company_name || "";
      elements.companyAddress.value = BILLING.issuer.company_address || "";
      elements.companyCountry.value = BILLING.issuer.company_country || "";
      elements.companyPostal.value = BILLING.issuer.company_postal || "";
      elements.companyPhone.value = BILLING.issuer.company_phone || "";
      elements.companyNif.value = BILLING.issuer.company_nif || "";
      elements.companyEmail.value = BILLING.issuer.company_email || "";
      elements.clientBillingName.value = BILLING.client.client_name || "";
      elements.clientBillingAddress.value = BILLING.client.client_address || "";
      elements.clientBillingCountry.value = BILLING.client.client_country || "";
      elements.clientBillingPostal.value = BILLING.client.client_postal || "";
      elements.clientBillingPhone.value = BILLING.client.client_phone || "";
      elements.clientBillingNif.value = BILLING.client.client_nif || "";
      elements.clientBillingEmail.value = BILLING.client.client_email || "";
      elements.invoiceNumber.value = BILLING.invoice.invoice_number || "";
      elements.invoiceDate.value = BILLING.invoice.invoice_date || "";
      elements.invoiceDueDate.value = BILLING.invoice.due_date || "";
      elements.invoiceNotes.value = BILLING.invoice.notes || "";
      elements.invoiceShowDetails.checked = BILLING.invoice.show_details ?? true;
      renderCustomFields();
    }

    function syncBillingFromForm() {
      BILLING.issuer = {
        company_name: elements.companyName.value,
        company_address: elements.companyAddress.value,
        company_country: elements.companyCountry.value,
        company_postal: elements.companyPostal.value,
        company_phone: elements.companyPhone.value,
        company_nif: elements.companyNif.value,
        company_email: elements.companyEmail.value
      };
      BILLING.client = {
        client_name: elements.clientBillingName.value,
        client_address: elements.clientBillingAddress.value,
        client_country: elements.clientBillingCountry.value,
        client_postal: elements.clientBillingPostal.value,
        client_phone: elements.clientBillingPhone.value,
        client_nif: elements.clientBillingNif.value,
        client_email: elements.clientBillingEmail.value
      };
      BILLING.invoice = {
        invoice_number: elements.invoiceNumber.value,
        invoice_date: elements.invoiceDate.value,
        due_date: elements.invoiceDueDate.value,
        notes: elements.invoiceNotes.value,
        show_details: elements.invoiceShowDetails.checked
      };
      saveBilling();
    }

    function renderCustomFields() {
      elements.customFields.innerHTML = "";
      if (!Array.isArray(BILLING.customFields)) {
        BILLING.customFields = [];
      }
      BILLING.customFields.forEach((field, index) => {
        const row = document.createElement("div");
        row.className = "custom-field-row";
        row.innerHTML = `
          <input type="text" placeholder="Libellé" value="${escapeHtml(field.label || "")}" />
          <input type="text" placeholder="Valeur" value="${escapeHtml(field.value || "")}" />
          <button class="btn" type="button">Supprimer</button>
        `;
        const [labelInput, valueInput, deleteButton] = row.querySelectorAll("input, button");
        labelInput.addEventListener("input", event => {
          BILLING.customFields[index].label = event.target.value;
          saveBilling();
          updateInvoicePreview();
        });
        valueInput.addEventListener("input", event => {
          BILLING.customFields[index].value = event.target.value;
          saveBilling();
          updateInvoicePreview();
        });
        deleteButton.addEventListener("click", () => {
          BILLING.customFields.splice(index, 1);
          saveBilling();
          renderCustomFields();
          updateInvoicePreview();
        });
        elements.customFields.appendChild(row);
      });
    }

    function getResolutionUplift(category, resolution) {
      const categoryUplift = CONFIG.resolution_pricing?.uplifts_by_category?.[category]?.[resolution];
      if (categoryUplift !== undefined) return categoryUplift;
      return CONFIG.resolution_pricing?.uplifts_default?.[resolution] ?? 0;
    }

    function calculateRenderCost(category, count, resolution) {
      const safeCount = sanitizeIntWithFlag(count, LIMITS.renders.min, LIMITS.renders.max);
      if (safeCount <= 0) return 0;
      const tiers = CONFIG.render_tiers[category];
      if (CONFIG.resolution_pricing.mode === "per_resolution") {
        const units = CONFIG.resolution_pricing.per_resolution_units?.[category]?.[resolution];
        return applyTieredUnits(safeCount, tiers, units);
      }
      const baseCost = applyTieredPricing(safeCount, tiers);
      const uplift = toNumberSafe(getResolutionUplift(category, resolution), 0);
      return baseCost + uplift * safeCount;
    }

    function calculateTypologyCost(typology) {
      const instances = sanitizeIntWithFlag(
        typology.instances,
        LIMITS.typologyInstances.min,
        LIMITS.typologyInstances.max
      );
      if (instances === 0) {
        return { baseCost: 0, duplicationCost: 0, variationCost: 0, total: 0 };
      }
      const complexity = ["simple", "standard", "complex"].includes(typology.complexity)
        ? typology.complexity
        : "standard";
      const baseCost = ensureFinite(
        toNumberSafe(CONFIG.typologies.complexity_costs[complexity], CONFIG.typologies.complexity_costs.standard),
        "typology.baseCost",
        typology
      );
      let duplicationCost = 0;
      if (instances > 1) {
        const additional = instances - 1;
        if (CONFIG.typologies.duplication_mode === "tiered") {
          duplicationCost = applyTieredPricing(additional, CONFIG.typologies.duplication_tiers);
        } else {
          const duplicationFee = toNumberSafe(
            CONFIG.typologies.duplication_fee[complexity],
            CONFIG.typologies.duplication_fee.standard
          );
          duplicationCost = additional * duplicationFee;
        }
      }
      let variationCost = 0;
      if (typology.variationsEnabled) {
        const variationMode = ["percent", "fixed"].includes(typology.variationMode)
          ? typology.variationMode
          : CONFIG.typologies.variation_mode;
        const variationScope = ["per_instance", "per_typology"].includes(typology.variationScope)
          ? typology.variationScope
          : CONFIG.typologies.variation_scope;
        const scopeMultiplier = variationScope === "per_instance" ? instances : 1;
        const rawVariationValue = toNumberSafe(typology.variationValue, CONFIG.typologies.variation_value);
        if (variationMode === "percent") {
          const variationValue = clampNumber(rawVariationValue, LIMITS.typologyVariationPercent.min, LIMITS.typologyVariationPercent.max);
          variationCost = (baseCost + duplicationCost) * (variationValue / 100) * scopeMultiplier;
        } else {
          const variationValue = clampNumber(rawVariationValue, 0, MAX_TYPOLOGY_VARIATION_FIXED);
          variationCost = variationValue * scopeMultiplier;
        }
      }
      duplicationCost = ensureFinite(duplicationCost, "typology.duplicationCost", typology);
      variationCost = ensureFinite(variationCost, "typology.variationCost", typology);
      return {
        baseCost,
        duplicationCost,
        variationCost,
        total: ensureFinite(baseCost + duplicationCost + variationCost, "typology.total", typology)
      };
    }

    function calculateModule(module) {
      const base = ensureFinite(
        toNumberSafe(module.type === "masterplan" ? CONFIG.masterplan.base_fee : CONFIG.base[module.type], 0),
        "module.base",
        module
      );
      let production = 0;
      let capped = false;
      const breakdown = {
        volumes: 0,
        scenes: 0,
        area: 0,
        program: 0,
        renders: { aerial: 0, exterior: 0, interior: 0 },
        typologies: 0
      };

      if (module.type === "masterplan") {
        const isHa = module.masterplan.areaUnit === "ha";
        const areaValue = isHa
          ? sanitizeNumberWithFlag(module.masterplan.area, LIMITS.masterplanAreaHa.min, LIMITS.masterplanAreaHa.max)
          : sanitizeNumberWithFlag(module.masterplan.area, LIMITS.masterplanAreaM2.min, LIMITS.masterplanAreaM2.max);
        const areaM2 = isHa ? areaValue * 10000 : areaValue;
        const haTiers = CONFIG.masterplan.area_tiers_ha;
        const useHaTiers = isHa && Array.isArray(haTiers) && haTiers.length > 0;
        breakdown.area = applyTieredPricing(useHaTiers ? areaValue : areaM2, useHaTiers ? haTiers : CONFIG.masterplan.area_tiers);
        breakdown.area = ensureFinite(breakdown.area, "masterplan.area", module);
        breakdown.program =
          sanitizeIntWithFlag(
            module.masterplan.primary_structures,
            LIMITS.masterplanStructures.min,
            LIMITS.masterplanStructures.max
          ) *
            toNumberSafe(CONFIG.masterplan.unit_costs.primary_structures, 0) +
          sanitizeIntWithFlag(
            module.masterplan.secondary_structures,
            LIMITS.masterplanStructures.min,
            LIMITS.masterplanStructures.max
          ) *
            toNumberSafe(CONFIG.masterplan.unit_costs.secondary_structures, 0) +
          sanitizeIntWithFlag(
            module.masterplan.outdoor_features,
            LIMITS.masterplanStructures.min,
            LIMITS.masterplanStructures.max
          ) *
            toNumberSafe(CONFIG.masterplan.unit_costs.outdoor_features, 0) +
          sanitizeIntWithFlag(module.masterplan.parking_zones, LIMITS.masterplanStructures.min, LIMITS.masterplanStructures.max) *
            toNumberSafe(CONFIG.masterplan.unit_costs.parking_zones, 0);
        breakdown.program = ensureFinite(breakdown.program, "masterplan.program", module);
        production += breakdown.area + breakdown.program;
      }

      if (module.type === "interior" || module.type === "exterior") {
        if (module.m2.enabled && CONFIG.toggles.enable_tiered_m2) {
          const m2Value = sanitizeIntWithFlag(module.m2.value, LIMITS.m2Value.min, LIMITS.m2Value.max);
          breakdown.area = applyTieredPricing(m2Value, CONFIG.tiered_m2);
          breakdown.area = ensureFinite(breakdown.area, "module.m2", module);
          production += breakdown.area;
        } else {
          const packPricing = CONFIG.packs[module.type][module.pack];
          breakdown.volumes =
            sanitizeIntWithFlag(module.volumes.small, LIMITS.volumes.min, LIMITS.volumes.max) *
              toNumberSafe(packPricing.small, 0) +
            sanitizeIntWithFlag(module.volumes.medium, LIMITS.volumes.min, LIMITS.volumes.max) *
              toNumberSafe(packPricing.medium, 0) +
            sanitizeIntWithFlag(module.volumes.large, LIMITS.volumes.min, LIMITS.volumes.max) *
              toNumberSafe(packPricing.large, 0);
          breakdown.volumes = ensureFinite(breakdown.volumes, "module.volumes", module);
          production += breakdown.volumes;
        }
      }

      if (module.type === "visual") {
        breakdown.scenes =
          sanitizeIntWithFlag(module.scenes.small, LIMITS.scenes.min, LIMITS.scenes.max) *
            toNumberSafe(CONFIG.scenes.small, 0) +
          sanitizeIntWithFlag(module.scenes.medium, LIMITS.scenes.min, LIMITS.scenes.max) *
            toNumberSafe(CONFIG.scenes.medium, 0) +
          sanitizeIntWithFlag(module.scenes.large, LIMITS.scenes.min, LIMITS.scenes.max) *
            toNumberSafe(CONFIG.scenes.large, 0);
        breakdown.scenes = ensureFinite(breakdown.scenes, "module.scenes", module);
        production += breakdown.scenes;
      }

      Object.entries(module.renders).forEach(([category, count]) => {
        const renderCount = sanitizeIntWithFlag(count, LIMITS.renders.min, LIMITS.renders.max);
        if (renderCount > 0) {
          breakdown.renders[category] = calculateRenderCost(category, renderCount, module.resolution);
          breakdown.renders[category] = ensureFinite(breakdown.renders[category], `module.renders.${category}`, module);
          production += breakdown.renders[category];
        }
      });

      if (module.typologiesEnabled) {
        module.typologies.forEach(typology => {
          const typologyCost = calculateTypologyCost(typology);
          breakdown.typologies += typologyCost.total;
          production += typologyCost.total;
        });
      }
      production = ensureFinite(production, "module.production", module);

      const multiplierTotal =
        toNumberSafe(CONFIG.multipliers.complexity[module.multipliers.complexity], 1) *
        toNumberSafe(CONFIG.multipliers.details[module.multipliers.details], 1) *
        toNumberSafe(CONFIG.multipliers.delay[module.multipliers.delay], 1) *
        toNumberSafe(CONFIG.multipliers.usage[module.multipliers.usage], 1) *
        (module.type === "masterplan" ? toNumberSafe(CONFIG.multipliers.topography[module.masterplan.topography], 1) : 1) *
        (module.type === "masterplan" ? toNumberSafe(CONFIG.multipliers.circulation[module.masterplan.circulation], 1) : 1) *
        (module.type === "masterplan" ? toNumberSafe(CONFIG.multipliers.landscape[module.masterplan.landscape], 1) : 1);
      const safeMultiplier = ensureFinite(multiplierTotal, "module.multiplier", module);

      const subTotal = ensureFinite((base + production) * safeMultiplier, "module.subTotal", module);

      let options = 0;
      if (module.options.moodboard) options += toNumberSafe(CONFIG.options.moodboard, 0);
      if (module.options.plan2d) options += toNumberSafe(CONFIG.options.plan2d, 0);
      if (module.options.shopping) options += toNumberSafe(CONFIG.options.shopping, 0);
      if (module.options.modeling) options += production * toNumberSafe(CONFIG.options.modeling_pct, 0);
      if (module.options.furniture) options += production * toNumberSafe(CONFIG.options.furniture_pct, 0);
      if (module.options.landscape) options += production * toNumberSafe(CONFIG.options.landscape_pct, 0);
      if (module.options.sources) options += subTotal * toNumberSafe(CONFIG.options.sources_pct, 0);
      if (module.options.animation) {
        const seconds = sanitizeIntWithFlag(
          module.animationSeconds,
          LIMITS.animationSeconds.min,
          LIMITS.animationSeconds.max
        );
        options += seconds * toNumberSafe(CONFIG.options.animation_sec, 0);
      }
      options = ensureFinite(options, "module.options", module);

      const cyclesAsked = Math.max(1, Math.round(toNumberSafe(module.revisions.cycles, 1)));
      const cyclesIncluded = toNumberSafe(CONFIG.revisions.included, 0);
      const cyclesExtra = Math.max(0, cyclesAsked - cyclesIncluded);
      const revisions = cyclesExtra * (base + production) * toNumberSafe(CONFIG.revisions.rate, 0);

      const safeRevisions = ensureFinite(revisions, "module.revisions", module);
      let total = ensureFinite(subTotal + options + safeRevisions, "module.total", module);
      if (total > MAX_MODULE_TOTAL_MGA) {
        total = MAX_MODULE_TOTAL_MGA;
        markCapped();
        capped = true;
      }

      return {
        id: module.id,
        name: module.name,
        type: module.type,
        pack: module.pack,
        resolution: module.resolution,
        multipliers: module.multipliers,
        base,
        production,
        breakdown,
        multiplierTotal,
        subTotal,
        options,
        revisions: safeRevisions,
        total,
        capped
      };
    }

    function calculateProject() {
      const moduleTotals = UI_STATE.modules.map(module => calculateModule(module));
      const totalBrutRaw = moduleTotals.reduce((sum, module) => sum + module.total, 0);
      let totalBrut = ensureFinite(totalBrutRaw, "project.totalBrut", moduleTotals);
      if (totalBrut > MAX_PROJECT_TOTAL_MGA) {
        totalBrut = MAX_PROJECT_TOTAL_MGA;
        markCapped();
      }
      const minimumValue = toNumberSafe(CONFIG.minimum, 0);
      const minimumApplied = totalBrut < minimumValue;
      let totalFinal = minimumApplied ? minimumValue : totalBrut;
      if (totalFinal > MAX_PROJECT_TOTAL_MGA) {
        totalFinal = MAX_PROJECT_TOTAL_MGA;
        markCapped();
      }
      const vatEnabled = CONFIG.vat_enabled ?? false;
      const tvaRate = vatEnabled ? toNumberSafe(CONFIG.vat_rate, 0) : 0;
      const tvaAmount = ensureFinite(totalFinal * (tvaRate / 100), "project.tvaAmount", totalFinal);
      const totalTtc = ensureFinite(totalFinal + tvaAmount, "project.totalTtc", totalFinal);

      return {
        modules: moduleTotals,
        totalBrut,
        minimumApplied,
        totalFinal,
        tvaRate,
        tvaAmount,
        totalTtc
      };
    }

    function renderSummary(project) {
      const showTva = CONFIG.vat_enabled ?? false;
      const totalHT = project.totalFinal;
      const totalTTC = project.totalTtc;
      const grandTotal = showTva ? totalTTC : totalHT;
      elements.totalMain.textContent = formatCurrency(grandTotal);
      elements.totalAlt.textContent = formatAltCurrency(grandTotal);
      elements.totalLabel.textContent = showTva ? "Total TTC" : "Total HT";
      elements.minimumPill.style.display = project.minimumApplied ? "inline-flex" : "none";

      const isEmptyProject =
        UI_STATE.modules.length === 0 ||
        UI_STATE.modules.every(module => {
          const hasVolumes = Object.values(module.volumes || {}).some(value => toNumberSafe(value, 0) > 0);
          const hasScenes = Object.values(module.scenes || {}).some(value => toNumberSafe(value, 0) > 0);
          const hasRenders = Object.values(module.renders || {}).some(value => toNumberSafe(value, 0) > 0);
          const hasArea = toNumberSafe(module.masterplan?.area, 0) > 0 || toNumberSafe(module.m2?.value, 0) > 0;
          const hasTypologies =
            module.typologiesEnabled && module.typologies.some(t => toNumberSafe(t.instances, 0) > 0);
          return !(hasVolumes || hasScenes || hasRenders || hasArea || hasTypologies);
        });
      elements.emptyWarning.style.display = isEmptyProject ? "block" : "none";

      elements.summaryModules.innerHTML = project.modules
        .map(
          module => `
            <div class="summary-item">
              <span>${escapeHtml(module.name || MODULE_LABELS[module.type])}</span>
              <span class="price-label">${formatCurrency(module.total)}</span>
            </div>
          `
        )
        .join("");

      const detailLines = [];
      project.modules.forEach(module => {
        detailLines.push(
          `<div class="summary-item"><strong>${escapeHtml(module.name || MODULE_LABELS[module.type])}</strong><span class="price-label">${formatCurrency(
            module.total
          )}</span></div>`
        );
        detailLines.push(`<div class="summary-item sub"><span>Base</span><span class="price-label">${formatCurrency(module.base)}</span></div>`);
        detailLines.push(
          `<div class="summary-item sub"><span>Production</span><span class="price-label">${formatCurrency(module.production)}</span></div>`
        );
        if (module.options) {
          detailLines.push(
            `<div class="summary-item sub"><span>Options</span><span class="price-label">${formatCurrency(module.options)}</span></div>`
          );
        }
        if (module.revisions) {
          detailLines.push(
            `<div class="summary-item sub"><span>Retours</span><span class="price-label">${formatCurrency(module.revisions)}</span></div>`
          );
        }
      });
      if (project.minimumApplied) {
        detailLines.push(
          `<div class="summary-item"><span>Minimum appliqué</span><span class="price-label">${formatCurrency(CONFIG.minimum)}</span></div>`
        );
      }
      if (showTva) {
        detailLines.push(
          `<div class="summary-item"><span>TVA (${project.tvaRate}%)</span><span class="price-label">${formatCurrency(project.tvaAmount)}</span></div>`
        );
      }
      detailLines.push(
        `<div class="summary-item total"><span>Total ${showTva ? "TTC" : "HT"}</span><span class="price-label">${formatCurrency(
          grandTotal
        )}</span></div>`
      );
      elements.summaryDetails.innerHTML = detailLines.join("");
    }

    function renderProjectDeliverables(project) {
      const totalRenders = { aerial: 0, exterior: 0, interior: 0 };
      const resolutionBadges = new Set();
      const optionBadges = new Set();
      project.modules.forEach(module => {
        const moduleState = UI_STATE.modules.find(item => item.id === module.id);
        if (!moduleState) return;
        totalRenders.aerial += toNumberSafe(moduleState.renders.aerial, 0);
        totalRenders.exterior += toNumberSafe(moduleState.renders.exterior, 0);
        totalRenders.interior += toNumberSafe(moduleState.renders.interior, 0);
        resolutionBadges.add(moduleState.resolution);
        if (moduleState.options.sources) optionBadges.add("Sources");
        if (moduleState.options.animation) optionBadges.add("Animation");
      });

      const summaryItems = [
        `Modules : ${project.modules.length}`,
        `Rendus aériens : ${totalRenders.aerial}`,
        `Rendus extérieurs : ${totalRenders.exterior}`,
        `Rendus intérieurs : ${totalRenders.interior}`
      ];
      const resolutionLabel = Array.from(resolutionBadges).join(" / ");
      if (resolutionLabel) {
        summaryItems.push(`Résolution : ${resolutionLabel}`);
      }

      elements.deliverablesBody.innerHTML = `
        <div class="deliverables-section">
          <h4>Vue d'ensemble</h4>
          <ul>${summaryItems.map(item => `<li>${escapeHtml(item)}</li>`).join("")}</ul>
        </div>
      `;

      const badges = Array.from(resolutionBadges).map(label => ({ label, type: "info" }));
      optionBadges.forEach(label => badges.push({ label, type: "warn" }));
      elements.deliverablesBadges.innerHTML = badges
        .map(
          badge =>
            `<span class="deliverables-badge${badge.type === "warn" ? " deliverables-badge--warn" : ""}">${escapeHtml(badge.label)}</span>`
        )
        .join("");
    }

    function buildTypologyLabel(typology) {
      const instances = toNumberSafe(typology.instances, 0);
      return `${typology.name || "Typologie"} ×${instances}`;
    }

    function renderModuleDeliverables(moduleState) {
      const sections = [];
      if (moduleState.type === "masterplan") {
        sections.push({
          title: "Livrables masterplan",
          items: DELIVERABLES.masterplan
        });
        const areaLabel =
          moduleState.masterplan.areaUnit === "ha"
            ? `${moduleState.masterplan.area} ha`
            : `${moduleState.masterplan.area} m²`;
        sections.push({
          title: "Programme & surface",
          items: [
            `Surface : ${areaLabel}`,
            `Structures principales : ${moduleState.masterplan.primary_structures}`,
            `Structures secondaires : ${moduleState.masterplan.secondary_structures}`,
            `Aménagements extérieurs : ${moduleState.masterplan.outdoor_features}`,
            `Zones parking : ${moduleState.masterplan.parking_zones}`
          ]
        });
      } else {
        const packItems = DELIVERABLES[moduleState.type]?.[moduleState.pack] || [];
        sections.push({ title: "Base du module", items: packItems });
      }

      if (moduleState.typologiesEnabled && moduleState.typologies.length) {
        sections.push({
          title: "Typologies",
          items: moduleState.typologies.map(buildTypologyLabel)
        });
      }

      const renderItems = [];
      const totalRenders = Object.entries(moduleState.renders)
        .filter(([, value]) => Number(value) > 0)
        .map(([category, value]) => `${RENDER_LABELS[category] || category} : ${value}`);
      if (totalRenders.length) {
        renderItems.push(`Rendus : ${totalRenders.join(" / ")}`);
        renderItems.push(`Résolution : ${moduleState.resolution}`);
      }
      if (renderItems.length) {
        sections.push({ title: "Rendus", items: renderItems });
      }

      const optionItems = [];
      if (moduleState.options.moodboard) optionItems.push("Moodboard détaillé");
      if (moduleState.options.plan2d) optionItems.push("Plan 2D");
      if (moduleState.options.shopping) optionItems.push("Liste shopping");
      if (moduleState.options.modeling) optionItems.push("Modélisation sur mesure");
      if (moduleState.options.furniture) optionItems.push("Mobilier / déco");
      if (moduleState.options.landscape) optionItems.push("Paysage / végétation");
      if (moduleState.options.sources) optionItems.push("Fichiers sources");
      if (moduleState.options.animation) optionItems.push(`Animation ${moduleState.animationSeconds}s`);
      if (optionItems.length) {
        sections.push({ title: "Options activées", items: optionItems });
      }

      const cyclesText = `Cycles de retours : ${moduleState.revisions.cycles} (inclus ${CONFIG.revisions.included})`;
      sections.push({ title: "Retours", items: [cyclesText] });

      const container = moduleElements.get(moduleState.id)?.querySelector(".module-deliverables-body");
      if (!container) return;
      container.innerHTML = sections
        .map(
          section => `
          <div class="deliverables-section">
            <h4>${escapeHtml(section.title)}</h4>
            <ul>${section.items.map(item => `<li>${escapeHtml(item)}</li>`).join("")}</ul>
          </div>
        `
        )
        .join("");
    }

    function updateModuleCardOutputs(project) {
      project.modules.forEach(moduleCalc => {
        const card = moduleElements.get(moduleCalc.id);
        if (!card) return;
        const subtotalEl = card.querySelector(".module-subtotal");
        if (subtotalEl) subtotalEl.textContent = formatCurrency(moduleCalc.total);
        const cappedTag = card.querySelector(".module-cap-tag");
        if (cappedTag) {
          cappedTag.style.display = moduleCalc.capped ? "inline-flex" : "none";
        }
        const moduleState = UI_STATE.modules.find(item => item.id === moduleCalc.id);
        if (moduleState) {
          renderModuleDeliverables(moduleState);
        }
      });
    }

    function calculateAndRender(options = {}) {
      const shouldFlagAdjustment = options.adjusted || pendingAdjustment;
      pendingAdjustment = false;
      resetCalcWarnings();
      if (shouldFlagAdjustment) {
        markAdjustment();
      }
      const project = calculateProject();
      renderSummary(project);
      renderProjectDeliverables(project);
      updateModuleCardOutputs(project);
      saveUIState();
      updateInvoicePreview();
      updateCalcWarning();
    }

    function updateModuleVisibility(card, module) {
      const showMasterplan = module.type === "masterplan";
      const showVolumes = module.type === "interior" || module.type === "exterior";
      const showScenes = module.type === "visual";
      const showTypologies = showMasterplan || module.type === "interior" || module.type === "exterior";
      const packSelect = card.querySelector(".module-pack");
      packSelect.disabled = module.type === "masterplan";
      card.querySelector("[data-section='masterplan']").style.display = showMasterplan ? "flex" : "none";
      card.querySelector("[data-section='volumes']").style.display = showVolumes ? "flex" : "none";
      card.querySelector("[data-section='scenes']").style.display = showScenes ? "flex" : "none";
      card.querySelector("[data-section='typologies']").style.display = showTypologies ? "flex" : "none";
      card.querySelector(".module-m2-toggle").style.display = showVolumes ? "block" : "none";
      card.querySelector(".module-m2-field").style.display = showVolumes && module.m2.enabled ? "block" : "none";
      card.querySelector(".module-animation-row").style.display = module.options.animation ? "flex" : "none";
      card.querySelector(".module-typologies-toggle").closest("label").style.display = showTypologies ? "flex" : "none";
      card.querySelector(".module-typology-list").style.display = module.typologiesEnabled ? "flex" : "none";
      card.querySelector(".module-add-typology").style.display = module.typologiesEnabled ? "inline-flex" : "none";
    }

    function renderTypologies(module, container) {
      container.innerHTML = "";
      const categories = CONFIG.typologies.categories || [];
      module.typologies.forEach(typology => {
        const row = document.createElement("div");
        row.className = "module-typology-row";
        row.dataset.typologyId = typology.id;
        row.innerHTML = `
          <div class="module-typology-header">
            <div class="module-typology-title">
              <span class="module-typology-tag">Typologie</span>
              <input type="text" placeholder="Nom de la typologie" value="${escapeHtml(typology.name || "")}" />
            </div>
            <button class="btn" type="button">Supprimer</button>
          </div>
          <div class="module-typology-grid">
            <div class="module-typology-field">
              <label>Catégorie</label>
              <select>
                ${categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join("")}
              </select>
            </div>
            <div class="module-typology-field">
              <label>Complexité</label>
              <select>
                <option value="simple">Simple</option>
                <option value="standard">Standard</option>
                <option value="complex">Complexe</option>
              </select>
            </div>
            <div class="module-typology-field">
              <label>Quantité</label>
              <input type="number" min="0" value="${escapeHtml(typology.instances ?? 0)}" />
            </div>
            <div class="module-typology-field module-typology-variations">
              <label class="checkbox">
                <input type="checkbox" ${typology.variationsEnabled ? "checked" : ""} />
                Variantes
              </label>
              <div class="inline">
                <select>
                  <option value="percent">%</option>
                  <option value="fixed">Fixe</option>
                </select>
                <input type="number" min="0" value="${escapeHtml(typology.variationValue ?? CONFIG.typologies.variation_value)}" />
              </div>
              <small>Applique une variation sur la typologie sélectionnée.</small>
            </div>
          </div>
        `;
        const inputs = row.querySelectorAll("input, select");
        const [nameInput, categorySelect, complexitySelect, instancesInput, variationsToggle, variationMode, variationValue] = [
          inputs[0],
          inputs[1],
          inputs[2],
          inputs[3],
          inputs[4],
          inputs[5],
          inputs[6]
        ];
        categorySelect.value = typology.category || categories[0];
        complexitySelect.value = typology.complexity || "standard";
        variationMode.value = typology.variationMode || CONFIG.typologies.variation_mode;
        nameInput.addEventListener("input", event => {
          typology.name = event.target.value;
          debouncedCalculateAndRender();
        });
        categorySelect.addEventListener("change", event => {
          typology.category = event.target.value;
          debouncedCalculateAndRender();
        });
        complexitySelect.addEventListener("change", event => {
          typology.complexity = event.target.value;
          debouncedCalculateAndRender();
        });
        instancesInput.addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.typologyInstances.min, LIMITS.typologyInstances.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          typology.instances = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        variationsToggle.addEventListener("change", event => {
          typology.variationsEnabled = event.target.checked;
          debouncedCalculateAndRender();
        });
        variationMode.addEventListener("change", event => {
          typology.variationMode = event.target.value;
          const maxValue =
            event.target.value === "percent" ? LIMITS.typologyVariationPercent.max : MAX_TYPOLOGY_VARIATION_FIXED;
          const nextValue = clampNumber(variationValue.value, 0, maxValue);
          const rawValue = toNumberSafe(variationValue.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          typology.variationValue = nextValue;
          variationValue.value = nextValue;
          debouncedCalculateAndRender();
        });
        variationValue.addEventListener("input", event => {
          const mode = variationMode.value;
          const maxValue =
            mode === "percent" ? LIMITS.typologyVariationPercent.max : MAX_TYPOLOGY_VARIATION_FIXED;
          const nextValue = clampNumber(event.target.value, 0, maxValue);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          typology.variationValue = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        row.querySelector("button").addEventListener("click", () => {
          module.typologies = module.typologies.filter(item => item.id !== typology.id);
          renderTypologies(module, container);
          debouncedCalculateAndRender();
        });
        container.appendChild(row);
      });
    }

    function renderModules() {
      moduleElements.clear();
      elements.modulesContainer.innerHTML = "";
      elements.modulesEmpty.style.display = UI_STATE.modules.length ? "none" : "block";
      UI_STATE.modules.forEach(module => {
        const card = elements.moduleTemplate.content.firstElementChild.cloneNode(true);
        card.dataset.moduleId = module.id;
        if (module.collapsed) card.classList.add("module-collapsed");
        card.querySelector(".module-name").value = module.name || "";
        card.querySelector(".module-type").value = module.type;
        card.querySelector(".module-pack").value = module.pack;
        card.querySelector(".module-resolution").value = module.resolution;
        card.querySelector(".module-complexity").value = module.multipliers.complexity;
        card.querySelector(".module-details").value = module.multipliers.details;
        card.querySelector(".module-usage").value = module.multipliers.usage;
        card.querySelector(".module-delay").value = module.multipliers.delay;

        card.querySelector(".module-site-area").value = module.masterplan.area;
        card.querySelector(".module-site-unit").value = module.masterplan.areaUnit;
        card.querySelector(".module-topography").value = module.masterplan.topography;
        card.querySelector(".module-circulation").value = module.masterplan.circulation;
        card.querySelector(".module-landscape-density").value = module.masterplan.landscape;
        card.querySelector(".module-primary-structures").value = module.masterplan.primary_structures;
        card.querySelector(".module-secondary-structures").value = module.masterplan.secondary_structures;
        card.querySelector(".module-outdoor-features").value = module.masterplan.outdoor_features;
        card.querySelector(".module-parking-zones").value = module.masterplan.parking_zones;

        card.querySelector(".module-volume-small").value = module.volumes.small;
        card.querySelector(".module-volume-medium").value = module.volumes.medium;
        card.querySelector(".module-volume-large").value = module.volumes.large;
        card.querySelector(".module-use-m2").checked = module.m2.enabled;
        card.querySelector(".module-m2-value").value = module.m2.value;

        card.querySelector(".module-scene-small").value = module.scenes.small;
        card.querySelector(".module-scene-medium").value = module.scenes.medium;
        card.querySelector(".module-scene-large").value = module.scenes.large;

        card.querySelector(".module-render-aerial").value = module.renders.aerial;
        card.querySelector(".module-render-exterior").value = module.renders.exterior;
        card.querySelector(".module-render-interior").value = module.renders.interior;

        card.querySelector(".module-typologies-toggle").checked = module.typologiesEnabled;

        card.querySelector(".module-opt-moodboard").checked = module.options.moodboard;
        card.querySelector(".module-opt-plan").checked = module.options.plan2d;
        card.querySelector(".module-opt-shopping").checked = module.options.shopping;
        card.querySelector(".module-opt-modeling").checked = module.options.modeling;
        card.querySelector(".module-opt-furniture").checked = module.options.furniture;
        card.querySelector(".module-opt-landscape").checked = module.options.landscape;
        card.querySelector(".module-opt-sources").checked = module.options.sources;
        card.querySelector(".module-opt-animation").checked = module.options.animation;
        card.querySelector(".module-animation-seconds").value = module.animationSeconds;

        card.querySelector(".module-cycles").value = module.revisions.cycles;
        card.querySelector(".module-cycles-included").textContent = CONFIG.revisions.included;
        const typologyList = card.querySelector(".module-typology-list");
        renderTypologies(module, typologyList);

        card.querySelector(".module-name").addEventListener("input", event => {
          module.name = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-type").addEventListener("change", event => {
          module.type = event.target.value;
          if (!module.name) module.name = MODULE_LABELS[module.type];
          module.typologiesEnabled = module.type === "masterplan" ? true : module.typologiesEnabled;
          updateModuleVisibility(card, module);
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-pack").addEventListener("change", event => {
          module.pack = event.target.value;
          if (!module.resolution) module.resolution = getPackResolution(module.pack);
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-resolution").addEventListener("change", event => {
          module.resolution = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-complexity").addEventListener("change", event => {
          module.multipliers.complexity = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-details").addEventListener("change", event => {
          module.multipliers.details = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-usage").addEventListener("change", event => {
          module.multipliers.usage = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-delay").addEventListener("change", event => {
          module.multipliers.delay = event.target.value;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-site-area").addEventListener("input", event => {
          const isHa = module.masterplan.areaUnit === "ha";
          const limits = isHa ? LIMITS.masterplanAreaHa : LIMITS.masterplanAreaM2;
          const nextValue = clampNumber(event.target.value, limits.min, limits.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.area = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-site-unit").addEventListener("change", event => {
          module.masterplan.areaUnit = event.target.value;
          const areaInput = card.querySelector(".module-site-area");
          const isHa = module.masterplan.areaUnit === "ha";
          const limits = isHa ? LIMITS.masterplanAreaHa : LIMITS.masterplanAreaM2;
          const nextValue = clampNumber(areaInput.value, limits.min, limits.max);
          const rawValue = toNumberSafe(areaInput.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.area = nextValue;
          areaInput.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-topography").addEventListener("change", event => {
          module.masterplan.topography = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-circulation").addEventListener("change", event => {
          module.masterplan.circulation = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-landscape-density").addEventListener("change", event => {
          module.masterplan.landscape = event.target.value;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-primary-structures").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.masterplanStructures.min, LIMITS.masterplanStructures.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.primary_structures = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-secondary-structures").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.masterplanStructures.min, LIMITS.masterplanStructures.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.secondary_structures = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-outdoor-features").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.masterplanStructures.min, LIMITS.masterplanStructures.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.outdoor_features = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-parking-zones").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.masterplanStructures.min, LIMITS.masterplanStructures.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.masterplan.parking_zones = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-volume-small").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.volumes.min, LIMITS.volumes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.volumes.small = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-volume-medium").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.volumes.min, LIMITS.volumes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.volumes.medium = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-volume-large").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.volumes.min, LIMITS.volumes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.volumes.large = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-use-m2").addEventListener("change", event => {
          module.m2.enabled = event.target.checked;
          updateModuleVisibility(card, module);
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-m2-value").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.m2Value.min, LIMITS.m2Value.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.m2.value = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-scene-small").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.scenes.min, LIMITS.scenes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.scenes.small = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-scene-medium").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.scenes.min, LIMITS.scenes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.scenes.medium = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-scene-large").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.scenes.min, LIMITS.scenes.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.scenes.large = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-render-aerial").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.renders.min, LIMITS.renders.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.renders.aerial = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-render-exterior").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.renders.min, LIMITS.renders.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.renders.exterior = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-render-interior").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.renders.min, LIMITS.renders.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.renders.interior = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-typologies-toggle").addEventListener("change", event => {
          module.typologiesEnabled = event.target.checked;
          updateModuleVisibility(card, module);
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-add-typology").addEventListener("click", () => {
          module.typologies.push({
            id: generateId(),
            name: "",
            category: CONFIG.typologies.categories[0],
            complexity: "standard",
            instances: 1,
            variationsEnabled: false,
            variationMode: CONFIG.typologies.variation_mode,
            variationValue: CONFIG.typologies.variation_value,
            variationScope: CONFIG.typologies.variation_scope
          });
          renderTypologies(module, typologyList);
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-opt-moodboard").addEventListener("change", event => {
          module.options.moodboard = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-plan").addEventListener("change", event => {
          module.options.plan2d = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-shopping").addEventListener("change", event => {
          module.options.shopping = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-modeling").addEventListener("change", event => {
          module.options.modeling = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-furniture").addEventListener("change", event => {
          module.options.furniture = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-landscape").addEventListener("change", event => {
          module.options.landscape = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-sources").addEventListener("change", event => {
          module.options.sources = event.target.checked;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-opt-animation").addEventListener("change", event => {
          module.options.animation = event.target.checked;
          updateModuleVisibility(card, module);
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-animation-seconds").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, LIMITS.animationSeconds.min, LIMITS.animationSeconds.max);
          const rawValue = toNumberSafe(event.target.value, 0);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.animationSeconds = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });

        card.querySelector(".module-cycles").addEventListener("input", event => {
          const nextValue = sanitizeInt(event.target.value, 1, 999);
          const rawValue = toNumberSafe(event.target.value, 1);
          if (rawValue !== nextValue) {
            markPendingAdjustment();
          }
          module.revisions.cycles = nextValue;
          event.target.value = nextValue;
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-duplicate").addEventListener("click", () => {
          const clone = deepMerge(module, { id: generateId(), name: `${module.name} (copie)` });
          UI_STATE.modules.push(clone);
          renderModules();
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-remove").addEventListener("click", () => {
          UI_STATE.modules = UI_STATE.modules.filter(item => item.id !== module.id);
          renderModules();
          debouncedCalculateAndRender();
        });
        card.querySelector(".module-collapse").addEventListener("click", () => {
          module.collapsed = !module.collapsed;
          card.classList.toggle("module-collapsed", module.collapsed);
        });

        updateModuleVisibility(card, module);
        moduleElements.set(module.id, card);
        elements.modulesContainer.appendChild(card);
      });
    }

    function setCurrency(currency) {
      UI_STATE.currency = currency;
      elements.currencyMga.classList.toggle("active", currency === "MGA");
      elements.currencyEur.classList.toggle("active", currency === "EUR");
      elements.currencyMga.setAttribute("aria-selected", currency === "MGA" ? "true" : "false");
      elements.currencyEur.setAttribute("aria-selected", currency === "EUR" ? "true" : "false");
      calculateAndRender();
    }

    function buildSettingsForm() {
      const form = [];

      const addGroup = (title, inputs) => {
        form.push(`<div class="section-divider"><h3>${title}</h3><div class="settings-grid">${inputs.join("")}</div></div>`);
      };

      const inputField = (label, path, type = "number", fieldType = "number") => `
        <div>
          <label>${label}</label>
          <input data-path="${path}" data-field-type="${fieldType}" type="${type}" />
        </div>`;

      const selectField = (label, path, options) => `
        <div>
          <label>${label}</label>
          <select data-path="${path}" data-field-type="string">
            ${options.map(option => `<option value="${option.value}">${option.label}</option>`).join("")}
          </select>
        </div>`;

      addGroup("Bases", [
        inputField("Base visuels", "base.visual"),
        inputField("Base intérieur", "base.interior"),
        inputField("Base extérieur", "base.exterior")
      ]);

      addGroup("Scènes 3D", [
        inputField("Scène petite", "scenes.small"),
        inputField("Scène moyenne", "scenes.medium"),
        inputField("Scène grande", "scenes.large")
      ]);

      addGroup("Pack intérieur - Concept", [
        inputField("Petit", "packs.interior.concept.small"),
        inputField("Moyen", "packs.interior.concept.medium"),
        inputField("Grand", "packs.interior.concept.large")
      ]);

      addGroup("Pack intérieur - Standard", [
        inputField("Petit", "packs.interior.standard.small"),
        inputField("Moyen", "packs.interior.standard.medium"),
        inputField("Grand", "packs.interior.standard.large")
      ]);

      addGroup("Pack intérieur - Premium", [
        inputField("Petit", "packs.interior.premium.small"),
        inputField("Moyen", "packs.interior.premium.medium"),
        inputField("Grand", "packs.interior.premium.large")
      ]);

      addGroup("Pack extérieur - Concept", [
        inputField("Petit", "packs.exterior.concept.small"),
        inputField("Moyen", "packs.exterior.concept.medium"),
        inputField("Grand", "packs.exterior.concept.large")
      ]);

      addGroup("Pack extérieur - Standard", [
        inputField("Petit", "packs.exterior.standard.small"),
        inputField("Moyen", "packs.exterior.standard.medium"),
        inputField("Grand", "packs.exterior.standard.large")
      ]);

      addGroup("Pack extérieur - Premium", [
        inputField("Petit", "packs.exterior.premium.small"),
        inputField("Moyen", "packs.exterior.premium.medium"),
        inputField("Grand", "packs.exterior.premium.large")
      ]);

      addGroup("Masterplan : base & surface", [
        inputField("Base masterplan", "masterplan.base_fee"),
        inputField("Surface jusqu'à (m²) - palier 1", "masterplan.area_tiers.0.upTo"),
        inputField("Prix/m² palier 1", "masterplan.area_tiers.0.unit"),
        inputField("Surface jusqu'à (m²) - palier 2", "masterplan.area_tiers.1.upTo"),
        inputField("Prix/m² palier 2", "masterplan.area_tiers.1.unit"),
        inputField("Prix/m² palier 3", "masterplan.area_tiers.2.unit")
      ]);
      addGroup("Masterplan : surface (ha)", [
        inputField("Surface jusqu'à (ha) - palier 1", "masterplan.area_tiers_ha.0.upTo"),
        inputField("Prix/ha palier 1", "masterplan.area_tiers_ha.0.unit"),
        inputField("Surface jusqu'à (ha) - palier 2", "masterplan.area_tiers_ha.1.upTo"),
        inputField("Prix/ha palier 2", "masterplan.area_tiers_ha.1.unit"),
        inputField("Surface jusqu'à (ha) - palier 3", "masterplan.area_tiers_ha.2.upTo"),
        inputField("Prix/ha palier 3", "masterplan.area_tiers_ha.2.unit"),
        inputField("Prix/ha palier 4", "masterplan.area_tiers_ha.3.unit")
      ]);

      addGroup("Masterplan : coûts unitaires", [
        inputField("Structure principale", "masterplan.unit_costs.primary_structures"),
        inputField("Structure secondaire", "masterplan.unit_costs.secondary_structures"),
        inputField("Aménagement extérieur", "masterplan.unit_costs.outdoor_features"),
        inputField("Zone parking", "masterplan.unit_costs.parking_zones")
      ]);

      addGroup("Rendus - paliers aériens", [
        inputField("Jusqu'à 2", "render_tiers.aerial.0.unit"),
        inputField("Jusqu'à 6", "render_tiers.aerial.1.unit"),
        inputField("Jusqu'à 12", "render_tiers.aerial.2.unit"),
        inputField("Au-delà", "render_tiers.aerial.3.unit")
      ]);

      addGroup("Rendus - paliers extérieurs", [
        inputField("Jusqu'à 2", "render_tiers.exterior.0.unit"),
        inputField("Jusqu'à 6", "render_tiers.exterior.1.unit"),
        inputField("Jusqu'à 12", "render_tiers.exterior.2.unit"),
        inputField("Au-delà", "render_tiers.exterior.3.unit")
      ]);

      addGroup("Rendus - paliers intérieurs", [
        inputField("Jusqu'à 2", "render_tiers.interior.0.unit"),
        inputField("Jusqu'à 6", "render_tiers.interior.1.unit"),
        inputField("Jusqu'à 12", "render_tiers.interior.2.unit"),
        inputField("Au-delà", "render_tiers.interior.3.unit")
      ]);

      addGroup("Résolution rendus", [
        selectField("Mode de pricing", "resolution_pricing.mode", [
          { value: "uplift", label: "Uplift par rendu" },
          { value: "per_resolution", label: "Courbes par résolution" }
        ]),
        inputField("Uplift HD", "resolution_pricing.uplifts_default.HD"),
        inputField("Uplift 2K", "resolution_pricing.uplifts_default.2K"),
        inputField("Uplift 4K", "resolution_pricing.uplifts_default.4K")
      ]);

      addGroup("Résolution par catégorie (uplift)", [
        inputField("Aérien 2K", "resolution_pricing.uplifts_by_category.aerial.2K"),
        inputField("Aérien 4K", "resolution_pricing.uplifts_by_category.aerial.4K"),
        inputField("Extérieur 2K", "resolution_pricing.uplifts_by_category.exterior.2K"),
        inputField("Extérieur 4K", "resolution_pricing.uplifts_by_category.exterior.4K"),
        inputField("Intérieur 2K", "resolution_pricing.uplifts_by_category.interior.2K"),
        inputField("Intérieur 4K", "resolution_pricing.uplifts_by_category.interior.4K")
      ]);

      addGroup("Résolution - unités aériennes (HD/2K/4K)", [
        inputField("HD palier 1", "resolution_pricing.per_resolution_units.aerial.HD.0"),
        inputField("HD palier 2", "resolution_pricing.per_resolution_units.aerial.HD.1"),
        inputField("HD palier 3", "resolution_pricing.per_resolution_units.aerial.HD.2"),
        inputField("HD palier 4", "resolution_pricing.per_resolution_units.aerial.HD.3"),
        inputField("2K palier 1", "resolution_pricing.per_resolution_units.aerial.2K.0"),
        inputField("2K palier 2", "resolution_pricing.per_resolution_units.aerial.2K.1"),
        inputField("2K palier 3", "resolution_pricing.per_resolution_units.aerial.2K.2"),
        inputField("2K palier 4", "resolution_pricing.per_resolution_units.aerial.2K.3"),
        inputField("4K palier 1", "resolution_pricing.per_resolution_units.aerial.4K.0"),
        inputField("4K palier 2", "resolution_pricing.per_resolution_units.aerial.4K.1"),
        inputField("4K palier 3", "resolution_pricing.per_resolution_units.aerial.4K.2"),
        inputField("4K palier 4", "resolution_pricing.per_resolution_units.aerial.4K.3")
      ]);

      addGroup("Résolution - unités extérieures (HD/2K/4K)", [
        inputField("HD palier 1", "resolution_pricing.per_resolution_units.exterior.HD.0"),
        inputField("HD palier 2", "resolution_pricing.per_resolution_units.exterior.HD.1"),
        inputField("HD palier 3", "resolution_pricing.per_resolution_units.exterior.HD.2"),
        inputField("HD palier 4", "resolution_pricing.per_resolution_units.exterior.HD.3"),
        inputField("2K palier 1", "resolution_pricing.per_resolution_units.exterior.2K.0"),
        inputField("2K palier 2", "resolution_pricing.per_resolution_units.exterior.2K.1"),
        inputField("2K palier 3", "resolution_pricing.per_resolution_units.exterior.2K.2"),
        inputField("2K palier 4", "resolution_pricing.per_resolution_units.exterior.2K.3"),
        inputField("4K palier 1", "resolution_pricing.per_resolution_units.exterior.4K.0"),
        inputField("4K palier 2", "resolution_pricing.per_resolution_units.exterior.4K.1"),
        inputField("4K palier 3", "resolution_pricing.per_resolution_units.exterior.4K.2"),
        inputField("4K palier 4", "resolution_pricing.per_resolution_units.exterior.4K.3")
      ]);

      addGroup("Résolution - unités intérieures (HD/2K/4K)", [
        inputField("HD palier 1", "resolution_pricing.per_resolution_units.interior.HD.0"),
        inputField("HD palier 2", "resolution_pricing.per_resolution_units.interior.HD.1"),
        inputField("HD palier 3", "resolution_pricing.per_resolution_units.interior.HD.2"),
        inputField("HD palier 4", "resolution_pricing.per_resolution_units.interior.HD.3"),
        inputField("2K palier 1", "resolution_pricing.per_resolution_units.interior.2K.0"),
        inputField("2K palier 2", "resolution_pricing.per_resolution_units.interior.2K.1"),
        inputField("2K palier 3", "resolution_pricing.per_resolution_units.interior.2K.2"),
        inputField("2K palier 4", "resolution_pricing.per_resolution_units.interior.2K.3"),
        inputField("4K palier 1", "resolution_pricing.per_resolution_units.interior.4K.0"),
        inputField("4K palier 2", "resolution_pricing.per_resolution_units.interior.4K.1"),
        inputField("4K palier 3", "resolution_pricing.per_resolution_units.interior.4K.2"),
        inputField("4K palier 4", "resolution_pricing.per_resolution_units.interior.4K.3")
      ]);

      addGroup("Multiplicateurs", [
        inputField("Complexité simple", "multipliers.complexity.simple"),
        inputField("Complexité standard", "multipliers.complexity.standard"),
        inputField("Complexité complexe", "multipliers.complexity.complex"),
        inputField("Détails concept", "multipliers.details.concept"),
        inputField("Détails réaliste", "multipliers.details.realistic"),
        inputField("Détails photoréaliste", "multipliers.details.photoreal"),
        inputField("Délai standard", "multipliers.delay.standard"),
        inputField("Délai express", "multipliers.delay.express"),
        inputField("Délai urgent", "multipliers.delay.urgent"),
        inputField("Usage perso", "multipliers.usage.personal"),
        inputField("Usage commercial", "multipliers.usage.commercial"),
        inputField("Usage publicité", "multipliers.usage.ads"),
        inputField("Topographie plate", "multipliers.topography.flat"),
        inputField("Topographie modérée", "multipliers.topography.mild"),
        inputField("Topographie complexe", "multipliers.topography.complex"),
        inputField("Circulation simple", "multipliers.circulation.simple"),
        inputField("Circulation standard", "multipliers.circulation.standard"),
        inputField("Circulation complexe", "multipliers.circulation.complex"),
        inputField("Paysage faible", "multipliers.landscape.low"),
        inputField("Paysage moyen", "multipliers.landscape.medium"),
        inputField("Paysage élevé", "multipliers.landscape.high")
      ]);

      addGroup("Options", [
        inputField("Moodboard", "options.moodboard"),
        inputField("Plan 2D", "options.plan2d"),
        inputField("Liste shopping", "options.shopping"),
        inputField("Modélisation (%)", "options.modeling_pct"),
        inputField("Mobilier (%)", "options.furniture_pct"),
        inputField("Paysage (%)", "options.landscape_pct"),
        inputField("Fichiers sources (%)", "options.sources_pct"),
        inputField("Animation / seconde", "options.animation_sec")
      ]);

      addGroup("Retours & minimum", [
        inputField("Cycles inclus", "revisions.included"),
        inputField("Majoration retours", "revisions.rate"),
        inputField("Minimum facturé", "minimum")
      ]);

      addGroup("Typologies", [
        inputField("Création simple", "typologies.complexity_costs.simple"),
        inputField("Création standard", "typologies.complexity_costs.standard"),
        inputField("Création complexe", "typologies.complexity_costs.complex"),
        selectField("Duplication", "typologies.duplication_mode", [
          { value: "fixed", label: "Fixe" },
          { value: "tiered", label: "Par paliers" }
        ]),
        inputField("Duplication simple", "typologies.duplication_fee.simple"),
        inputField("Duplication standard", "typologies.duplication_fee.standard"),
        inputField("Duplication complexe", "typologies.duplication_fee.complex"),
        inputField("Variation (%)", "typologies.variation_value"),
        selectField("Variation (scope)", "typologies.variation_scope", [
          { value: "per_typology", label: "Par typologie" },
          { value: "per_instance", label: "Par instance" }
        ]),
        inputField("Catégories (séparées par ,)", "typologies.categories", "text", "list")
      ]);

      addGroup("Duplication - paliers", [
        inputField("Jusqu'à 5", "typologies.duplication_tiers.0.unit"),
        inputField("Jusqu'à 12", "typologies.duplication_tiers.1.unit"),
        inputField("Au-delà", "typologies.duplication_tiers.2.unit")
      ]);

      addGroup("TVA & conversion", [
        inputField("Ajouter TVA", "vat_enabled", "checkbox", "boolean"),
        inputField("TVA (%)", "vat_rate"),
        inputField("Taux EUR → MGA", "eur_mga_rate")
      ]);

      addGroup("Toggles", [inputField("Tiers m²", "toggles.enable_tiered_m2", "checkbox", "boolean")]);

      addGroup("Presets", [
        `<div>
          <label>Définitions des presets (JSON)</label>
          <textarea data-json="presets" rows="8"></textarea>
          <span class="helper">Chaque preset contient un nom et un tableau de modules (type, valeurs par défaut, rendus...).</span>
        </div>`
      ]);

      elements.settingsForm.innerHTML = form.join("");

      elements.settingsForm.querySelectorAll("input[data-path], select[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let value = CONFIG;
        path.forEach(key => {
          value = value?.[key];
        });
        if (input.type === "checkbox") {
          input.checked = Boolean(value);
        } else if (input.dataset.fieldType === "list") {
          input.value = Array.isArray(value) ? value.join(", ") : "";
        } else {
          input.value = value ?? "";
        }
      });

      elements.settingsForm.querySelectorAll("textarea[data-json]").forEach(area => {
        const key = area.dataset.json;
        area.value = JSON.stringify(CONFIG[key] || [], null, 2);
      });
    }

    function readSettingsForm() {
      elements.settingsForm.querySelectorAll("input[data-path], select[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let target = CONFIG;
        for (let i = 0; i < path.length - 1; i++) {
          target = target[path[i]];
        }
        const key = path[path.length - 1];
        if (input.dataset.fieldType === "list") {
          target[key] = input.value
            .split(",")
            .map(item => item.trim())
            .filter(Boolean);
        } else if (input.type === "checkbox") {
          target[key] = input.checked;
        } else if (input.dataset.fieldType === "string") {
          target[key] = input.value;
        } else {
          target[key] = toNumberSafe(input.value, 0);
        }
      });
      elements.settingsForm.querySelectorAll("textarea[data-json]").forEach(area => {
        const key = area.dataset.json;
        try {
          const parsed = JSON.parse(area.value);
          CONFIG[key] = parsed;
        } catch (error) {
          showToast("JSON de preset invalide.");
        }
      });
      resetCalcWarnings();
      CONFIG = sanitizeConfigPresets(CONFIG);
      const hadAdjustments = calcWarningState.adjusted;
      saveConfig();
      buildPresetSelect();
      calculateAndRender({ adjusted: hadAdjustments });
    }

    function openSettings() {
      buildSettingsForm();
      elements.settingsOverlay.style.display = "flex";
    }

    function closeSettings(event) {
      if (event.target === elements.settingsOverlay) {
        elements.settingsOverlay.style.display = "none";
      }
    }

    function openBilling() {
      elements.billingOverlay.style.display = "flex";
      if (!BILLING.client.client_name && UI_STATE.clientName) {
        BILLING.client.client_name = UI_STATE.clientName;
      }
      if (!BILLING.invoice.notes) {
        const referenceLine = UI_STATE.clientName ? `Référence : ${UI_STATE.clientName}` : "";
        BILLING.invoice.notes = [referenceLine, "Merci pour votre confiance."].filter(Boolean).join("\n");
      }
      if (UI_STATE.clientName && (!Array.isArray(BILLING.customFields) || BILLING.customFields.length === 0)) {
        BILLING.customFields = [{ label: "Référence", value: UI_STATE.clientName }];
      }
      saveBilling();
      ensureInvoiceDefaults();
      applyBillingState();
      updateInvoicePreview();
    }

    function closeBilling(event) {
      if (event.target === elements.billingOverlay) {
        elements.billingOverlay.style.display = "none";
      }
    }

    function exportConfig() {
      const blob = new Blob([JSON.stringify(CONFIG, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "config_devis.json";
      link.click();
    }

    function exportSnapshot() {
      syncBillingFromForm();
      const payload = {
        version: 2,
        exported_at: new Date().toISOString(),
        parameters: clone(CONFIG),
        inputs: {
          ui: clone({ ...UI_STATE, clientName: elements.clientName.value }),
          billing: clone(BILLING)
        }
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "devis_parametres_champs.json";
      link.click();
    }

    function importConfig(file) {
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          resetCalcWarnings();
          CONFIG = migrateConfig(data);
          CONFIG = sanitizeConfigPresets(CONFIG);
          const hadAdjustments = calcWarningState.adjusted;
          saveConfig();
          buildSettingsForm();
          buildPresetSelect();
          calculateAndRender({ adjusted: hadAdjustments });
        } catch (error) {
          showToast("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function importSnapshot(file) {
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.parameters || !data.inputs) throw new Error("JSON invalide");
          const snapshotParameters = { ...(data.parameters || {}) };
          resetCalcWarnings();
          CONFIG = migrateConfig(snapshotParameters);
          CONFIG = sanitizeConfigPresets(CONFIG);
          const incomingUi = { ...UI_DEFAULT, ...(data.inputs.ui || {}) };
          if (!incomingUi.modules || data.version === 1) {
            if (incomingUi.form) {
              incomingUi.modules = [migrateLegacyFormToModule(incomingUi.form)];
            } else {
              incomingUi.modules = [createModule("masterplan")];
            }
          }
          UI_STATE = sanitizeState(incomingUi);
          const hadAdjustments = calcWarningState.adjusted;
          BILLING = {
            ...clone(BILLING_DEFAULT),
            ...(data.inputs.billing || {}),
            issuer: { ...BILLING_DEFAULT.issuer, ...(data.inputs.billing?.issuer || {}) },
            client: { ...BILLING_DEFAULT.client, ...(data.inputs.billing?.client || {}) },
            invoice: { ...BILLING_DEFAULT.invoice, ...(data.inputs.billing?.invoice || {}) },
            customFields: Array.isArray(data.inputs.billing?.customFields) ? data.inputs.billing.customFields : []
          };
          saveConfig();
          saveUIState();
          saveBilling();
          buildSettingsForm();
          applyUIState();
          applyBillingState();
          updateInvoicePreview();
          calculateAndRender({ adjusted: hadAdjustments });
        } catch (error) {
          showToast("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function formatInvoiceDate(dateValue) {
      if (!dateValue) return "—";
      const [year, month, day] = dateValue.split("-");
      return `${day}/${month}/${year}`;
    }

    function buildInvoiceLines(project, showDetails) {
      const showTva = CONFIG.vat_enabled ?? false;
      const lines = [];
      project.modules.forEach(module => {
        const moduleState = UI_STATE.modules.find(item => item.id === module.id);
        const renderCounts = moduleState
          ? Object.entries(moduleState.renders)
              .filter(([, value]) => Number(value) > 0)
              .map(([category, value]) => `${RENDER_LABELS[category] || category}: ${value}`)
              .join(" / ")
          : "";
        const label = `${module.name || MODULE_LABELS[module.type]} — ${module.resolution}`;
        lines.push({ label, amount: module.total });
        if (showDetails) {
          lines.push({ label: "— Base", amount: module.base });
          lines.push({ label: "— Production", amount: module.production });
          if (renderCounts) {
            lines.push({ label: `— Rendus: ${renderCounts}`, amount: null });
          }
          if (module.options) lines.push({ label: "— Options", amount: module.options });
          if (module.revisions) lines.push({ label: "— Retours", amount: module.revisions });
        }
      });
      if (showTva) {
        lines.push({ label: `TVA (${project.tvaRate}%)`, amount: project.tvaAmount });
      }
      return lines;
    }

    function buildInvoiceMarkup(project) {
      ensureInvoiceDefaults();
      const showDetails = BILLING.invoice.show_details ?? true;
      const showTva = CONFIG.vat_enabled ?? false;
      const lines = buildInvoiceLines(project, showDetails);
      const totalLabel = showTva ? "Total TTC" : "Total HT";
      const totalValue = showTva ? project.totalTtc : project.totalFinal;

      const issuerLines = [
        BILLING.issuer.company_name,
        BILLING.issuer.company_address,
        BILLING.issuer.company_postal,
        BILLING.issuer.company_country,
        BILLING.issuer.company_phone,
        BILLING.issuer.company_nif,
        BILLING.issuer.company_email
      ].filter(Boolean).map(escapeHtml);
      const clientLines = [
        BILLING.client.client_name,
        BILLING.client.client_address,
        BILLING.client.client_postal,
        BILLING.client.client_country,
        BILLING.client.client_phone,
        BILLING.client.client_nif,
        BILLING.client.client_email
      ].filter(Boolean).map(escapeHtml);

      const customFields = BILLING.customFields
        .filter(field => field.label || field.value)
        .map(
          field =>
            `<div class="invoice-card"><h4>${escapeHtml(field.label || "Champ")}</h4><div>${escapeHtml(field.value || "—")}</div></div>`
        )
        .join("");

      const isDraft = !BILLING.invoice.invoice_number;
      const safeInvoiceNumber = escapeHtml(BILLING.invoice.invoice_number || "");
      const safeInvoiceDate = escapeHtml(formatInvoiceDate(BILLING.invoice.invoice_date));
      const safeDueDate = escapeHtml(formatInvoiceDate(BILLING.invoice.due_date));

      return `
        <div class="invoice">
          <div class="invoice-hero">
            <div class="invoice-brand">
              <div class="invoice-logo">3D</div>
              <div>
                <span>Studio visuels</span>
                <strong>Design & Rendus</strong>
                <span>Facture professionnelle</span>
              </div>
            </div>
            <div class="invoice-meta">
              <div class="invoice-status ${isDraft ? "is-draft" : ""}">
                ${isDraft ? "Brouillon" : "Prêt"}
              </div>
              <div class="invoice-meta-grid">
                <div class="invoice-meta-item">
                  <strong>Numéro</strong>
                  ${safeInvoiceNumber || "—"}
                </div>
                <div class="invoice-meta-item">
                  <strong>Date</strong>
                  ${safeInvoiceDate}
                </div>
                <div class="invoice-meta-item">
                  <strong>Échéance</strong>
                  ${safeDueDate}
                </div>
              </div>
            </div>
          </div>
          <div class="invoice-card-grid">
            <div class="invoice-card">
              <h4>Émetteur</h4>
              <div>${issuerLines.length ? issuerLines.join("<br />") : "—"}</div>
            </div>
            <div class="invoice-card">
              <h4>Client</h4>
              <div>${clientLines.length ? clientLines.join("<br />") : "—"}</div>
            </div>
            <div class="invoice-total-card">
              <span>${totalLabel}</span>
              <div class="invoice-total-amount">${formatCurrency(totalValue)}</div>
              <div>${showTva ? "TVA incluse" : "Montant HT"}</div>
            </div>
          </div>
          <table class="invoice-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Montant</th>
              </tr>
            </thead>
            <tbody>
              ${lines
                .map(line => {
                  const amount =
                    line.amount === null || line.amount === undefined ? "—" : formatCurrency(line.amount);
                  return `<tr><td>${escapeHtml(line.label)}</td><td>${amount}</td></tr>`;
                })
                .join("")}
              <tr class="invoice-total">
                <td>${totalLabel}</td>
                <td>${formatCurrency(totalValue)}</td>
              </tr>
            </tbody>
          </table>
          <div class="invoice-footer">
            ${BILLING.invoice.notes ? `<div class="invoice-note">${escapeHtml(BILLING.invoice.notes)}</div>` : ""}
            ${customFields ? `<div class="invoice-card-grid">${customFields}</div>` : ""}
          </div>
        </div>
      `;
    }

    function buildInvoiceDocument(markup) {
      const invoiceTitle = escapeHtml(BILLING.invoice.invoice_number || "");
      return `
        <!DOCTYPE html>
        <html lang="fr">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Facture ${invoiceTitle}</title>
            <style>
              body { font-family: "Segoe UI", "Inter", sans-serif; margin: 32px; color: #0f172a; background: #f8fafc; }
              .invoice { display: flex; flex-direction: column; gap: 12px; padding: 20px; border-radius: 0; background: rgba(255, 255, 255, 0.92); border: 1px solid #e2e8f0; box-shadow: 0 16px 28px rgba(15, 23, 42, 0.08); }
              .invoice-hero { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; padding: 12px 14px; border-radius: 0; background: #ffffff; border: 1px solid #e2e8f0; }
              .invoice-brand { display: flex; align-items: center; gap: 12px; min-width: 220px; }
              .invoice-logo { width: 46px; height: 46px; border-radius: 0; background: #ffffff; display: grid; place-items: center; font-weight: 700; color: #1d4ed8; box-shadow: 0 6px 12px rgba(15, 23, 42, 0.12); }
              .invoice-brand span { display: block; font-size: 0.75rem; color: #475569; }
              .invoice-brand strong { font-size: 1.05rem; display: block; }
              .invoice-meta { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
              .invoice-status { padding: 6px 12px; border-radius: 0; background: #ccfbf1; color: #0f766e; font-weight: 600; font-size: 0.8rem; }
              .invoice-status.is-draft { background: #fee2e2; color: #b91c1c; }
              .invoice-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; width: min(360px, 100%); }
              .invoice-meta-item { padding: 8px 10px; border-radius: 0; background: #ffffff; border: 1px solid #e2e8f0; font-size: 0.82rem; }
              .invoice-meta-item strong { display: block; font-size: 0.72rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px; }
              .invoice-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
              .invoice-card { padding: 10px 12px; border-radius: 0; background: #ffffff; border: 1px solid #e2e8f0; }
              .invoice-card h4 { margin: 0 0 6px; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
              .invoice-total-card { padding: 12px; border-radius: 0; background: #f1f5f9; border: 1px solid #dbeafe; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; text-align: right; }
              .invoice-total-card span { font-size: 0.8rem; color: #1d4ed8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
              .invoice-total-amount { font-size: 1.6rem; font-weight: 700; }
              .invoice-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
              .invoice-table th, .invoice-table td { padding: 8px 6px; border-bottom: 1px solid #e2e8f0; text-align: left; }
              .invoice-table th { background: #ffffff; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.05em; color: #334155; }
              .invoice-table td:last-child, .invoice-table th:last-child { text-align: right; }
              .invoice-total { font-weight: 700; font-size: 1rem; }
              .invoice-total td { border-top: 1px solid #cbd5f5; }
              .invoice-footer { display: flex; flex-direction: column; gap: 10px; }
              .invoice-note { font-size: 0.85rem; color: #64748b; white-space: pre-wrap; }
              @media print {
                body { padding: 0; background: #fff !important; }
                .settings-overlay { position: static; inset: auto; background: none; }
                .billing-panel { box-shadow: none; }
                .invoice { box-shadow: none; border: none; break-inside: avoid; page-break-inside: avoid; }
                button, .billing-actions { display: none !important; }
              }
            </style>
          </head>
          <body>
            ${markup}
          </body>
        </html>
      `;
    }

    function updateInvoicePreview() {
      const project = calculateProject();
      const markup = buildInvoiceMarkup(project);
      elements.invoicePreview.innerHTML = markup;
      elements.invoiceStatus.textContent = BILLING.invoice.invoice_number ? "Prêt" : "Brouillon";
    }

    function copyInvoice() {
      const markup = buildInvoiceMarkup(calculateProject());
      const html = buildInvoiceDocument(markup);
      navigator.clipboard.writeText(html).then(() => showToast("Facture copiée."));
    }

    function downloadInvoice() {
      const markup = buildInvoiceMarkup(calculateProject());
      const html = buildInvoiceDocument(markup);
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `facture_${new Date().toISOString().slice(0, 10)}.html`;
      link.click();
    }

    function printInvoice() {
      const markup = buildInvoiceMarkup(calculateProject());
      const html = buildInvoiceDocument(markup);
      const printWindow = window.open("", "_blank");
      if (!printWindow) {
        showToast("Impossible d'ouvrir la fenêtre d'impression.");
        return;
      }
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    function buildPresetSelect() {
      elements.presetSelect.innerHTML = CONFIG.presets
        .map((preset, index) => `<option value="${index}">${escapeHtml(preset.name)}</option>`)
        .join("");
    }

    function init() {
      setCurrency(UI_STATE.currency);
      const hasStoredUi = Boolean(localStorage.getItem("tk_quote_calc_ui_v1"));
      const deliverablesMedia = window.matchMedia("(max-width: 980px)");
      if (!hasStoredUi && deliverablesMedia.matches) {
        UI_STATE.deliverablesExpanded = false;
      }
      setDeliverablesExpanded(UI_STATE.deliverablesExpanded);
      setSummaryExpanded(UI_STATE.summaryExpanded);
      deliverablesMedia.addEventListener("change", event => {
        if (!event.matches) {
          setDeliverablesExpanded(true);
        } else if (!hasStoredUi) {
          setDeliverablesExpanded(false);
        }
      });
      applyBillingState();
      applyUIState();
      buildSettingsForm();
      debouncedCalculateAndRender = debounce(() => calculateAndRender(), 70);

      elements.clientName.addEventListener("input", event => {
        UI_STATE.clientName = event.target.value;
        saveUIState();
      });

      elements.currencyMga.addEventListener("click", () => setCurrency("MGA"));
      elements.currencyEur.addEventListener("click", () => setCurrency("EUR"));
      elements.openSettings.addEventListener("click", openSettings);
      elements.settingsOverlay.addEventListener("click", closeSettings);
      elements.openBilling.addEventListener("click", openBilling);
      elements.billingOverlay.addEventListener("click", closeBilling);
      elements.saveConfig.addEventListener("click", () => {
        readSettingsForm();
        elements.settingsOverlay.style.display = "none";
      });
      elements.resetConfig.addEventListener("click", resetConfig);
      elements.exportConfig.addEventListener("click", exportConfig);
      elements.importConfig.addEventListener("change", event => {
        if (event.target.files[0]) importConfig(event.target.files[0]);
      });
      elements.exportSnapshot.addEventListener("click", exportSnapshot);
      elements.importSnapshot.addEventListener("change", event => {
        if (event.target.files[0]) importSnapshot(event.target.files[0]);
      });
      elements.copyInvoice.addEventListener("click", copyInvoice);
      elements.downloadInvoice.addEventListener("click", downloadInvoice);
      elements.printInvoice.addEventListener("click", printInvoice);
      elements.deliverablesToggle.addEventListener("click", () =>
        setDeliverablesExpanded(!UI_STATE.deliverablesExpanded)
      );
      elements.summaryToggle.addEventListener("click", () => setSummaryExpanded(!UI_STATE.summaryExpanded));

      elements.addModule.addEventListener("click", () => {
        UI_STATE.modules.push(createModule("masterplan"));
        renderModules();
        debouncedCalculateAndRender();
      });
      elements.applyPreset.addEventListener("click", () => {
        const presetIndex = Number(elements.presetSelect.value) || 0;
        const preset = CONFIG.presets[presetIndex];
        if (!preset) return;
        resetCalcWarnings();
        const sanitizedPreset = sanitizeState({ modules: preset.modules });
        const hadAdjustments = calcWarningState.adjusted;
        UI_STATE.modules = sanitizedPreset.modules;
        renderModules();
        calculateAndRender({ adjusted: hadAdjustments });
      });

      [
        elements.companyName,
        elements.companyAddress,
        elements.companyCountry,
        elements.companyPostal,
        elements.companyPhone,
        elements.companyNif,
        elements.companyEmail,
        elements.clientBillingName,
        elements.clientBillingAddress,
        elements.clientBillingCountry,
        elements.clientBillingPostal,
        elements.clientBillingPhone,
        elements.clientBillingNif,
        elements.clientBillingEmail,
        elements.invoiceNumber,
        elements.invoiceDate,
        elements.invoiceDueDate,
        elements.invoiceNotes,
        elements.invoiceShowDetails
      ].forEach(input => {
        input.addEventListener("input", () => {
          syncBillingFromForm();
          updateInvoicePreview();
        });
        input.addEventListener("change", () => {
          syncBillingFromForm();
          updateInvoicePreview();
        });
      });

      elements.addCustomField.addEventListener("click", () => {
        BILLING.customFields.push({ label: "", value: "" });
        saveBilling();
        renderCustomFields();
        updateInvoicePreview();
      });

      document.addEventListener("keydown", event => {
        if (event.key !== "Escape") return;
        if (elements.settingsOverlay.style.display === "flex") {
          elements.settingsOverlay.style.display = "none";
        }
        if (elements.billingOverlay.style.display === "flex") {
          elements.billingOverlay.style.display = "none";
        }
      });

      calculateAndRender();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
