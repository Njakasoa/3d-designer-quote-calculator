```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de devis ‚Äî Syst√®me modulaire</title>
  <meta name="description" content="App HTML5 de devis modulaire (mode client/admin, devise MGA/‚Ç¨, taux manuel, tarifs d√©gressifs, facture imprimable)." />
  <style>
    :root{
      --bg-1:#e6f0ff;
      --bg-2:#d8dcff;
      --bg-3:#f3f7ff;
      --bg-4:#d3f4ff;

      --text:#0f172a;
      --muted:#475569;

      --glass: rgba(255,255,255,.35);
      --glass-strong: rgba(255,255,255,.62);
      --border: rgba(255,255,255,.55);
      --shadow: 0 18px 45px rgba(15,23,42,.16);
      --shadow-soft: 0 12px 28px rgba(15,23,42,.10);

      --radius: 18px;
      --radius-lg: 26px;

      --focus: rgba(59,130,246,.55);
      --danger: #ef4444;
      --ok:#10b981;
      --warn:#f59e0b;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 8% 12%, var(--bg-4), transparent 60%),
        radial-gradient(900px 700px at 92% 18%, var(--bg-2), transparent 58%),
        radial-gradient(900px 700px at 30% 88%, var(--bg-1), transparent 55%),
        linear-gradient(180deg, var(--bg-3), #ffffff 48%, var(--bg-3));
      overflow-x:hidden;
    }

    a{ color:inherit; }
    button, input, select, textarea{
      font:inherit;
    }
    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    /* Glass primitives */
    .glass{
      background: var(--glass);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--radius-lg);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.38));
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--radius);
    }

    /* Header */
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 18px 18px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .brand .sub{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.3;
    }

    .top-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.42);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
    }
    .pill label{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill input, .pill select{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.65);
      border-radius: 10px;
      padding: 7px 10px;
      outline: none;
      min-width: 120px;
    }
    .pill input:focus, .pill select:focus{
      box-shadow: 0 0 0 4px var(--focus);
    }

    .seg{
      display:flex;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.55);
    }
    .seg button{
      border:0;
      background: transparent;
      padding: 9px 12px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      color: rgba(15,23,42,.78);
    }
    .seg button[aria-pressed="true"]{
      background: rgba(255,255,255,.9);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.10);
      color: rgba(15,23,42,.95);
    }
    .btn{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.7);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(15,23,42,.08);
      font-weight: 700;
      font-size: 12px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: rgba(255,255,255,.92);
      border-color: rgba(59,130,246,.30);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
    }
    .btn:focus{
      outline:none;
      box-shadow: 0 0 0 4px var(--focus), 0 10px 20px rgba(15,23,42,.08);
    }

    /* Layout */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.35fr .9fr;
      gap: 14px;
      align-items:start;
    }

    /* Left: modules */
    .section{
      padding: 16px;
    }
    .section h2{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .section .hint{
      margin:0 0 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .module-list{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .module-card{
      padding: 14px;
    }
    .module-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .module-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .module-title .name{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: .2px;
      line-height:1.2;
    }
    .module-title .desc{
      font-size: 12px;
      color: var(--muted);
      line-height:1.3;
    }
    .badge{
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .2px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.62);
      white-space:nowrap;
    }

    .module-body{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.55);
      min-height: 44px;
    }
    .field .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      white-space:nowrap;
    }
    .field .control{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      width: 60%;
    }
    .field select, .field input{
      width: 100%;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
      border-radius: 12px;
      padding: 8px 10px;
      outline:none;
      font-weight: 700;
      color: rgba(15,23,42,.92);
    }
    .field select:focus, .field input:focus{ box-shadow: 0 0 0 4px var(--focus); }
    .mini{
      width: 100%;
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
    }
    .step{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.82);
      cursor:pointer;
      font-weight: 900;
      display:grid;
      place-items:center;
    }
    .qty{
      width: 72px !important;
      text-align:center;
    }
    .switch{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:space-between;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.55);
      grid-column: 1 / -1;
    }
    .switch .label{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .switch .label strong{ font-size: 12px; }
    .switch .label span{ font-size: 11px; color: var(--muted); }
    .toggle{
      width: 54px; height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .toggle::after{
      content:"";
      position:absolute;
      top: 4px; left: 4px;
      width: 24px; height: 24px;
      border-radius: 999px;
      background: rgba(15,23,42,.90);
      box-shadow: 0 8px 18px rgba(15,23,42,.18);
      transition: transform .16s ease;
    }
    .toggle[aria-checked="true"]::after{
      transform: translateX(22px);
    }

    .admin-row{
      display:flex;
      gap: 8px;
      justify-content:flex-end;
      margin-top: 10px;
    }

    /* Right: summary */
    .summary{
      padding: 16px;
      position: sticky;
      top: 14px;
    }
    .summary h2{
      margin:0 0 10px;
      font-size: 14px;
    }
    .summary .name-row{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-bottom: 12px;
    }
    .summary .name-row input{
      flex:1;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.68);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 800;
    }
    .summary .name-row input:focus{
      box-shadow: 0 0 0 4px var(--focus);
    }
    .summary .meta{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin: 10px 0 12px;
      padding: 0;
      list-style:none;
    }
    .line{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.55);
      align-items:flex-start;
    }
    .line .left{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .line .left .t{
      font-weight: 900;
      font-size: 12px;
      line-height:1.2;
    }
    .line .left .s{
      font-size: 11px;
      color: var(--muted);
      line-height:1.25;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 300px;
    }
    .line .amt{
      font-weight: 950;
      font-size: 12px;
      white-space:nowrap;
    }

    .totals{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(15,23,42,.10);
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .tot-row{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      font-size: 12px;
      color: rgba(15,23,42,.88);
      font-weight: 800;
    }
    .tot-row small{
      font-weight: 800;
      color: var(--muted);
    }
    .grand{
      font-size: 14px;
      font-weight: 950;
    }

    .summary-controls{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .summary-controls .btn{
      width:100%;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap: 8px;
      padding: 11px 12px;
      border-radius: 16px;
    }
    .wide{ grid-column: 1 / -1; }

    /* Compact settings row */
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: min(420px, calc(100% - 32px));
      display:flex;
      flex-direction:column;
      gap: 8px;
      z-index: 60;
      pointer-events:none;
    }
    .toast .t{
      pointer-events:auto;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow-soft);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .toast .t strong{ font-size: 12px; }
    .toast .t span{ font-size: 12px; color: var(--muted); display:block; margin-top: 2px; }
    .toast .t button{
      border:0; background: transparent; cursor:pointer; font-weight: 900;
      padding: 2px 6px; border-radius: 8px;
    }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 80;
    }
    .modal-backdrop[aria-hidden="false"]{ display:flex; }
    .modal{
      width: min(920px, 100%);
      max-height: min(86vh, 900px);
      overflow:auto;
      border-radius: 22px;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.58);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modal header{
      padding: 0;
      margin: 0 0 12px;
      border: 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .modal h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
    }
    .modal p{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .modal .x{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight: 950;
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .form .full{ grid-column: 1 / -1; }
    .form label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(15,23,42,.86);
    }
    .form input, .form textarea, .form select{
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight: 700;
      color: rgba(15,23,42,.92);
      resize: vertical;
    }
    .form textarea{ min-height: 82px; }
    .form input:focus, .form textarea:focus, .form select:focus{ box-shadow: 0 0 0 4px var(--focus); }

    .modal .actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .summary{ position: static; }
    }
    @media (max-width: 560px){
      header{ flex-direction:column; align-items:stretch; }
      .top-controls{ justify-content:flex-start; }
      .module-body{ grid-template-columns: 1fr; }
      .form{ grid-template-columns: 1fr; }
      .summary-controls{ grid-template-columns: 1fr; }
      .line .left .s{ max-width: 220px; }
    }

    /* Print helpers (invoice/devis window) */
    @media print{
      body{ background:#fff !important; }
      .no-print{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="glass">
      <div class="brand">
        <h1>Calculateur de devis ‚Äî Syst√®me modulaire</h1>
        <p class="sub">Mode client/admin ¬∑ Devis en MGA (Ariary) ou ‚Ç¨ ¬∑ Taux manuel ¬∑ Tarifs d√©gressifs ¬∑ Facture imprimable</p>
      </div>

      <div class="top-controls">
        <div class="pill" title="Devise d'affichage">
          <label>Devise</label>
          <div class="seg" role="group" aria-label="Devise">
            <button id="btnMGA" type="button" aria-pressed="true">MGA</button>
            <button id="btnEUR" type="button" aria-pressed="false">‚Ç¨</button>
          </div>
        </div>

        <div class="pill" title="Taux utilis√© si tu affiches en ‚Ç¨ (1‚Ç¨ = X MGA)">
          <label>Taux 1‚Ç¨ ‚Üí MGA</label>
          <input id="rateInput" inputmode="numeric" autocomplete="off" placeholder="ex: 4900" />
        </div>

        <button id="modeBtn" type="button" class="btn primary" title="Basculer client/admin">Mode : Client</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="section card" aria-label="Modules">
        <h2>Modules</h2>
        <p class="hint">
          Tu ajustes les quantit√©s et la complexit√© (S / M / L). Les remises d√©gressives se calculent automatiquement selon les seuils du module.
          En mode admin tu peux √©diter les prix, seuils, libell√©s, options‚Ä¶ (tout est stock√© en local).
        </p>

        <div id="moduleList" class="module-list"></div>
      </section>

      <!-- RIGHT -->
      <aside class="summary card" aria-label="R√©sum√© devis">
        <h2>R√©sum√©</h2>

        <div class="name-row">
          <input id="quoteName" type="text" placeholder="Nom du devis (ex: Devis ‚Äî Projet X)" />
          <span class="badge" id="modeBadge">Client</span>
        </div>

        <div class="meta">
          <span id="metaCurrency">Devise : MGA</span>
          <span>‚Ä¢</span>
          <span id="metaRate">Taux : 1‚Ç¨ = 4 900 MGA</span>
        </div>

        <ul id="lines" class="list"></ul>

        <div class="kv">
          <div class="field" title="Remise globale sur le sous-total (optionnel)">
            <div class="label">Remise globale</div>
            <div class="control">
              <input id="globalDiscountPct" class="qty" inputmode="numeric" placeholder="%" />
            </div>
          </div>

          <div class="field" title="TVA/Taxe (optionnel)">
            <div class="label">Taxe</div>
            <div class="control">
              <input id="taxPct" class="qty" inputmode="numeric" placeholder="%" />
            </div>
          </div>

          <div class="field" title="Acompte (optionnel)">
            <div class="label">Acompte</div>
            <div class="control">
              <input id="depositPct" class="qty" inputmode="numeric" placeholder="%" />
            </div>
          </div>

          <div class="field" title="Frais fixes (optionnel)">
            <div class="label">Frais fixes</div>
            <div class="control">
              <input id="fixedFees" inputmode="numeric" placeholder="0" />
            </div>
          </div>
        </div>

        <div class="totals" id="totals"></div>

        <div class="summary-controls">
          <button id="btnSave" type="button" class="btn">üíæ Sauvegarder</button>
          <button id="btnLoad" type="button" class="btn">üìÇ Charger</button>

          <button id="btnPrintQuote" type="button" class="btn">üñ®Ô∏è Imprimer devis</button>
          <button id="btnInvoice" type="button" class="btn primary">üßæ G√©n√©rer facture</button>

          <button id="btnExport" type="button" class="btn wide">‚¨áÔ∏è Export / Import</button>
          <button id="btnReset" type="button" class="btn danger wide">‚Ü©Ô∏è R√©initialiser</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- MODALS -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div>
          <h3 id="modalTitle">Modal</h3>
          <p id="modalDesc">‚Äî</p>
        </div>
        <button class="x" id="modalClose" type="button" aria-label="Fermer">‚úï</button>
      </header>
      <div id="modalBody"></div>
      <div class="actions" id="modalActions"></div>
    </div>
  </div>

  <script type="module">
    /* =========================================================================
      APP ‚Äî Syst√®me modulaire (tout en localStorage)
      Objectif: code propre, sans legacy, orient√© modules + rendu UI centralis√©.
    ========================================================================= */

    const App = (() => {
      const STORAGE_KEY = "tk_modular_quote_app_v2";
      const MAX_SAVES = 20;

      /** -----------------------------
       *  Utils
       *  ----------------------------- */
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const clamp = (n, min, max) => Math.min(max, Math.max(min, n));

      const safeNum = (v, fallback=0) => {
        const n = Number(String(v ?? "").replace(",", ".").trim());
        return Number.isFinite(n) ? n : fallback;
      };

      const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

      const nowISO = () => {
        const d = new Date();
        const pad = (x) => String(x).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      };

      const formatInt = (n) => {
        const nn = Math.round(n);
        return nn.toLocaleString("fr-FR");
      };

      const money = (amountMGA, state) => {
        const cur = state.currency;
        if (cur === "MGA") return `${formatInt(amountMGA)} MGA`;
        const rate = Math.max(1, state.rateEurToMga || 4900);
        const eur = amountMGA / rate;
        return `${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚Ç¨`;
      };

      const toast = (title, msg="", kind="info") => {
        const host = $("#toast");
        const el = document.createElement("div");
        el.className = "t";
        const icon = kind === "ok" ? "‚úÖ" : kind === "warn" ? "‚ö†Ô∏è" : kind === "danger" ? "‚õî" : "‚ú®";
        el.innerHTML = `
          <div>
            <strong>${icon} ${escapeHtml(title)}</strong>
            ${msg ? `<span>${escapeHtml(msg)}</span>` : ``}
          </div>
          <button type="button" aria-label="Fermer">‚úï</button>
        `;
        el.querySelector("button").addEventListener("click", () => el.remove());
        host.appendChild(el);
        setTimeout(() => { if (el.isConnected) el.remove(); }, 5200);
      };

      const escapeHtml = (s) => String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");

      /** -----------------------------
       *  Modal (simple + accessible)
       *  ----------------------------- */
      const Modal = (() => {
        const backdrop = $("#modalBackdrop");
        const titleEl = $("#modalTitle");
        const descEl = $("#modalDesc");
        const bodyEl = $("#modalBody");
        const actionsEl = $("#modalActions");
        const closeBtn = $("#modalClose");
        let lastFocus = null;

        const close = () => {
          backdrop.setAttribute("aria-hidden", "true");
          titleEl.textContent = "Modal";
          descEl.textContent = "‚Äî";
          bodyEl.innerHTML = "";
          actionsEl.innerHTML = "";
          document.body.style.overflow = "";
          if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
        };

        const open = ({ title, desc, body, actions=[] }) => {
          lastFocus = document.activeElement;
          titleEl.textContent = title || "Modal";
          descEl.textContent = desc || "";
          bodyEl.innerHTML = "";
          actionsEl.innerHTML = "";

          if (body instanceof HTMLElement) bodyEl.appendChild(body);
          else if (typeof body === "string") bodyEl.innerHTML = body;

          actions.forEach((a) => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "btn " + (a.variant || "");
            b.textContent = a.label || "OK";
            b.addEventListener("click", () => a.onClick?.(close));
            actionsEl.appendChild(b);
          });

          backdrop.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          setTimeout(() => {
            const focusable = bodyEl.querySelector("input,select,textarea,button");
            (focusable || closeBtn).focus();
          }, 0);
        };

        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) close();
        });
        closeBtn.addEventListener("click", close);
        document.addEventListener("keydown", (e) => {
          if (backdrop.getAttribute("aria-hidden") === "false" && e.key === "Escape") close();
        });

        return { open, close };
      })();

      /** -----------------------------
       *  Default modules (MGA)
       *  Tout est √©ditable en admin.
       *  ----------------------------- */
      const defaultModules = () => ([
        {
          id: "m_3d",
          group: "Production",
          name: "Rendu 3D",
          desc: "Visuels 3D (prix selon complexit√©).",
          model: "sized",                 // "flat" | "sized"
          unitLabel: "visuel",
          enabled: true,
          qty: 0,
          size: "M",                      // S/M/L
          prices: { S: 150000, M: 250000, L: 400000 }, // MGA
          setupFee: 0,                    // MGA (forfait)
          discountTiers: [                // d√©gressif selon quantit√©
            { minQty: 1, pct: 0 },
            { minQty: 3, pct: 10 },
            { minQty: 6, pct: 18 },
            { minQty: 10, pct: 25 }
          ],
          options: [
            { key: "variants", label: "Variantes / d√©clinaisons", kind: "perUnit", price: 35000, enabled: false, hint:"Par visuel (angle/couleur/it√©ration)." },
            { key: "rush", label: "Rush / priorit√©", kind: "percent", price: 20, enabled: false, hint:"+% sur le module." }
          ],
        },
        {
          id: "m_2d",
          group: "Production",
          name: "Visuels 2D / Design",
          desc: "Cr√©a 2D (affiche, post, banni√®re, etc.).",
          model: "sized",
          unitLabel: "pi√®ce",
          enabled: true,
          qty: 0,
          size: "M",
          prices: { S: 60000, M: 100000, L: 160000 },
          setupFee: 0,
          discountTiers: [
            { minQty: 1, pct: 0 },
            { minQty: 5, pct: 8 },
            { minQty: 10, pct: 15 },
            { minQty: 20, pct: 22 }
          ],
          options: [
            { key: "copy", label: "Copywriting l√©ger", kind: "flat", price: 80000, enabled: false, hint:"Forfait pour le module." },
            { key: "source", label: "Fichiers source", kind: "flat", price: 60000, enabled: false, hint:"Livraison des sources (si applicable)." }
          ],
        },
        {
          id: "m_video",
          group: "Production",
          name: "Montage vid√©o / Motion",
          desc: "Montage ou motion design (dur√©e + options).",
          model: "flat",
          unitLabel: "vid√©o",
          enabled: true,
          qty: 0,
          size: "M",
          prices: { S: 180000, M: 300000, L: 520000 }, // utilis√© si size active
          setupFee: 0,
          discountTiers: [
            { minQty: 1, pct: 0 },
            { minQty: 3, pct: 8 },
            { minQty: 6, pct: 15 }
          ],
          options: [
            { key: "filming", label: "Tournage inclus", kind: "flat", price: 250000, enabled: false, hint:"Forfait (logistique/prise de vue)." },
            { key: "subtitles", label: "Sous-titres", kind: "perUnit", price: 40000, enabled: false, hint:"Par vid√©o." }
          ],
        },
        {
          id: "m_web",
          group: "Technique",
          name: "Int√©gration / Web",
          desc: "Pages, sections, composants (prix selon complexit√©).",
          model: "sized",
          unitLabel: "√©l√©ment",
          enabled: true,
          qty: 0,
          size: "M",
          prices: { S: 120000, M: 220000, L: 380000 },
          setupFee: 0,
          discountTiers: [
            { minQty: 1, pct: 0 },
            { minQty: 4, pct: 8 },
            { minQty: 8, pct: 14 },
            { minQty: 12, pct: 20 }
          ],
          options: [
            { key: "seo", label: "Pack SEO technique", kind: "flat", price: 180000, enabled: false, hint:"Forfait (base technique + check)."},
            { key: "multilang", label: "Multilingue", kind: "percent", price: 15, enabled: false, hint:"+% sur le module." }
          ],
        }
      ]);

      /** -----------------------------
       *  State (persisted)
       *  ----------------------------- */
      const defaultState = () => ({
        version: "2.0.0",
        updatedAt: Date.now(),

        currency: "MGA",        // "MGA" | "EUR"
        rateEurToMga: 4900,

        mode: "client",         // "client" | "admin"
        adminPin: "",           // optionnel (si d√©fini, demande un code pour passer en admin)

        quote: {
          name: "Devis ‚Äî Nouveau projet",
          createdAt: nowISO(),
          globalDiscountPct: 0,
          taxPct: 0,
          depositPct: 0,
          fixedFees: 0
        },

        modules: defaultModules(),

        saved: [] , // {id, name, createdAt, snapshotQuote, snapshotModules, currency, rate}
        invoice: {
          // infos persist√©es
          billing: {
            companyName: "",
            fullName: "",
            address: "",
            country: "Madagascar",
            postalCode: "",
            phone: "",
            email: "",
            nif: "",
            stat: "",
          },
          client: {
            companyName: "",
            fullName: "",
            address: "",
            country: "",
            postalCode: "",
            phone: "",
            email: ""
          },
          settings: {
            nextInvoiceNumber: 1,
            paymentTerms: "Paiement √† r√©ception",
            notes: ""
          },
          customTerms: [
            "Acompte √† la commande (si applicable).",
            "Le solde √† la livraison.",
          ]
        }
      });

      const Storage = (() => {
        const load = () => {
          try{
            const raw = localStorage.getItem(STORAGE_KEY);
            if(!raw) return defaultState();
            const parsed = JSON.parse(raw);

            // Merge ‚Äúsafe‚Äù (minimal deep merge to avoid missing new keys)
            const base = defaultState();
            const merged = structuredClone(base);

            // Top-level merge
            for (const k of Object.keys(base)) {
              if (parsed[k] !== undefined) merged[k] = parsed[k];
            }

            // Ensure arrays exist
            if (!Array.isArray(merged.modules) || merged.modules.length === 0) merged.modules = base.modules;
            if (!Array.isArray(merged.saved)) merged.saved = [];
            if (!merged.invoice) merged.invoice = base.invoice;

            merged.updatedAt = Date.now();
            return merged;
          }catch(e){
            console.warn("Storage load failed:", e);
            return defaultState();
          }
        };

        const save = (state) => {
          try{
            const clean = structuredClone(state);
            clean.updatedAt = Date.now();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(clean));
          }catch(e){
            console.warn("Storage save failed:", e);
            toast("Impossible de sauvegarder", "V√©rifie l'espace localStorage (ou mode priv√©).", "warn");
          }
        };

        return { load, save };
      })();

      /** -----------------------------
       *  Pricing engine
       *  ----------------------------- */
      const Pricing = (() => {
        const tierPct = (module, qty) => {
          const tiers = Array.isArray(module.discountTiers) ? module.discountTiers : [];
          let best = 0;
          for (const t of tiers) {
            if (!t) continue;
            const minQty = safeNum(t.minQty, 0);
            const pct = safeNum(t.pct, 0);
            if (qty >= minQty) best = Math.max(best, pct);
          }
          return clamp(best, 0, 95);
        };

        const baseUnit = (module) => {
          const size = module.size || "M";
          const prices = module.prices || {};
          const p = safeNum(prices[size], 0);
          return Math.max(0, p);
        };

        const optionsCost = (module, qty, moduleSubtotalBeforePercent) => {
          let sum = 0;
          const opts = Array.isArray(module.options) ? module.options : [];
          for (const o of opts) {
            if (!o || !o.enabled) continue;
            const kind = o.kind || "flat";
            const price = safeNum(o.price, 0);

            if (kind === "flat") sum += Math.max(0, price);
            else if (kind === "perUnit") sum += Math.max(0, price) * Math.max(0, qty);
            else if (kind === "percent") sum += moduleSubtotalBeforePercent * (clamp(price, 0, 300) / 100);
          }
          return sum;
        };

        const moduleTotalMGA = (module) => {
          if (!module.enabled) return 0;

          const qty = Math.max(0, Math.floor(safeNum(module.qty, 0)));
          if (qty === 0) return 0;

          const unit = baseUnit(module);
          const dPct = tierPct(module, qty);
          const unitAfter = unit * (1 - dPct / 100);

          const setupFee = Math.max(0, safeNum(module.setupFee, 0));
          const beforePercent = unitAfter * qty + setupFee;

          const optCost = optionsCost(module, qty, beforePercent);
          const total = beforePercent + optCost;

          return Math.max(0, total);
        };

        const moduleLineDetails = (module) => {
          const qty = Math.max(0, Math.floor(safeNum(module.qty, 0)));
          const unit = baseUnit(module);
          const dPct = tierPct(module, qty);
          const unitAfter = unit * (1 - dPct / 100);
          const setupFee = Math.max(0, safeNum(module.setupFee, 0));

          const optFlat = (() => {
            let sum = 0;
            for (const o of (module.options||[])) {
              if (!o?.enabled) continue;
              const kind = o.kind || "flat";
              const price = safeNum(o.price, 0);
              if (kind === "flat") sum += Math.max(0, price);
              if (kind === "perUnit") sum += Math.max(0, price) * qty;
            }
            return sum;
          })();

          const beforePercent = unitAfter * qty + setupFee + optFlat;

          const optPercent = (() => {
            let sum = 0;
            for (const o of (module.options||[])) {
              if (!o?.enabled) continue;
              if ((o.kind||"") !== "percent") continue;
              sum += beforePercent * (clamp(safeNum(o.price,0),0,300)/100);
            }
            return sum;
          })();

          const total = beforePercent + optPercent;

          const optionsLabel = (module.options||[])
            .filter(o => o?.enabled)
            .map(o => o.label)
            .slice(0,3);

          return {
            qty,
            unit,
            dPct,
            unitAfter,
            setupFee,
            optionsLabel,
            total
          };
        };

        const quoteTotals = (state) => {
          const modulesTotal = state.modules.reduce((acc, m) => acc + moduleTotalMGA(m), 0);

          const fixedFees = Math.max(0, safeNum(state.quote.fixedFees, 0));
          const sub = modulesTotal + fixedFees;

          const discPct = clamp(safeNum(state.quote.globalDiscountPct, 0), 0, 95);
          const discount = sub * (discPct / 100);
          const afterDiscount = Math.max(0, sub - discount);

          const taxPct = clamp(safeNum(state.quote.taxPct, 0), 0, 60);
          const tax = afterDiscount * (taxPct / 100);

          const total = afterDiscount + tax;

          const depositPct = clamp(safeNum(state.quote.depositPct, 0), 0, 95);
          const deposit = total * (depositPct / 100);
          const balance = Math.max(0, total - deposit);

          return { modulesTotal, fixedFees, sub, discPct, discount, afterDiscount, taxPct, tax, total, depositPct, deposit, balance };
        };

        return { moduleTotalMGA, moduleLineDetails, quoteTotals };
      })();

      /** -----------------------------
       *  UI / Rendering
       *  ----------------------------- */
      const UI = (() => {
        const els = {
          list: $("#moduleList"),
          lines: $("#lines"),
          totals: $("#totals"),

          btnMGA: $("#btnMGA"),
          btnEUR: $("#btnEUR"),
          rateInput: $("#rateInput"),
          modeBtn: $("#modeBtn"),
          modeBadge: $("#modeBadge"),

          quoteName: $("#quoteName"),
          metaCurrency: $("#metaCurrency"),
          metaRate: $("#metaRate"),

          globalDiscountPct: $("#globalDiscountPct"),
          taxPct: $("#taxPct"),
          depositPct: $("#depositPct"),
          fixedFees: $("#fixedFees"),

          btnSave: $("#btnSave"),
          btnLoad: $("#btnLoad"),
          btnReset: $("#btnReset"),
          btnInvoice: $("#btnInvoice"),
          btnPrintQuote: $("#btnPrintQuote"),
          btnExport: $("#btnExport"),
        };

        const render = (state) => {
          // Header controls
          els.btnMGA.setAttribute("aria-pressed", state.currency === "MGA" ? "true":"false");
          els.btnEUR.setAttribute("aria-pressed", state.currency === "EUR" ? "true":"false");

          els.rateInput.value = state.rateEurToMga ? String(state.rateEurToMga) : "";
          els.modeBtn.textContent = `Mode : ${state.mode === "admin" ? "Admin" : "Client"}`;
          els.modeBadge.textContent = state.mode === "admin" ? "Admin" : "Client";

          els.quoteName.value = state.quote.name || "";
          els.metaCurrency.textContent = `Devise : ${state.currency}`;
          els.metaRate.textContent = `Taux : 1‚Ç¨ = ${formatInt(Math.max(1, state.rateEurToMga || 4900))} MGA`;

          els.globalDiscountPct.value = state.quote.globalDiscountPct ? String(state.quote.globalDiscountPct) : "";
          els.taxPct.value = state.quote.taxPct ? String(state.quote.taxPct) : "";
          els.depositPct.value = state.quote.depositPct ? String(state.quote.depositPct) : "";
          els.fixedFees.value = state.quote.fixedFees ? String(state.quote.fixedFees) : "";

          renderModules(state);
          renderSummary(state);
        };

        const renderModules = (state) => {
          els.list.innerHTML = "";
          const groups = groupBy(state.modules, m => m.group || "Modules");

          for (const [groupName, mods] of groups) {
            const h = document.createElement("div");
            h.style.display = "flex";
            h.style.justifyContent = "space-between";
            h.style.alignItems = "center";
            h.style.margin = "8px 2px 2px";
            h.innerHTML = `
              <div style="font-weight:950;font-size:12px;color:rgba(15,23,42,.82)">${escapeHtml(groupName)}</div>
              <div style="font-size:11px;color:var(--muted)">${mods.length} module(s)</div>
            `;
            els.list.appendChild(h);

            for (const m of mods) {
              const card = document.createElement("div");
              card.className = "module-card card";
              card.dataset.moduleId = m.id;

              const detail = Pricing.moduleLineDetails(m);
              const dLabel = detail.dPct > 0 ? `‚Äî d√©gressif -${detail.dPct}%` : "‚Äî pas de remise";
              const unitLabel = m.unitLabel || "unit√©";
              const sizeLabel = (m.model === "sized" || m.prices) ? `‚Ä¢ ${m.size || "M"}` : "";
              const enabledBadge = m.enabled ? "Actif" : "D√©sactiv√©";

              card.innerHTML = `
                <div class="module-head">
                  <div class="module-title">
                    <div class="name">${escapeHtml(m.name || "Module")}</div>
                    <div class="desc">${escapeHtml(m.desc || "")}</div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                    <span class="badge">${escapeHtml(enabledBadge)}</span>
                    <span class="badge" style="opacity:.92">${money(Pricing.moduleTotalMGA(m), state)}</span>
                  </div>
                </div>

                <div class="module-body">
                  <div class="field">
                    <div class="label">Quantit√© (${escapeHtml(unitLabel)})</div>
                    <div class="control">
                      <div class="mini">
                        <button class="step" data-action="dec" aria-label="Diminuer">‚àí</button>
                        <input class="qty" data-field="qty" inputmode="numeric" value="${Math.max(0, Math.floor(safeNum(m.qty,0)))}" />
                        <button class="step" data-action="inc" aria-label="Augmenter">+</button>
                      </div>
                    </div>
                  </div>

                  <div class="field">
                    <div class="label">Complexit√©</div>
                    <div class="control">
                      ${renderSizeSelect(m, state)}
                    </div>
                  </div>

                  <div class="switch">
                    <div class="label">
                      <strong>Activer ce module</strong>
                      <span>${escapeHtml(dLabel)} ${escapeHtml(sizeLabel)}</span>
                    </div>
                    <button class="toggle" role="switch" aria-checked="${m.enabled ? "true":"false"}" data-field="enabled"></button>
                  </div>

                  ${renderOptions(m, state)}
                </div>

                <div class="admin-row" ${state.mode === "admin" ? "" : "style='display:none'"} >
                  <button class="btn" data-action="edit">‚úèÔ∏è √âditer</button>
                  <button class="btn danger" data-action="delete">üóëÔ∏è Supprimer</button>
                </div>
              `;

              els.list.appendChild(card);
            }
          }

          if (state.mode === "admin") {
            const add = document.createElement("div");
            add.className = "card";
            add.style.padding = "14px";
            add.style.marginTop = "12px";
            add.innerHTML = `
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                <div>
                  <div style="font-weight:950;font-size:13px">+ Ajouter un module</div>
                  <div style="font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35">
                    Cr√©e un nouveau bloc tarifaire (flat ou S/M/L), avec d√©gressif et options.
                  </div>
                </div>
                <button class="btn primary" data-action="addModule">Ajouter</button>
              </div>
            `;
            els.list.appendChild(add);
          }
        };

        const renderSizeSelect = (m, state) => {
          const canSize = !!m.prices && typeof m.prices === "object";
          if (!canSize) {
            return `<input disabled value="‚Äî" />`;
          }
          const disabled = (state.mode !== "admin" && !m.enabled) ? "" : ""; // always allow size changes
          const cur = m.size || "M";
          return `
            <select data-field="size" ${disabled}>
              <option value="S" ${cur==="S"?"selected":""}>S (simple)</option>
              <option value="M" ${cur==="M"?"selected":""}>M (standard)</option>
              <option value="L" ${cur==="L"?"selected":""}>L (complexe)</option>
            </select>
          `;
        };

        const renderOptions = (m, state) => {
          const opts = Array.isArray(m.options) ? m.options : [];
          if (!opts.length) return "";

          const wrap = document.createElement("div");
          wrap.style.display = "grid";
          wrap.style.gridTemplateColumns = "1fr 1fr";
          wrap.style.gap = "10px";
          wrap.style.gridColumn = "1 / -1";

          for (const o of opts) {
            const row = document.createElement("div");
            row.className = "switch";
            row.dataset.optKey = o.key;
            row.innerHTML = `
              <div class="label">
                <strong>${escapeHtml(o.label || "Option")}</strong>
                <span>${escapeHtml(o.hint || optionPriceLabel(o, state))}</span>
              </div>
              <button class="toggle" role="switch" aria-checked="${o.enabled ? "true":"false"}" data-field="opt"></button>
            `;
            wrap.appendChild(row);
          }

          return wrap.outerHTML;
        };

        const optionPriceLabel = (o, state) => {
          const kind = o.kind || "flat";
          const p = safeNum(o.price, 0);
          if (kind === "percent") return `+${p}%`;
          return `${money(p, state)} ${kind === "perUnit" ? " / unit√©" : ""}`.trim();
        };

        const renderSummary = (state) => {
          // Lines
          els.lines.innerHTML = "";
          const activeLines = state.modules
            .map(m => ({ m, d: Pricing.moduleLineDetails(m), total: Pricing.moduleTotalMGA(m) }))
            .filter(x => x.total > 0);

          if (!activeLines.length) {
            const li = document.createElement("li");
            li.className = "line";
            li.innerHTML = `
              <div class="left">
                <div class="t">Aucun module s√©lectionn√©</div>
                <div class="s">Ajoute une quantit√© √† un module pour voir le total.</div>
              </div>
              <div class="amt">${money(0, state)}</div>
            `;
            els.lines.appendChild(li);
          } else {
            for (const {m, d, total} of activeLines) {
              const detailBits = [];
              if (d.qty) detailBits.push(`${d.qty}√ó`);
              if (m.prices) detailBits.push(`complexit√© ${m.size || "M"}`);
              if (d.dPct > 0) detailBits.push(`- ${d.dPct}%`);
              if (d.optionsLabel?.length) detailBits.push(`options: ${d.optionsLabel.join(", ")}`);

              const li = document.createElement("li");
              li.className = "line";
              li.innerHTML = `
                <div class="left">
                  <div class="t">${escapeHtml(m.name || "Module")}</div>
                  <div class="s">${escapeHtml(detailBits.join(" ‚Ä¢ ") || "")}</div>
                </div>
                <div class="amt">${money(total, state)}</div>
              `;
              els.lines.appendChild(li);
            }
          }

          // Totals
          const t = Pricing.quoteTotals(state);
          els.totals.innerHTML = `
            <div class="tot-row"><span>Sous-total modules</span><span>${money(t.modulesTotal, state)}</span></div>
            <div class="tot-row"><span>Frais fixes <small>(optionnel)</small></span><span>${money(t.fixedFees, state)}</span></div>
            <div class="tot-row"><span>Remise globale <small>(${t.discPct}%)</small></span><span>- ${money(t.discount, state)}</span></div>
            <div class="tot-row"><span>Taxe <small>(${t.taxPct}%)</small></span><span>${money(t.tax, state)}</span></div>
            <div class="tot-row grand"><span>Total</span><span>${money(t.total, state)}</span></div>
            <div class="tot-row"><span>Acompte <small>(${t.depositPct}%)</small></span><span>${money(t.deposit, state)}</span></div>
            <div class="tot-row"><span>Reste √† payer</span><span>${money(t.balance, state)}</span></div>
          `;
        };

        const groupBy = (arr, fn) => {
          const map = new Map();
          for (const it of arr) {
            const k = fn(it);
            if (!map.has(k)) map.set(k, []);
            map.get(k).push(it);
          }
          return map;
        };

        return { els, render };
      })();

      /** -----------------------------
       *  Actions (Devis, Facture, Export)
       *  ----------------------------- */
      const Actions = (() => {
        const requestAdmin = async (state) => {
          const pin = String(state.adminPin || "").trim();
          if (!pin) return true;

          const ok = await new Promise((resolve) => {
            const wrap = document.createElement("div");
            wrap.innerHTML = `
              <div class="form">
                <label class="full">Code admin
                  <input id="pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="Entre le code admin" />
                </label>
              </div>
            `;
            Modal.open({
              title: "Acc√®s admin",
              desc: "Un code est requis pour passer en mode admin.",
              body: wrap,
              actions: [
                { label:"Annuler", onClick:(close)=>{ close(); resolve(false); } },
                { label:"D√©verrouiller", variant:"primary", onClick:(close)=>{
                    const v = $("#pin", wrap).value.trim();
                    if (v === pin) { close(); resolve(true); }
                    else { toast("Code incorrect", "R√©essaie.", "warn"); }
                  } }
              ]
            });
          });

          return ok;
        };

        const editModule = (state, moduleId) => {
          const m = state.modules.find(x => x.id === moduleId);
          if (!m) return;

          const wrap = document.createElement("div");
          wrap.innerHTML = `
            <div class="form">
              <label>Groupe
                <input id="group" value="${escapeHtml(m.group || "")}" />
              </label>
              <label>Nom
                <input id="name" value="${escapeHtml(m.name || "")}" />
              </label>

              <label class="full">Description
                <input id="desc" value="${escapeHtml(m.desc || "")}" />
              </label>

              <label>Type de tarif
                <select id="model">
                  <option value="sized" ${m.prices ? "selected":""}>S / M / L</option>
                  <option value="flat" ${!m.prices ? "selected":""}>Forfait unique (via M)</option>
                </select>
              </label>

              <label>Unit√© (libell√©)
                <input id="unitLabel" value="${escapeHtml(m.unitLabel || "unit√©")}" />
              </label>

              <label>Prix S (MGA)
                <input id="pS" inputmode="numeric" value="${safeNum(m.prices?.S, 0)}" />
              </label>
              <label>Prix M (MGA)
                <input id="pM" inputmode="numeric" value="${safeNum(m.prices?.M, 0)}" />
              </label>
              <label>Prix L (MGA)
                <input id="pL" inputmode="numeric" value="${safeNum(m.prices?.L, 0)}" />
              </label>

              <label>Forfait setup (MGA)
                <input id="setupFee" inputmode="numeric" value="${safeNum(m.setupFee, 0)}" />
              </label>

              <label class="full">D√©gressif (format: minQty:pct, s√©par√©s par des virgules)
                <input id="tiers" value="${(m.discountTiers||[]).map(t=>`${safeNum(t.minQty,1)}:${safeNum(t.pct,0)}`).join(", ")}" />
              </label>

              <label class="full">Options (3 max conseill√©es) ‚Äî format: label|kind(flat/perUnit/percent)|price(MGA ou %)
                <textarea id="opts" placeholder="Ex: Rush|percent|20&#10;Sous-titres|perUnit|40000">${(m.options||[]).map(o=>`${o.label||""}|${o.kind||"flat"}|${safeNum(o.price,0)}|${o.key||""}|${o.hint||""}|${o.enabled?1:0}`).join("\n")}</textarea>
              </label>
              <div class="full" style="font-size:12px;color:var(--muted);line-height:1.35">
                Astuce: par ligne tu peux mettre aussi la cl√© + un hint + l'√©tat (1/0) :
                <br><code>label|kind|price|key|hint|enabled</code>
              </div>
            </div>
          `;

          Modal.open({
            title: "√âditer module",
            desc: "Modifie le module (prix en MGA). Les conversions se font √† l'affichage seulement.",
            body: wrap,
            actions: [
              { label:"Annuler", onClick:(close)=>close() },
              { label:"Enregistrer", variant:"primary", onClick:(close)=>{
                  const group = $("#group", wrap).value.trim();
                  const name = $("#name", wrap).value.trim();
                  const desc = $("#desc", wrap).value.trim();
                  const unitLabel = $("#unitLabel", wrap).value.trim() || "unit√©";
                  const model = $("#model", wrap).value;

                  const pS = Math.max(0, safeNum($("#pS", wrap).value, 0));
                  const pM = Math.max(0, safeNum($("#pM", wrap).value, 0));
                  const pL = Math.max(0, safeNum($("#pL", wrap).value, 0));
                  const setupFee = Math.max(0, safeNum($("#setupFee", wrap).value, 0));

                  const tiersRaw = $("#tiers", wrap).value.trim();
                  const discountTiers = tiersRaw ? tiersRaw.split(",").map(x => x.trim()).filter(Boolean).map(pair => {
                    const [a,b] = pair.split(":").map(s=>s.trim());
                    return { minQty: Math.max(1, Math.floor(safeNum(a,1))), pct: clamp(safeNum(b,0), 0, 95) };
                  }) : [{minQty:1,pct:0}];

                  const optsRaw = $("#opts", wrap).value;
                  const options = optsRaw.split("\n").map(l => l.trim()).filter(Boolean).map(line => {
                    const parts = line.split("|").map(s=>s.trim());
                    const label = parts[0] || "Option";
                    const kind = parts[1] || "flat";
                    const price = safeNum(parts[2], 0);
                    const key = parts[3] || (label.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""));
                    const hint = parts[4] || "";
                    const enabled = parts[5] ? parts[5] === "1" : false;
                    return { key, label, kind, price, enabled, hint };
                  });

                  m.group = group || "Modules";
                  m.name = name || "Module";
                  m.desc = desc || "";
                  m.unitLabel = unitLabel;
                  m.setupFee = setupFee;
                  m.discountTiers = discountTiers;
                  m.options = options;

                  // model handling (flat uses M as unit)
                  if (model === "flat") {
                    m.prices = { S: pS, M: pM, L: pL };
                    m.model = "flat";
                    m.size = m.size || "M";
                  } else {
                    m.prices = { S: pS, M: pM, L: pL };
                    m.model = "sized";
                    m.size = m.size || "M";
                  }

                  state.updatedAt = Date.now();
                  Storage.save(state);
                  UI.render(state);
                  toast("Module mis √† jour", "Prix + d√©gressif + options sauvegard√©s.", "ok");
                  close();
                } }
            ]
          });
        };

        const addModule = (state) => {
          const newM = {
            id: "m_" + uid(),
            group: "Nouveau",
            name: "Nouveau module",
            desc: "D√©cris ce module ici.",
            model: "sized",
            unitLabel: "unit√©",
            enabled: true,
            qty: 0,
            size: "M",
            prices: { S: 50000, M: 90000, L: 140000 },
            setupFee: 0,
            discountTiers: [{minQty:1,pct:0}],
            options: []
          };
          state.modules.push(newM);
          Storage.save(state);
          UI.render(state);
          toast("Module ajout√©", "Tu peux l‚Äô√©diter pour ajuster les prix.", "ok");
        };

        const deleteModule = (state, moduleId) => {
          const idx = state.modules.findIndex(x => x.id === moduleId);
          if (idx < 0) return;
          const m = state.modules[idx];

          Modal.open({
            title: "Supprimer module",
            desc: `Supprimer ¬´ ${m.name || "module"} ¬ª ?`,
            body: `<div style="font-size:12px;color:var(--muted);line-height:1.35">
              Cette action ne peut pas √™tre annul√©e (sauf si tu r√©-importes une config).
            </div>`,
            actions: [
              { label:"Annuler", onClick:(close)=>close() },
              { label:"Supprimer", variant:"danger", onClick:(close)=>{
                  state.modules.splice(idx,1);
                  Storage.save(state);
                  UI.render(state);
                  toast("Module supprim√©", "OK.", "warn");
                  close();
                } }
            ]
          });
        };

        const saveSnapshot = (state) => {
          const snap = {
            id: uid(),
            name: (state.quote.name || "Devis").trim(),
            createdAt: nowISO(),
            currency: state.currency,
            rate: Math.max(1, state.rateEurToMga || 4900),
            snapshotQuote: structuredClone(state.quote),
            snapshotModules: structuredClone(state.modules)
          };
          state.saved.unshift(snap);
          state.saved = state.saved.slice(0, MAX_SAVES);
          Storage.save(state);
          toast("Sauvegard√©", "Devis enregistr√© en local.", "ok");
        };

        const loadSnapshot = (state) => {
          const items = state.saved || [];
          if (!items.length) {
            toast("Rien √† charger", "Aucune sauvegarde trouv√©e.", "warn");
            return;
          }

          const wrap = document.createElement("div");
          wrap.innerHTML = `
            <div style="display:flex;flex-direction:column;gap:10px">
              ${items.map(s => `
                <div class="line" style="cursor:pointer" data-id="${s.id}">
                  <div class="left">
                    <div class="t">${escapeHtml(s.name)}</div>
                    <div class="s">${escapeHtml(s.createdAt)} ‚Ä¢ ${escapeHtml(s.currency)} ‚Ä¢ 1‚Ç¨=${formatInt(s.rate)} MGA</div>
                  </div>
                  <div class="amt">Charger</div>
                </div>
              `).join("")}
              <div style="font-size:12px;color:var(--muted);line-height:1.35">
                Astuce: tu peux garder plusieurs versions (max ${MAX_SAVES}).
              </div>
            </div>
          `;

          wrap.addEventListener("click", (e) => {
            const row = e.target.closest("[data-id]");
            if (!row) return;
            const id = row.getAttribute("data-id");
            const s = items.find(x => x.id === id);
            if (!s) return;

            state.quote = structuredClone(s.snapshotQuote);
            state.modules = structuredClone(s.snapshotModules);
            state.currency = s.currency || state.currency;
            state.rateEurToMga = s.rate || state.rateEurToMga;

            Storage.save(state);
            UI.render(state);
            toast("Charg√©", `¬´ ${s.name} ¬ª`, "ok");
            Modal.close();
          });

          Modal.open({
            title: "Charger un devis",
            desc: "S√©lectionne une sauvegarde.",
            body: wrap,
            actions: [
              { label:"Fermer", onClick:(close)=>close() },
              { label:"Tout effacer", variant:"danger", onClick:(close)=>{
                  state.saved = [];
                  Storage.save(state);
                  UI.render(state);
                  toast("Sauvegardes supprim√©es", "Liste vid√©e.", "warn");
                  close();
                } }
            ]
          });
        };

        const resetAll = (state) => {
          Modal.open({
            title: "R√©initialiser",
            desc: "Remettre l'app √† z√©ro ?",
            body: `<div style="font-size:12px;color:var(--muted);line-height:1.35">
              √áa r√©initialise modules + devis + r√©glages (mais garde le navigateur intact).
            </div>`,
            actions: [
              { label:"Annuler", onClick:(close)=>close() },
              { label:"R√©initialiser", variant:"danger", onClick:(close)=>{
                  const fresh = defaultState();
                  Object.keys(state).forEach(k => delete state[k]);
                  Object.assign(state, fresh);
                  Storage.save(state);
                  UI.render(state);
                  toast("R√©initialis√©", "App remise √† z√©ro.", "warn");
                  close();
                } }
            ]
          });
        };

        const exportImport = (state) => {
          const wrap = document.createElement("div");

          const exportPayload = () => JSON.stringify({
            version: state.version,
            exportedAt: new Date().toISOString(),
            currency: state.currency,
            rateEurToMga: state.rateEurToMga,
            quote: state.quote,
            modules: state.modules,
            invoice: state.invoice,
          }, null, 2);

          wrap.innerHTML = `
            <div class="form">
              <label class="full">Export (copie/colle)
                <textarea id="exportArea" readonly>${escapeHtml(exportPayload())}</textarea>
              </label>

              <label class="full">Import
                <textarea id="importArea" placeholder="Colle ici un export pour restaurer modules + devis + infos facture‚Ä¶"></textarea>
              </label>

              <label>Code admin (optionnel)
                <input id="adminPin" inputmode="numeric" placeholder="ex: 1234" value="${escapeHtml(state.adminPin || "")}" />
              </label>

              <label>G√©n√©rer n¬∞ facture suivant
                <input id="nextInv" inputmode="numeric" value="${safeNum(state.invoice?.settings?.nextInvoiceNumber, 1)}" />
              </label>
            </div>
            <div style="margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35">
              Reco: d√©finis un code admin si tu partages l'outil au client (√ßa √©vite qu'il modifie les prix).
            </div>
          `;

          Modal.open({
            title: "Export / Import",
            desc: "Sauvegarde/restore rapide (sans d√©pendances).",
            body: wrap,
            actions: [
              { label:"Copier l‚Äôexport", onClick:()=>{
                  const area = $("#exportArea", wrap);
                  area.select();
                  document.execCommand("copy");
                  toast("Copi√©", "Export copi√© dans le presse-papiers.", "ok");
                } },
              { label:"Importer", variant:"primary", onClick:(close)=>{
                  try{
                    const raw = $("#importArea", wrap).value.trim();
                    if (!raw) { toast("Import vide", "Colle un export.", "warn"); return; }
                    const data = JSON.parse(raw);

                    if (data.modules && Array.isArray(data.modules)) state.modules = data.modules;
                    if (data.quote) state.quote = data.quote;
                    if (data.currency) state.currency = data.currency;
                    if (data.rateEurToMga) state.rateEurToMga = data.rateEurToMga;
                    if (data.invoice) state.invoice = data.invoice;

                    // update admin pin / invoice counter
                    state.adminPin = String($("#adminPin", wrap).value || "").trim();
                    state.invoice.settings.nextInvoiceNumber = Math.max(1, Math.floor(safeNum($("#nextInv", wrap).value, 1)));

                    Storage.save(state);
                    UI.render(state);
                    toast("Import OK", "Config restaur√©e.", "ok");
                    close();
                  } catch(e){
                    toast("Import √©chou√©", "JSON invalide ou incomplet.", "danger");
                  }
                } },
              { label:"Fermer", onClick:(close)=>{
                  // save small settings anyway
                  state.adminPin = String($("#adminPin", wrap).value || "").trim();
                  state.invoice.settings.nextInvoiceNumber = Math.max(1, Math.floor(safeNum($("#nextInv", wrap).value, 1)));
                  Storage.save(state);
                  close();
                } }
            ]
          });
        };

        const printQuote = (state) => {
          const totals = Pricing.quoteTotals(state);
          const lines = state.modules
            .map(m => ({ m, d: Pricing.moduleLineDetails(m), total: Pricing.moduleTotalMGA(m) }))
            .filter(x => x.total > 0);

          const html = `
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(state.quote.name || "Devis")}</title>
<style>
  body{ font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; margin:24px; color:#0f172a; }
  .top{ display:flex; justify-content:space-between; gap:16px; align-items:flex-start; }
  h1{ margin:0; font-size:20px; }
  .muted{ color:#475569; font-size:12px; line-height:1.35; }
  table{ width:100%; border-collapse:collapse; margin-top:18px; }
  th,td{ border-bottom:1px solid #e2e8f0; padding:10px 8px; vertical-align:top; font-size:12px; }
  th{ text-align:left; color:#334155; }
  .right{ text-align:right; white-space:nowrap; }
  .tot{ margin-top:14px; display:flex; justify-content:flex-end; }
  .box{ width:min(420px,100%); border:1px solid #e2e8f0; border-radius:14px; padding:12px; }
  .row{ display:flex; justify-content:space-between; gap:12px; font-size:12px; padding:4px 0; }
  .grand{ font-weight:900; font-size:14px; }
  .note{ margin-top:12px; font-size:12px; color:#475569; }
  @media print{ .no-print{ display:none; } body{ margin:0; } }
</style>
</head>
<body>
  <div class="top">
    <div>
      <h1>${escapeHtml(state.quote.name || "Devis")}</h1>
      <div class="muted">
        Date: ${escapeHtml(state.quote.createdAt || nowISO())}<br/>
        Devise: ${escapeHtml(state.currency)} ‚Ä¢ Taux: 1‚Ç¨ = ${formatInt(Math.max(1, state.rateEurToMga || 4900))} MGA
      </div>
    </div>
    <div class="no-print">
      <button onclick="window.print()">Imprimer / PDF</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>√âl√©ment</th>
        <th>D√©tails</th>
        <th class="right">Montant</th>
      </tr>
    </thead>
    <tbody>
      ${lines.map(({m,d,total}) => `
        <tr>
          <td><strong>${escapeHtml(m.name || "Module")}</strong></td>
          <td class="muted">
            ${d.qty}√ó ‚Ä¢ ${m.prices ? `Complexit√© ${escapeHtml(m.size || "M")}` : ""} ${d.dPct>0?`‚Ä¢ D√©gressif -${d.dPct}%`:""}
            ${d.optionsLabel?.length?`<br/>Options: ${escapeHtml(d.optionsLabel.join(", "))}`:""}
          </td>
          <td class="right"><strong>${escapeHtml(money(total, state))}</strong></td>
        </tr>
      `).join("")}
      ${totals.fixedFees>0 ? `
        <tr>
          <td><strong>Frais fixes</strong></td>
          <td class="muted">Forfait</td>
          <td class="right"><strong>${escapeHtml(money(totals.fixedFees, state))}</strong></td>
        </tr>
      ` : ""}
    </tbody>
  </table>

  <div class="tot">
    <div class="box">
      <div class="row"><span>Sous-total</span><span>${escapeHtml(money(totals.sub, state))}</span></div>
      <div class="row"><span>Remise globale (${totals.discPct}%)</span><span>- ${escapeHtml(money(totals.discount, state))}</span></div>
      <div class="row"><span>Taxe (${totals.taxPct}%)</span><span>${escapeHtml(money(totals.tax, state))}</span></div>
      <div class="row grand"><span>Total</span><span>${escapeHtml(money(totals.total, state))}</span></div>
      ${totals.deposit>0 ? `<div class="row"><span>Acompte (${totals.depositPct}%)</span><span>${escapeHtml(money(totals.deposit, state))}</span></div>
      <div class="row"><span>Reste √† payer</span><span>${escapeHtml(money(totals.balance, state))}</span></div>` : ``}
    </div>
  </div>

  <div class="note">
    Ce devis est g√©n√©r√© automatiquement √† partir d'un syst√®me modulaire. Les prix et le taux peuvent √™tre ajust√©s selon le contexte.
  </div>
</body>
</html>`;
          const w = window.open("", "_blank");
          if (!w) { toast("Popup bloqu√©e", "Autorise les popups pour imprimer.", "warn"); return; }
          w.document.open();
          w.document.write(html);
          w.document.close();
          w.focus();
        };

        const invoiceModal = (state) => {
          const wrap = document.createElement("div");

          const invNo = state.invoice?.settings?.nextInvoiceNumber || 1;
          const today = nowISO();

          wrap.innerHTML = `
            <div class="form">
              <div class="full" style="font-weight:950;font-size:12px;margin-bottom:2px">Informations de facturation (toi)</div>

              <label>Entreprise
                <input id="b_companyName" value="${escapeHtml(state.invoice.billing.companyName)}" placeholder="Nom soci√©t√© / marque" />
              </label>
              <label>Nom complet
                <input id="b_fullName" value="${escapeHtml(state.invoice.billing.fullName)}" placeholder="Ton nom (ou responsable)" />
              </label>

              <label class="full">Adresse
                <input id="b_address" value="${escapeHtml(state.invoice.billing.address)}" placeholder="Adresse" />
              </label>

              <label>Pays
                <input id="b_country" value="${escapeHtml(state.invoice.billing.country)}" placeholder="Pays" />
              </label>
              <label>Code postal
                <input id="b_postalCode" value="${escapeHtml(state.invoice.billing.postalCode)}" placeholder="Code postal" />
              </label>

              <label>T√©l√©phone
                <input id="b_phone" value="${escapeHtml(state.invoice.billing.phone)}" placeholder="+261 ..." />
              </label>
              <label>Email
                <input id="b_email" value="${escapeHtml(state.invoice.billing.email)}" placeholder="email@..." />
              </label>

              <label>NIF
                <input id="b_nif" value="${escapeHtml(state.invoice.billing.nif)}" placeholder="NIF" />
              </label>
              <label>STAT
                <input id="b_stat" value="${escapeHtml(state.invoice.billing.stat)}" placeholder="STAT" />
              </label>

              <div class="full" style="margin-top:6px;font-weight:950;font-size:12px">Client</div>

              <label>Entreprise client
                <input id="c_companyName" value="${escapeHtml(state.invoice.client.companyName)}" placeholder="Nom soci√©t√© client" />
              </label>
              <label>Nom complet client
                <input id="c_fullName" value="${escapeHtml(state.invoice.client.fullName)}" placeholder="Contact client" />
              </label>

              <label class="full">Adresse client
                <input id="c_address" value="${escapeHtml(state.invoice.client.address)}" placeholder="Adresse" />
              </label>

              <label>Pays client
                <input id="c_country" value="${escapeHtml(state.invoice.client.country)}" placeholder="Pays" />
              </label>
              <label>Code postal client
                <input id="c_postalCode" value="${escapeHtml(state.invoice.client.postalCode)}" placeholder="Code postal" />
              </label>

              <label>T√©l√©phone client
                <input id="c_phone" value="${escapeHtml(state.invoice.client.phone)}" placeholder="T√©l√©phone" />
              </label>
              <label>Email client
                <input id="c_email" value="${escapeHtml(state.invoice.client.email)}" placeholder="Email" />
              </label>

              <div class="full" style="margin-top:6px;font-weight:950;font-size:12px">Facture</div>

              <label>N¬∞ facture
                <input id="inv_number" value="${escapeHtml(String(invNo))}" />
              </label>
              <label>Date
                <input id="inv_date" type="date" value="${escapeHtml(today)}" />
              </label>

              <label>√âch√©ance
                <input id="inv_due" type="date" value="${escapeHtml(today)}" />
              </label>
              <label>Conditions
                <input id="inv_terms" value="${escapeHtml(state.invoice.settings.paymentTerms)}" placeholder="Paiement √† r√©ception" />
              </label>

              <label class="full">Notes (optionnel)
                <textarea id="inv_notes" placeholder="Notes / d√©tails...">${escapeHtml(state.invoice.settings.notes)}</textarea>
              </label>

              <label class="full">Champs personnalis√©s (une ligne = un terme)
                <textarea id="inv_customTerms" placeholder="Ex: Acompte 30% √† la commande">${escapeHtml((state.invoice.customTerms||[]).join("\n"))}</textarea>
              </label>

              <div class="full" style="font-size:12px;color:var(--muted);line-height:1.35">
                La facture reprend automatiquement les lignes du devis actuel (modules s√©lectionn√©s) + frais fixes + remise/taxe.
                Tu peux ensuite imprimer en PDF.
              </div>
            </div>
          `;

          Modal.open({
            title: "G√©n√©rer une facture",
            desc: "Renseigne les infos essentielles, puis g√©n√®re une facture imprimable.",
            body: wrap,
            actions: [
              { label:"Annuler", onClick:(close)=>close() },
              { label:"Enregistrer", onClick:(close)=>{
                  // persist form fields
                  const g = (id) => $("#"+id, wrap).value.trim();

                  state.invoice.billing.companyName = g("b_companyName");
                  state.invoice.billing.fullName = g("b_fullName");
                  state.invoice.billing.address = g("b_address");
                  state.invoice.billing.country = g("b_country");
                  state.invoice.billing.postalCode = g("b_postalCode");
                  state.invoice.billing.phone = g("b_phone");
                  state.invoice.billing.email = g("b_email");
                  state.invoice.billing.nif = g("b_nif");
                  state.invoice.billing.stat = g("b_stat");

                  state.invoice.client.companyName = g("c_companyName");
                  state.invoice.client.fullName = g("c_fullName");
                  state.invoice.client.address = g("c_address");
                  state.invoice.client.country = g("c_country");
                  state.invoice.client.postalCode = g("c_postalCode");
                  state.invoice.client.phone = g("c_phone");
                  state.invoice.client.email = g("c_email");

                  state.invoice.settings.paymentTerms = g("inv_terms");
                  state.invoice.settings.notes = $("#inv_notes", wrap).value;

                  const termsRaw = $("#inv_customTerms", wrap).value;
                  state.invoice.customTerms = termsRaw.split("\n").map(s=>s.trim()).filter(Boolean);

                  // counter
                  state.invoice.settings.nextInvoiceNumber = Math.max(1, Math.floor(safeNum(g("inv_number"), 1)));

                  Storage.save(state);
                  toast("Infos facture sauvegard√©es", "OK.", "ok");
                  close();
                } },
              { label:"G√©n√©rer", variant:"primary", onClick:()=>{
                  // Save + generate
                  const g = (id) => $("#"+id, wrap).value.trim();

                  state.invoice.billing.companyName = g("b_companyName");
                  state.invoice.billing.fullName = g("b_fullName");
                  state.invoice.billing.address = g("b_address");
                  state.invoice.billing.country = g("b_country");
                  state.invoice.billing.postalCode = g("b_postalCode");
                  state.invoice.billing.phone = g("b_phone");
                  state.invoice.billing.email = g("b_email");
                  state.invoice.billing.nif = g("b_nif");
                  state.invoice.billing.stat = g("b_stat");

                  state.invoice.client.companyName = g("c_companyName");
                  state.invoice.client.fullName = g("c_fullName");
                  state.invoice.client.address = g("c_address");
                  state.invoice.client.country = g("c_country");
                  state.invoice.client.postalCode = g("c_postalCode");
                  state.invoice.client.phone = g("c_phone");
                  state.invoice.client.email = g("c_email");

                  const invNumber = Math.max(1, Math.floor(safeNum(g("inv_number"), 1)));
                  const invDate = g("inv_date") || nowISO();
                  const invDue = g("inv_due") || invDate;

                  state.invoice.settings.paymentTerms = g("inv_terms");
                  state.invoice.settings.notes = $("#inv_notes", wrap).value;

                  const termsRaw = $("#inv_customTerms", wrap).value;
                  state.invoice.customTerms = termsRaw.split("\n").map(s=>s.trim()).filter(Boolean);

                  Storage.save(state);

                  generateInvoiceWindow(state, { invNumber, invDate, invDue });

                  // increment
                  state.invoice.settings.nextInvoiceNumber = invNumber + 1;
                  Storage.save(state);
                  UI.render(state);
                  toast("Facture g√©n√©r√©e", "Fen√™tre imprimable ouverte.", "ok");
                  Modal.close();
                } }
            ]
          });
        };

        const generateInvoiceWindow = (state, meta) => {
          const totals = Pricing.quoteTotals(state);

          const lines = state.modules
            .map(m => ({ m, d: Pricing.moduleLineDetails(m), total: Pricing.moduleTotalMGA(m) }))
            .filter(x => x.total > 0);

          const billing = state.invoice.billing || {};
          const client = state.invoice.client || {};
          const terms = state.invoice.settings?.paymentTerms || "";
          const notes = state.invoice.settings?.notes || "";
          const customTerms = state.invoice.customTerms || [];
          const invTitle = `Facture #${meta.invNumber}`;

          const html = `
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(invTitle)}</title>
<style>
  body{ font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; margin:24px; color:#0f172a; }
  .top{ display:flex; justify-content:space-between; gap:16px; align-items:flex-start; }
  h1{ margin:0; font-size:20px; }
  .muted{ color:#475569; font-size:12px; line-height:1.35; }
  .box{ border:1px solid #e2e8f0; border-radius:14px; padding:12px; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
  table{ width:100%; border-collapse:collapse; margin-top:18px; }
  th,td{ border-bottom:1px solid #e2e8f0; padding:10px 8px; vertical-align:top; font-size:12px; }
  th{ text-align:left; color:#334155; }
  .right{ text-align:right; white-space:nowrap; }
  .tot{ margin-top:14px; display:flex; justify-content:flex-end; }
  .tot .box{ width:min(420px,100%); }
  .row{ display:flex; justify-content:space-between; gap:12px; font-size:12px; padding:4px 0; }
  .grand{ font-weight:900; font-size:14px; }
  .section-title{ font-weight:900; font-size:12px; margin-bottom:6px; color:#0f172a; }
  ul{ margin:10px 0 0; padding-left:18px; color:#475569; font-size:12px; }
  .no-print{ margin-top:12px; }
  @media print{ .no-print{ display:none; } body{ margin:0; } }
</style>
</head>
<body>
  <div class="top">
    <div>
      <h1>${escapeHtml(invTitle)}</h1>
      <div class="muted">
        Date: ${escapeHtml(meta.invDate)}<br/>
        √âch√©ance: ${escapeHtml(meta.invDue)}<br/>
        Devise: ${escapeHtml(state.currency)} ‚Ä¢ Taux: 1‚Ç¨ = ${formatInt(Math.max(1, state.rateEurToMga || 4900))} MGA
      </div>
    </div>
    <div class="no-print">
      <button onclick="window.print()">Imprimer / PDF</button>
    </div>
  </div>

  <div class="grid">
    <div class="box">
      <div class="section-title">√âmetteur</div>
      <div class="muted">
        <strong>${escapeHtml(billing.companyName || billing.fullName || "")}</strong><br/>
        ${escapeHtml(billing.fullName || "")}<br/>
        ${escapeHtml(billing.address || "")}<br/>
        ${escapeHtml([billing.postalCode, billing.country].filter(Boolean).join(" ") || "")}<br/>
        ${billing.phone ? `T√©l: ${escapeHtml(billing.phone)}<br/>` : ``}
        ${billing.email ? `Email: ${escapeHtml(billing.email)}<br/>` : ``}
        ${(billing.nif || billing.stat) ? `NIF: ${escapeHtml(billing.nif)} ‚Ä¢ STAT: ${escapeHtml(billing.stat)}` : ``}
      </div>
    </div>

    <div class="box">
      <div class="section-title">Client</div>
      <div class="muted">
        <strong>${escapeHtml(client.companyName || client.fullName || "")}</strong><br/>
        ${escapeHtml(client.fullName || "")}<br/>
        ${escapeHtml(client.address || "")}<br/>
        ${escapeHtml([client.postalCode, client.country].filter(Boolean).join(" ") || "")}<br/>
        ${client.phone ? `T√©l: ${escapeHtml(client.phone)}<br/>` : ``}
        ${client.email ? `Email: ${escapeHtml(client.email)}<br/>` : ``}
      </div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Prestation</th>
        <th>D√©tails</th>
        <th class="right">Montant</th>
      </tr>
    </thead>
    <tbody>
      ${lines.map(({m,d,total}) => `
        <tr>
          <td><strong>${escapeHtml(m.name || "Module")}</strong></td>
          <td class="muted">
            ${d.qty}√ó ‚Ä¢ ${m.prices ? `Complexit√© ${escapeHtml(m.size || "M")}` : ""} ${d.dPct>0?`‚Ä¢ D√©gressif -${d.dPct}%`:""}
            ${d.optionsLabel?.length?`<br/>Options: ${escapeHtml(d.optionsLabel.join(", "))}`:""}
          </td>
          <td class="right"><strong>${escapeHtml(money(total, state))}</strong></td>
        </tr>
      `).join("")}
      ${totals.fixedFees>0 ? `
        <tr>
          <td><strong>Frais fixes</strong></td>
          <td class="muted">Forfait</td>
          <td class="right"><strong>${escapeHtml(money(totals.fixedFees, state))}</strong></td>
        </tr>
      ` : ""}
    </tbody>
  </table>

  <div class="tot">
    <div class="box">
      <div class="row"><span>Sous-total</span><span>${escapeHtml(money(totals.sub, state))}</span></div>
      <div class="row"><span>Remise globale (${totals.discPct}%)</span><span>- ${escapeHtml(money(totals.discount, state))}</span></div>
      <div class="row"><span>Taxe (${totals.taxPct}%)</span><span>${escapeHtml(money(totals.tax, state))}</span></div>
      <div class="row grand"><span>Total</span><span>${escapeHtml(money(totals.total, state))}</span></div>
      ${totals.deposit>0 ? `<div class="row"><span>Acompte (${totals.depositPct}%)</span><span>${escapeHtml(money(totals.deposit, state))}</span></div>
      <div class="row"><span>Reste √† payer</span><span>${escapeHtml(money(totals.balance, state))}</span></div>` : ``}
    </div>
  </div>

  <div class="box" style="margin-top:12px">
    <div class="section-title">Conditions</div>
    <div class="muted">${escapeHtml(terms)}</div>
    ${customTerms.length ? `<ul>${customTerms.map(t => `<li>${escapeHtml(t)}</li>`).join("")}</ul>` : ``}
    ${notes ? `<div class="muted" style="margin-top:10px"><strong>Notes:</strong><br/>${escapeHtml(notes)}</div>` : ``}
  </div>
</body>
</html>`;

          const w = window.open("", "_blank");
          if (!w) { toast("Popup bloqu√©e", "Autorise les popups pour g√©n√©rer la facture.", "warn"); return; }
          w.document.open();
          w.document.write(html);
          w.document.close();
          w.focus();
        };

        return {
          requestAdmin,
          editModule,
          addModule,
          deleteModule,
          saveSnapshot,
          loadSnapshot,
          resetAll,
          exportImport,
          invoiceModal,
          printQuote
        };
      })();

      /** -----------------------------
       *  Event wiring
       *  ----------------------------- */
      const bindEvents = (state) => {
        // Currency toggle
        UI.els.btnMGA.addEventListener("click", () => {
          state.currency = "MGA";
          Storage.save(state);
          UI.render(state);
        });
        UI.els.btnEUR.addEventListener("click", () => {
          state.currency = "EUR";
          Storage.save(state);
          UI.render(state);
        });

        UI.els.rateInput.addEventListener("input", () => {
          const rate = Math.max(1, Math.floor(safeNum(UI.els.rateInput.value, 4900)));
          state.rateEurToMga = rate;
          Storage.save(state);
          UI.render(state);
        });

        UI.els.modeBtn.addEventListener("click", async () => {
          if (state.mode === "client") {
            const ok = await Actions.requestAdmin(state);
            if (!ok) return;
            state.mode = "admin";
            toast("Mode admin", "√âdition des prix activ√©e.", "ok");
          } else {
            state.mode = "client";
            toast("Mode client", "Prix verrouill√©s.", "ok");
          }
          Storage.save(state);
          UI.render(state);
        });

        // Quote fields
        UI.els.quoteName.addEventListener("input", () => {
          state.quote.name = UI.els.quoteName.value;
          Storage.save(state);
        });

        UI.els.globalDiscountPct.addEventListener("input", () => {
          state.quote.globalDiscountPct = clamp(safeNum(UI.els.globalDiscountPct.value, 0), 0, 95);
          Storage.save(state);
          UI.render(state);
        });
        UI.els.taxPct.addEventListener("input", () => {
          state.quote.taxPct = clamp(safeNum(UI.els.taxPct.value, 0), 0, 60);
          Storage.save(state);
          UI.render(state);
        });
        UI.els.depositPct.addEventListener("input", () => {
          state.quote.depositPct = clamp(safeNum(UI.els.depositPct.value, 0), 0, 95);
          Storage.save(state);
          UI.render(state);
        });
        UI.els.fixedFees.addEventListener("input", () => {
          state.quote.fixedFees = Math.max(0, safeNum(UI.els.fixedFees.value, 0));
          Storage.save(state);
          UI.render(state);
        });

        // Summary buttons
        UI.els.btnSave.addEventListener("click", () => Actions.saveSnapshot(state));
        UI.els.btnLoad.addEventListener("click", () => Actions.loadSnapshot(state));
        UI.els.btnReset.addEventListener("click", () => Actions.resetAll(state));
        UI.els.btnExport.addEventListener("click", () => Actions.exportImport(state));
        UI.els.btnInvoice.addEventListener("click", () => Actions.invoiceModal(state));
        UI.els.btnPrintQuote.addEventListener("click", () => Actions.printQuote(state));

        // Module interactions (event delegation)
        UI.els.list.addEventListener("click", async (e) => {
          const card = e.target.closest(".module-card");
          const addBtn = e.target.closest("[data-action='addModule']");
          if (addBtn) {
            if (state.mode !== "admin") return;
            Actions.addModule(state);
            return;
          }
          if (!card) return;

          const moduleId = card.dataset.moduleId;
          const m = state.modules.find(x => x.id === moduleId);
          if (!m) return;

          const stepBtn = e.target.closest(".step");
          if (stepBtn) {
            const action = stepBtn.dataset.action;
            const qty = Math.max(0, Math.floor(safeNum(m.qty, 0)));
            m.qty = action === "inc" ? qty + 1 : Math.max(0, qty - 1);
            Storage.save(state);
            UI.render(state);
            return;
          }

          const toggle = e.target.closest(".toggle");
          if (toggle) {
            const field = toggle.dataset.field;
            if (field === "enabled") {
              m.enabled = !m.enabled;
              if (!m.enabled) {
                // optional: keep qty as is; user may want to re-enable later.
              }
              Storage.save(state);
              UI.render(state);
              return;
            }
            if (field === "opt") {
              const optRow = e.target.closest("[data-opt-key]");
              const key = optRow?.getAttribute("data-opt-key");
              const opt = (m.options||[]).find(o => o.key === key);
              if (opt) {
                opt.enabled = !opt.enabled;
                Storage.save(state);
                UI.render(state);
              }
              return;
            }
          }

          const act = e.target.closest("[data-action]");
          if (act) {
            const a = act.getAttribute("data-action");
            if (a === "edit") {
              if (state.mode !== "admin") { toast("Verrouill√©", "Passe en mode admin pour √©diter.", "warn"); return; }
              Actions.editModule(state, moduleId);
              return;
            }
            if (a === "delete") {
              if (state.mode !== "admin") { toast("Verrouill√©", "Passe en mode admin pour supprimer.", "warn"); return; }
              Actions.deleteModule(state, moduleId);
              return;
            }
          }
        });

        UI.els.list.addEventListener("input", (e) => {
          const card = e.target.closest(".module-card");
          if (!card) return;
          const moduleId = card.dataset.moduleId;
          const m = state.modules.find(x => x.id === moduleId);
          if (!m) return;

          const field = e.target.getAttribute("data-field");
          if (field === "qty") {
            const val = Math.max(0, Math.floor(safeNum(e.target.value, 0)));
            m.qty = val;
            Storage.save(state);
            UI.render(state);
            return;
          }
          if (field === "size") {
            m.size = e.target.value;
            Storage.save(state);
            UI.render(state);
            return;
          }
        });
      };

      /** -----------------------------
       *  Init
       *  ----------------------------- */
      const init = () => {
        const state = Storage.load();

        // Quick sanity: ensure each module has needed fields
        state.modules = (state.modules||[]).map(m => ({
          id: m.id || "m_" + uid(),
          group: m.group || "Modules",
          name: m.name || "Module",
          desc: m.desc || "",
          model: m.model || (m.prices ? "sized" : "flat"),
          unitLabel: m.unitLabel || "unit√©",
          enabled: !!m.enabled,
          qty: Math.max(0, Math.floor(safeNum(m.qty, 0))),
          size: m.size || "M",
          prices: m.prices || { S:0, M:0, L:0 },
          setupFee: Math.max(0, safeNum(m.setupFee, 0)),
          discountTiers: Array.isArray(m.discountTiers) ? m.discountTiers : [{minQty:1,pct:0}],
          options: Array.isArray(m.options) ? m.options : []
        }));

        // Ensure invoice structure
        if (!state.invoice) state.invoice = defaultState().invoice;
        if (!state.invoice.billing) state.invoice.billing = defaultState().invoice.billing;
        if (!state.invoice.client) state.invoice.client = defaultState().invoice.client;
        if (!state.invoice.settings) state.invoice.settings = defaultState().invoice.settings;
        if (!Array.isArray(state.invoice.customTerms)) state.invoice.customTerms = defaultState().invoice.customTerms;

        // Ensure quote structure
        if (!state.quote) state.quote = defaultState().quote;
        if (!state.quote.createdAt) state.quote.createdAt = nowISO();

        // Render + bind
        UI.render(state);
        bindEvents(state);

        // Small onboarding
        toast("Pr√™t ‚úÖ", "Passe en admin pour √©diter les prix, sinon reste en client.", "ok");
      };

      return { init };
    })();

    App.init();
  </script>
</body>
</html>
```
