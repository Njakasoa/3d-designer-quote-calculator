<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de devis modulable — 3D & Design</title>
  <style>
    :root {
      --bg-1: #e6f0ff;
      --bg-2: #d8dcff;
      --bg-3: #f3f7ff;
      --bg-4: #d3f4ff;
      --glass: rgba(255, 255, 255, 0.35);
      --glass-strong: rgba(255, 255, 255, 0.65);
      --border: rgba(255, 255, 255, 0.5);
      --shadow: 0 24px 60px rgba(12, 25, 58, 0.16);
      --accent: #3b82f6;
      --accent-2: #7c3aed;
      --accent-3: #06b6d4;
      --success: #14b8a6;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #6b7280;
      --radius-xl: 26px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --transition: 180ms ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", Roboto, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.18), transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(6, 182, 212, 0.2), transparent 35%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.16), transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-3) 55%, #ffffff 100%);
      min-height: 100vh;
      padding: 28px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.6), transparent 38%),
        radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.45), transparent 35%),
        radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.35), transparent 40%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      z-index: -1;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 10% 10% auto auto;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.35), transparent 70%);
      filter: blur(25px);
      opacity: 0.6;
      pointer-events: none;
      z-index: -1;
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .content {
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 12px 18px;
      border-radius: var(--radius-xl);
      background: rgba(255, 255, 255, 0.25);
      border: none;
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(14px);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .subtle {
      color: var(--muted);
    }

    .glass {
      background: var(--glass);
      border: none;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px) saturate(160%);
      -webkit-backdrop-filter: blur(22px) saturate(160%);
      position: relative;
      overflow: hidden;
    }

    .glass::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: none;
      pointer-events: none;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6),
        inset 0 -10px 20px rgba(255, 255, 255, 0.15);
    }

    .glass::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.5), transparent 45%);
      opacity: 0.7;
      pointer-events: none;
    }

    .panel {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .panel h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .toggle-group {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.35);
      border: none;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.6);
    }

    .toggle-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
    }

    .toggle-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: #1d4ed8;
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.2);
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.55);
      border: none;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(59, 130, 246, 0.2);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .grid > div {
      flex: 1 1 220px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .form-item {
      flex: 1 1 240px;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .is-disabled {
      opacity: 0.45;
      filter: grayscale(0.4);
      position: relative;
      pointer-events: none;
    }

    .is-disabled input,
    .is-disabled select,
    .is-disabled button {
      background: rgba(255, 255, 255, 0.35);
      box-shadow: none;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px;
      font-size: 1rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.55);
      transition: var(--transition);
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      padding: 0;
      margin: 0;
      border-radius: 4px;
      box-shadow: none;
      background: rgba(255, 255, 255, 0.9);
      accent-color: var(--accent-2);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(255, 255, 255, 0.92);
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stepper button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.6);
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .stepper button:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 16px rgba(16, 24, 40, 0.12);
    }

    .helper {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .options > label {
      flex: 1 1 180px;
      min-width: 180px;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.5);
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .checkbox input {
      flex: 0 0 auto;
    }

    .checkbox:hover {
      background: rgba(255, 255, 255, 0.85);
    }

    .sidebar {
      position: sticky;
      top: 24px;
      height: fit-content;
      flex: 0 0 360px;
    }

    .summary {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .total {
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-align: right;
    }

    .total strong {
      font-size: 2.3rem;
    }

    .summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .summary-item.sub {
      color: var(--muted);
      font-size: 0.82rem;
      padding-left: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.12);
      color: var(--success);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      font-size: 0.85rem;
      display: none;
    }

    .drawer {
      display: none;
    }

    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 20px;
    }

    .settings-panel {
      width: min(980px, 95vw);
      max-height: 85vh;
      overflow: auto;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px) saturate(170%);
    }

    .settings-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .settings-grid > div {
      flex: 1 1 220px;
      min-width: 220px;
    }

    .section-divider {
      margin-top: 8px;
      border-top: none;
      padding-top: 16px;
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .inline input,
    .inline select,
    .inline textarea {
      width: auto;
      flex: 1 1 120px;
      min-width: 0;
    }

    .inline .helper {
      white-space: nowrap;
    }

    .tag {
      background: rgba(99, 102, 241, 0.12);
      color: #4338ca;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
    }

    .client-only { display: none; }
    .advanced-only { display: none; }

    body.mode-client .client-only { display: block; }
    body.mode-advanced .advanced-only { display: block; }

    @media (max-width: 980px) {
      .content {
        flex-direction: column;
        padding-bottom: 160px;
      }

      .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        padding: 16px;
        z-index: 20;
      }

      .summary {
        border-radius: 22px 22px 0 0;
        background: var(--glass-strong);
      }

      .drawer {
        display: block;
        margin-bottom: 6px;
      }
    }
  </style>
</head>
<body class="mode-client">
  <div class="app">
    <header>
      <div>
        <h1>Calculateur de devis modulable</h1>
        <p class="subtle">Visuels 3D · Design intérieur · Design extérieur</p>
      </div>
      <div class="inline">
        <div class="toggle-group" role="tablist" aria-label="Mode">
          <button class="toggle-btn active" id="mode-client">Client</button>
          <button class="toggle-btn" id="mode-advanced">Avancé</button>
        </div>
        <button class="btn advanced-only" id="open-settings" type="button">⚙ Paramètres</button>
      </div>
    </header>

    <div class="content">
      <main style="display: flex; flex-direction: column; gap: 24px;">
        <section class="glass panel" aria-label="Identité">
          <h2>Projet</h2>
          <div class="grid">
            <div>
              <label for="client-name">Nom client / Projet</label>
              <input id="client-name" type="text" placeholder="Villa Oceanis" autocomplete="off" />
            </div>
            <div>
              <label for="currency">Devise d'affichage</label>
              <div class="toggle-group" role="tablist" aria-label="Devise">
                <button class="toggle-btn active" id="currency-mga">MGA</button>
                <button class="toggle-btn" id="currency-eur">EUR</button>
              </div>
              <p class="helper">Interne en MGA. Conversion affichée automatiquement.</p>
            </div>
          </div>
        </section>

      <section class="glass panel" aria-label="Service">
        <h2>Service & volume</h2>
        <div class="grid">
          <div>
            <label for="service">Service</label>
            <select id="service">
              <option value="visual">Visuels 3D</option>
              <option value="interior">Design intérieur</option>
              <option value="exterior">Design extérieur</option>
            </select>
          </div>
          <div>
            <label for="pack">Pack</label>
            <select id="pack">
              <option value="concept">Concept</option>
              <option value="standard" selected>Standard</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <div>
            <label for="nb-visuels">Nombre de visuels finaux</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="nb-visuels">-</button>
              <input id="nb-visuels" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="nb-visuels">+</button>
            </div>
          </div>
          <div class="client-only">
            <label for="client-level">Niveau (mode client)</label>
            <select id="client-level">
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
            </select>
            <p class="helper">Estimation claire, sans jargon.</p>
          </div>
        </div>
        <div class="grid" id="volume-interior">
          <div>
            <label>Pièces Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-small">-</button>
              <input id="pieces-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-small">+</button>
            </div>
          </div>
          <div>
            <label>Pièces Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-medium">-</button>
              <input id="pieces-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-medium">+</button>
            </div>
          </div>
          <div>
            <label>Pièces Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-large">-</button>
              <input id="pieces-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-large">+</button>
            </div>
          </div>
        </div>
        <div class="grid" id="volume-exterior">
          <div>
            <label>Zones Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-small">-</button>
              <input id="zones-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-small">+</button>
            </div>
          </div>
          <div>
            <label>Zones Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-medium">-</button>
              <input id="zones-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-medium">+</button>
            </div>
          </div>
          <div>
            <label>Zones Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-large">-</button>
              <input id="zones-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-large">+</button>
            </div>
          </div>
        </div>
        <div class="grid" id="volume-scenes">
          <div>
            <label>Scènes Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-small">-</button>
              <input id="scenes-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-small">+</button>
            </div>
          </div>
          <div>
            <label>Scènes Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-medium">-</button>
              <input id="scenes-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-medium">+</button>
            </div>
          </div>
          <div>
            <label>Scènes Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-large">-</button>
              <input id="scenes-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-large">+</button>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-item">
            <label class="checkbox">
              <input type="checkbox" id="toggle-m2" />
              Mesure en m² (optionnel)
            </label>
            <p class="helper">Remplace les pièces/zones par un calcul au m².</p>
          </div>
          <div class="form-item" id="m2-field">
            <label for="m2-value">Surface (m²)</label>
            <input id="m2-value" type="number" min="0" value="0" />
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Paramètres créatifs">
        <h2>Niveau de prestation</h2>
        <div class="grid advanced-only">
          <div>
            <label for="complexity">Complexité</label>
            <select id="complexity">
              <option value="simple">Simple</option>
              <option value="standard" selected>Standard</option>
              <option value="complex">Complexe</option>
            </select>
          </div>
          <div>
            <label for="details">Détails</label>
            <select id="details">
              <option value="concept">Concept</option>
              <option value="realistic" selected>Réaliste</option>
              <option value="photoreal">Photoreal</option>
            </select>
          </div>
          <div>
            <label for="usage">Usage</label>
            <select id="usage">
              <option value="personal">Perso</option>
              <option value="commercial" selected>Commercial</option>
              <option value="ads">Publicité</option>
            </select>
          </div>
          <div>
            <label for="delay">Délais</label>
            <select id="delay">
              <option value="standard">Standard</option>
              <option value="express">Express</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>
        <div class="client-only">
          <p class="helper">Estimation indicative — devis final après validation du brief.</p>
        </div>
      </section>

      <section class="glass panel" aria-label="Options">
        <h2>Options</h2>
        <div class="options">
          <label class="checkbox"><input type="checkbox" id="opt-moodboard" /> Moodboard</label>
          <label class="checkbox"><input type="checkbox" id="opt-plan" /> Plan 2D</label>
          <label class="checkbox"><input type="checkbox" id="opt-shopping" /> Shopping list</label>
          <label class="checkbox advanced-only"><input type="checkbox" id="opt-modeling" /> Modélisation sur mesure</label>
          <label class="checkbox advanced-only"><input type="checkbox" id="opt-furniture" /> Mobilier / déco</label>
          <label class="checkbox advanced-only"><input type="checkbox" id="opt-landscape" /> Paysage / végétation</label>
          <label class="checkbox"><input type="checkbox" id="opt-4k" /> Rendu 4K</label>
          <label class="checkbox advanced-only"><input type="checkbox" id="opt-sources" /> Fichiers sources</label>
        </div>
        <div class="grid">
          <div>
            <label class="checkbox"><input type="checkbox" id="opt-animation" /> Animation</label>
            <div class="inline" id="anim-block" style="display:none;">
              <input id="anim-seconds" type="number" min="0" max="120" value="0" />
              <span class="helper">secondes (0-120)</span>
            </div>
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Retours">
        <h2>Retours & logistique</h2>
        <div class="form-row">
          <div class="form-item">
            <label for="cycles">
              Cycles de retours demandés
              <span class="helper">(Cycles inclus : <strong id="cycles-included">2</strong>)</span>
            </label>
            <input id="cycles" type="number" min="1" value="2" />
          </div>
          <div class="form-item">
            <label class="checkbox"><input type="checkbox" id="opt-travel" /> Déplacement</label>
            <div class="inline" id="travel-block" style="display:none;">
              <input id="travel-km" type="number" min="0" value="0" />
              <span class="helper">km</span>
            </div>
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="TVA">
        <h2>TVA & conversion</h2>
        <div class="form-row">
          <div class="form-item">
            <label class="checkbox"><input type="checkbox" id="toggle-tva" /> Ajouter TVA</label>
            <div class="inline">
              <input id="tva-rate" type="number" min="0" value="0" />
              <span class="helper">%</span>
            </div>
          </div>
          <div class="form-item">
            <label for="rate">Taux EUR → MGA</label>
            <input id="rate" type="number" min="0" value="4800" />
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Export">
        <h2>Export devis</h2>
        <div class="inline">
          <button class="btn btn-primary" id="copy-quote" type="button">Copier le devis</button>
          <button class="btn" id="download-quote" type="button">Télécharger .txt</button>
        </div>
      </section>
      </main>

      <aside class="sidebar">
        <div class="glass summary">
          <div class="drawer">
            <span class="tag">Récapitulatif</span>
          </div>
          <div class="total">
            <span class="subtle" id="total-label">Total HT</span>
            <strong id="total-main">0 Ar</strong>
            <span class="helper" id="total-alt">≈ 0 €</span>
          </div>
          <div class="alert" id="empty-warning">Ajoute au moins 1 pièce, 1 scène ou 1 visuel.</div>
          <div class="pill" id="minimum-pill" style="display:none;">Minimum appliqué</div>
          <div class="summary-list client-only" id="summary-client">
            <div class="summary-item"><span>Service</span><span id="sum-service"></span></div>
            <div class="summary-item"><span>Pack</span><span id="sum-pack"></span></div>
            <div class="summary-item"><span>Pièces/scènes</span><span id="sum-volumes"></span></div>
            <div class="summary-item"><span>Visuels</span><span id="sum-visuels"></span></div>
            <div class="summary-item"><span>Délais</span><span id="sum-delay"></span></div>
            <div class="summary-item"><span>Cycles inclus</span><span id="sum-cycles"></span></div>
            <div class="summary-item"><span>Total</span><span id="sum-total"></span></div>
            <div class="summary-item sub" id="sum-note">Estimation indicative — devis final après validation du brief.</div>
          </div>
          <div class="summary-list advanced-only" id="summary-advanced"></div>
        </div>
      </aside>
    </div>
  </div>

  <div class="settings-overlay" id="settings-overlay" aria-modal="true" role="dialog">
    <div class="settings-panel">
      <div class="inline" style="justify-content: space-between;">
        <h2>Paramètres</h2>
        <div class="inline">
          <button class="btn" id="export-config" type="button">Exporter JSON</button>
          <label class="btn" style="cursor:pointer;">
            Importer JSON
            <input type="file" id="import-config" accept="application/json" style="display:none;" />
          </label>
          <button class="btn" id="reset-config" type="button">Réinitialiser</button>
          <button class="btn btn-primary" id="save-config" type="button">Sauvegarder</button>
        </div>
      </div>
      <div id="settings-form" class="section-divider"></div>
    </div>
  </div>

  <script>
    const CONFIG_DEFAULT = {
      base: { visual: 250000, interior: 300000, exterior: 350000 },
      packs: {
        interior: {
          concept: { small: 250000, medium: 420000, large: 650000 },
          standard: { small: 380000, medium: 650000, large: 980000 },
          premium: { small: 520000, medium: 920000, large: 1400000 }
        },
        exterior: {
          concept: { small: 320000, medium: 560000, large: 900000 },
          standard: { small: 480000, medium: 850000, large: 1350000 },
          premium: { small: 650000, medium: 1200000, large: 1900000 }
        }
      },
      scenes: { small: 220000, medium: 420000, large: 850000 },
      visual_tiers: {
        concept: [
          { upTo: 2, unit: 180000 },
          { upTo: 6, unit: 140000 },
          { upTo: 12, unit: 110000 },
          { upTo: Infinity, unit: 90000 }
        ],
        realistic: [
          { upTo: 2, unit: 320000 },
          { upTo: 6, unit: 260000 },
          { upTo: 12, unit: 210000 },
          { upTo: Infinity, unit: 170000 }
        ],
        photoreal: [
          { upTo: 2, unit: 560000 },
          { upTo: 6, unit: 450000 },
          { upTo: 12, unit: 360000 },
          { upTo: Infinity, unit: 290000 }
        ]
      },
      render_tiers: {
        interior: [
          { upTo: 2, unit: 260000 },
          { upTo: 6, unit: 210000 },
          { upTo: 12, unit: 170000 },
          { upTo: Infinity, unit: 140000 }
        ],
        exterior: [
          { upTo: 2, unit: 300000 },
          { upTo: 6, unit: 240000 },
          { upTo: 12, unit: 200000 },
          { upTo: Infinity, unit: 160000 }
        ]
      },
      visual_unit: { concept: 180000, realistic: 320000, photoreal: 560000 },
      render_unit: { interior: 260000, exterior: 300000 },
      multipliers: {
        complexity: { simple: 1.0, standard: 1.2, complex: 1.5 },
        details: { concept: 1.0, realistic: 1.25, photoreal: 1.6 },
        delay: { standard: 1.0, express: 1.2, urgent: 1.35 },
        usage: { personal: 1.0, commercial: 1.15, ads: 1.3 }
      },
      options: {
        moodboard: 120000,
        plan2d: 220000,
        shopping: 150000,
        modeling_pct: 0.2,
        furniture_pct: 0.15,
        landscape_pct: 0.18,
        render4k_pct: 0.1,
        sources_pct: 0.2,
        animation_sec: 40000
      },
      revisions: { included: 2, rate: 0.1 },
      travel: { flat: 50000, km: 1500 },
      minimum: 350000,
      vat_rate: 0,
      eur_mga_rate: 4800,
      toggles: {
        enable_visual_tiers: true,
        enable_render_tiers: true,
        enable_tiered_m2: true
      },
      tiered_m2: [
        { upTo: 30, unit: 18000 },
        { upTo: 80, unit: 14000 },
        { upTo: Infinity, unit: 11000 }
      ],
      client_mapping: {
        standard: { complexity: "standard", details: "realistic", usage: "commercial", delay: "standard" },
        premium: { complexity: "standard", details: "photoreal", usage: "commercial", delay: "standard" }
      }
    };

    const UI_DEFAULT = {
      mode: "client",
      currency: "MGA",
      showTva: false
    };

    let CONFIG = loadConfig();
    let UI_STATE = loadUIState();

    const elements = {
      modeClient: document.getElementById("mode-client"),
      modeAdvanced: document.getElementById("mode-advanced"),
      service: document.getElementById("service"),
      pack: document.getElementById("pack"),
      nbVisuels: document.getElementById("nb-visuels"),
      piecesSmall: document.getElementById("pieces-small"),
      piecesMedium: document.getElementById("pieces-medium"),
      piecesLarge: document.getElementById("pieces-large"),
      zonesSmall: document.getElementById("zones-small"),
      zonesMedium: document.getElementById("zones-medium"),
      zonesLarge: document.getElementById("zones-large"),
      scenesSmall: document.getElementById("scenes-small"),
      scenesMedium: document.getElementById("scenes-medium"),
      scenesLarge: document.getElementById("scenes-large"),
      clientLevel: document.getElementById("client-level"),
      complexity: document.getElementById("complexity"),
      details: document.getElementById("details"),
      usage: document.getElementById("usage"),
      delay: document.getElementById("delay"),
      toggleM2: document.getElementById("toggle-m2"),
      m2Value: document.getElementById("m2-value"),
      toggleTva: document.getElementById("toggle-tva"),
      tvaRate: document.getElementById("tva-rate"),
      rate: document.getElementById("rate"),
      cycles: document.getElementById("cycles"),
      optTravel: document.getElementById("opt-travel"),
      travelKm: document.getElementById("travel-km"),
      optMoodboard: document.getElementById("opt-moodboard"),
      optPlan: document.getElementById("opt-plan"),
      optShopping: document.getElementById("opt-shopping"),
      optModeling: document.getElementById("opt-modeling"),
      optFurniture: document.getElementById("opt-furniture"),
      optLandscape: document.getElementById("opt-landscape"),
      opt4k: document.getElementById("opt-4k"),
      optSources: document.getElementById("opt-sources"),
      optAnimation: document.getElementById("opt-animation"),
      animSeconds: document.getElementById("anim-seconds"),
      clientName: document.getElementById("client-name"),
      currencyMga: document.getElementById("currency-mga"),
      currencyEur: document.getElementById("currency-eur"),
      summaryClient: document.getElementById("summary-client"),
      summaryAdvanced: document.getElementById("summary-advanced"),
      totalMain: document.getElementById("total-main"),
      totalAlt: document.getElementById("total-alt"),
      totalLabel: document.getElementById("total-label"),
      sumService: document.getElementById("sum-service"),
      sumPack: document.getElementById("sum-pack"),
      sumVolumes: document.getElementById("sum-volumes"),
      sumVisuels: document.getElementById("sum-visuels"),
      sumDelay: document.getElementById("sum-delay"),
      sumCycles: document.getElementById("sum-cycles"),
      sumTotal: document.getElementById("sum-total"),
      cyclesIncluded: document.getElementById("cycles-included"),
      minimumPill: document.getElementById("minimum-pill"),
      emptyWarning: document.getElementById("empty-warning"),
      animBlock: document.getElementById("anim-block"),
      travelBlock: document.getElementById("travel-block"),
      volumeInterior: document.getElementById("volume-interior"),
      volumeExterior: document.getElementById("volume-exterior"),
      volumeScenes: document.getElementById("volume-scenes"),
      m2Field: document.getElementById("m2-field"),
      openSettings: document.getElementById("open-settings"),
      settingsOverlay: document.getElementById("settings-overlay"),
      settingsForm: document.getElementById("settings-form"),
      saveConfig: document.getElementById("save-config"),
      resetConfig: document.getElementById("reset-config"),
      exportConfig: document.getElementById("export-config"),
      importConfig: document.getElementById("import-config"),
      copyQuote: document.getElementById("copy-quote"),
      downloadQuote: document.getElementById("download-quote")
    };

    function loadConfig() {
      const stored = localStorage.getItem("tk_quote_calc_config_v1");
      if (!stored) return structuredClone(CONFIG_DEFAULT);
      try {
        const parsed = JSON.parse(stored);
        if (!parsed.base || !parsed.packs || !parsed.multipliers) {
          throw new Error("Invalid config");
        }
        return parsed;
      } catch (error) {
        showToast("Configuration locale invalide. Valeurs par défaut appliquées.");
        return structuredClone(CONFIG_DEFAULT);
      }
    }

    function saveConfig() {
      localStorage.setItem("tk_quote_calc_config_v1", JSON.stringify(CONFIG));
    }

    function resetConfig() {
      CONFIG = structuredClone(CONFIG_DEFAULT);
      saveConfig();
      buildSettingsForm();
      calculateAndRender();
    }

    function loadUIState() {
      const stored = localStorage.getItem("tk_quote_calc_ui_v1");
      if (!stored) return { ...UI_DEFAULT };
      try {
        return { ...UI_DEFAULT, ...JSON.parse(stored) };
      } catch (error) {
        return { ...UI_DEFAULT };
      }
    }

    function saveUIState() {
      localStorage.setItem("tk_quote_calc_ui_v1", JSON.stringify(UI_STATE));
    }

    function showToast(message) {
      const alert = document.createElement("div");
      alert.textContent = message;
      alert.style.position = "fixed";
      alert.style.bottom = "24px";
      alert.style.right = "24px";
      alert.style.padding = "12px 16px";
      alert.style.background = "rgba(15, 23, 42, 0.9)";
      alert.style.color = "#fff";
      alert.style.borderRadius = "12px";
      alert.style.zIndex = "40";
      alert.style.fontSize = "0.85rem";
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3200);
    }

    function applyTieredPricing(qty, tiers) {
      let remaining = qty;
      let total = 0;
      let previousLimit = 0;
      for (const tier of tiers) {
        const tierLimit = tier.upTo === Infinity ? remaining : Math.max(0, tier.upTo - previousLimit);
        const units = Math.min(remaining, tierLimit);
        if (units <= 0) {
          previousLimit = tier.upTo;
          continue;
        }
        total += units * tier.unit;
        remaining -= units;
        previousLimit = tier.upTo;
        if (remaining <= 0) break;
      }
      return total;
    }

    function formatCurrency(valueMga) {
      const rate = Number(elements.rate.value) || CONFIG.eur_mga_rate;
      const displayCurrency = UI_STATE.currency;
      if (displayCurrency === "MGA") {
        return `${Math.round(valueMga).toLocaleString("fr-FR")} Ar`;
      }
      const eur = valueMga / rate;
      return `${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
    }

    function formatAltCurrency(valueMga) {
      const rate = Number(elements.rate.value) || CONFIG.eur_mga_rate;
      if (UI_STATE.currency === "MGA") {
        const eur = valueMga / rate;
        return `≈ ${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
      }
      return `≈ ${Math.round(valueMga).toLocaleString("fr-FR")} Ar`;
    }

    function getVolumes() {
      return {
        pieces: {
          small: Math.max(0, Number(elements.piecesSmall.value) || 0),
          medium: Math.max(0, Number(elements.piecesMedium.value) || 0),
          large: Math.max(0, Number(elements.piecesLarge.value) || 0)
        },
        zones: {
          small: Math.max(0, Number(elements.zonesSmall.value) || 0),
          medium: Math.max(0, Number(elements.zonesMedium.value) || 0),
          large: Math.max(0, Number(elements.zonesLarge.value) || 0)
        },
        scenes: {
          small: Math.max(0, Number(elements.scenesSmall.value) || 0),
          medium: Math.max(0, Number(elements.scenesMedium.value) || 0),
          large: Math.max(0, Number(elements.scenesLarge.value) || 0)
        }
      };
    }

    function applyUIState() {
      const form = UI_STATE.form || {};
      elements.service.value = form.service || "visual";
      elements.pack.value = form.pack || "standard";
      elements.nbVisuels.value = form.nbVisuels ?? 0;
      elements.piecesSmall.value = form.piecesSmall ?? 0;
      elements.piecesMedium.value = form.piecesMedium ?? 0;
      elements.piecesLarge.value = form.piecesLarge ?? 0;
      elements.zonesSmall.value = form.zonesSmall ?? 0;
      elements.zonesMedium.value = form.zonesMedium ?? 0;
      elements.zonesLarge.value = form.zonesLarge ?? 0;
      elements.scenesSmall.value = form.scenesSmall ?? 0;
      elements.scenesMedium.value = form.scenesMedium ?? 0;
      elements.scenesLarge.value = form.scenesLarge ?? 0;
      elements.clientLevel.value = form.clientLevel || "standard";
      elements.complexity.value = form.complexity || "standard";
      elements.details.value = form.details || "realistic";
      elements.usage.value = form.usage || "commercial";
      elements.delay.value = form.delay || "standard";
      elements.toggleM2.checked = form.toggleM2 ?? false;
      elements.m2Value.value = form.m2Value ?? 0;
      elements.cycles.value = form.cycles ?? 2;
      elements.optTravel.checked = form.optTravel ?? false;
      elements.travelKm.value = form.travelKm ?? 0;
      elements.optMoodboard.checked = form.optMoodboard ?? false;
      elements.optPlan.checked = form.optPlan ?? false;
      elements.optShopping.checked = form.optShopping ?? false;
      elements.optModeling.checked = form.optModeling ?? false;
      elements.optFurniture.checked = form.optFurniture ?? false;
      elements.optLandscape.checked = form.optLandscape ?? false;
      elements.opt4k.checked = form.opt4k ?? false;
      elements.optSources.checked = form.optSources ?? false;
      elements.optAnimation.checked = form.optAnimation ?? false;
      elements.animSeconds.value = form.animSeconds ?? 0;
      elements.clientName.value = form.clientName || "";
      elements.tvaRate.value = form.tvaRate ?? CONFIG.vat_rate;
      elements.rate.value = form.rate ?? CONFIG.eur_mga_rate;
    }

    function syncStateFromInputs() {
      UI_STATE.form = {
        service: elements.service.value,
        pack: elements.pack.value,
        nbVisuels: Number(elements.nbVisuels.value) || 0,
        piecesSmall: Number(elements.piecesSmall.value) || 0,
        piecesMedium: Number(elements.piecesMedium.value) || 0,
        piecesLarge: Number(elements.piecesLarge.value) || 0,
        zonesSmall: Number(elements.zonesSmall.value) || 0,
        zonesMedium: Number(elements.zonesMedium.value) || 0,
        zonesLarge: Number(elements.zonesLarge.value) || 0,
        scenesSmall: Number(elements.scenesSmall.value) || 0,
        scenesMedium: Number(elements.scenesMedium.value) || 0,
        scenesLarge: Number(elements.scenesLarge.value) || 0,
        clientLevel: elements.clientLevel.value,
        complexity: elements.complexity.value,
        details: elements.details.value,
        usage: elements.usage.value,
        delay: elements.delay.value,
        toggleM2: elements.toggleM2.checked,
        m2Value: Number(elements.m2Value.value) || 0,
        cycles: Number(elements.cycles.value) || 1,
        optTravel: elements.optTravel.checked,
        travelKm: Number(elements.travelKm.value) || 0,
        optMoodboard: elements.optMoodboard.checked,
        optPlan: elements.optPlan.checked,
        optShopping: elements.optShopping.checked,
        optModeling: elements.optModeling.checked,
        optFurniture: elements.optFurniture.checked,
        optLandscape: elements.optLandscape.checked,
        opt4k: elements.opt4k.checked,
        optSources: elements.optSources.checked,
        optAnimation: elements.optAnimation.checked,
        animSeconds: Number(elements.animSeconds.value) || 0,
        clientName: elements.clientName.value,
        tvaRate: Number(elements.tvaRate.value) || 0,
        rate: Number(elements.rate.value) || CONFIG.eur_mga_rate
      };
    }

    function getSelectedMultipliers(service) {
      if (UI_STATE.mode === "client") {
        const mapping = CONFIG.client_mapping[elements.clientLevel.value] || CONFIG.client_mapping.standard;
        return {
          complexity: mapping.complexity,
          details: mapping.details,
          usage: mapping.usage,
          delay: mapping.delay
        };
      }
      return {
        complexity: elements.complexity.value,
        details: elements.details.value,
        usage: elements.usage.value,
        delay: elements.delay.value
      };
    }

    function calculate() {
      const service = elements.service.value;
      const pack = elements.pack.value;
      const nbVisuels = Math.max(0, Number(elements.nbVisuels.value) || 0);
      const volumes = getVolumes();
      const m2Enabled = elements.toggleM2.checked && CONFIG.toggles.enable_tiered_m2;
      const m2Value = Math.max(0, Number(elements.m2Value.value) || 0);
      const multipliersSelected = getSelectedMultipliers(service);

      let base = CONFIG.base[service === "visual" ? "visual" : service];
      let production = 0;
      let productionDetail = {
        pieces: 0,
        scenes: 0,
        visuals: 0,
        renders: 0,
        m2: 0
      };

      if (service === "visual") {
        productionDetail.scenes =
          volumes.scenes.small * CONFIG.scenes.small +
          volumes.scenes.medium * CONFIG.scenes.medium +
          volumes.scenes.large * CONFIG.scenes.large;
        if (CONFIG.toggles.enable_visual_tiers) {
          productionDetail.visuals = applyTieredPricing(nbVisuels, CONFIG.visual_tiers[multipliersSelected.details]);
        } else {
          productionDetail.visuals = nbVisuels * CONFIG.visual_unit[multipliersSelected.details];
        }
        production = productionDetail.scenes + productionDetail.visuals;
      }

      if (service === "interior") {
        if (m2Enabled) {
          productionDetail.m2 = applyTieredPricing(m2Value, CONFIG.tiered_m2);
          production = productionDetail.m2;
        } else {
          const pricing = CONFIG.packs.interior[pack];
          productionDetail.pieces =
            volumes.pieces.small * pricing.small +
            volumes.pieces.medium * pricing.medium +
            volumes.pieces.large * pricing.large;
          production = productionDetail.pieces;
        }
        if (nbVisuels > 0) {
          productionDetail.renders = CONFIG.toggles.enable_render_tiers
            ? applyTieredPricing(nbVisuels, CONFIG.render_tiers.interior)
            : nbVisuels * CONFIG.render_unit.interior;
          production += productionDetail.renders;
        }
      }

      if (service === "exterior") {
        if (m2Enabled) {
          productionDetail.m2 = applyTieredPricing(m2Value, CONFIG.tiered_m2);
          production = productionDetail.m2;
        } else {
          const pricing = CONFIG.packs.exterior[pack];
          productionDetail.pieces =
            volumes.zones.small * pricing.small +
            volumes.zones.medium * pricing.medium +
            volumes.zones.large * pricing.large;
          production = productionDetail.pieces;
        }
        if (nbVisuels > 0) {
          productionDetail.renders = CONFIG.toggles.enable_render_tiers
            ? applyTieredPricing(nbVisuels, CONFIG.render_tiers.exterior)
            : nbVisuels * CONFIG.render_unit.exterior;
          production += productionDetail.renders;
        }
      }

      const multiplierTotal =
        CONFIG.multipliers.complexity[multipliersSelected.complexity] *
        CONFIG.multipliers.details[multipliersSelected.details] *
        CONFIG.multipliers.delay[multipliersSelected.delay] *
        CONFIG.multipliers.usage[multipliersSelected.usage];

      const subTotal = (base + production) * multiplierTotal;

      let options = 0;
      if (elements.optMoodboard.checked) options += CONFIG.options.moodboard;
      if (elements.optPlan.checked) options += CONFIG.options.plan2d;
      if (elements.optShopping.checked) options += CONFIG.options.shopping;
      if (elements.optModeling.checked) options += production * CONFIG.options.modeling_pct;
      if (elements.optFurniture.checked) options += production * CONFIG.options.furniture_pct;
      if (elements.optLandscape.checked) options += production * CONFIG.options.landscape_pct;
      if (elements.opt4k.checked) options += production * CONFIG.options.render4k_pct;
      if (elements.optSources.checked) options += subTotal * CONFIG.options.sources_pct;
      if (elements.optAnimation.checked) {
        const seconds = Math.min(120, Math.max(0, Number(elements.animSeconds.value) || 0));
        options += seconds * CONFIG.options.animation_sec;
      }

      const cyclesAsked = Math.max(1, Number(elements.cycles.value) || 1);
      const cyclesExtra = Math.max(0, cyclesAsked - CONFIG.revisions.included);
      const revisions = cyclesExtra * (base + production) * CONFIG.revisions.rate;

      let fees = 0;
      if (elements.optTravel.checked) {
        fees = CONFIG.travel.flat + (Number(elements.travelKm.value) || 0) * CONFIG.travel.km;
      }

      const totalBrut = subTotal + options + revisions + fees;
      const totalFinal = Math.max(CONFIG.minimum, totalBrut);
      const minimumApplied = totalBrut < CONFIG.minimum;
      const tvaRate = elements.toggleTva.checked ? Number(elements.tvaRate.value) || 0 : 0;
      const tvaAmount = totalFinal * (tvaRate / 100);
      const totalTtc = totalFinal + tvaAmount;

      return {
        service,
        pack,
        nbVisuels,
        volumes,
        m2Enabled,
        m2Value,
        multipliersSelected,
        base,
        production,
        productionDetail,
        multiplierTotal,
        subTotal,
        options,
        revisions,
        fees,
        totalBrut,
        minimumApplied,
        totalFinal,
        tvaRate,
        tvaAmount,
        totalTtc
      };
    }

    function render(data) {
      const displayTotal = elements.toggleTva.checked ? data.totalTtc : data.totalFinal;
      elements.totalMain.textContent = formatCurrency(displayTotal);
      elements.totalAlt.textContent = formatAltCurrency(displayTotal);
      elements.totalLabel.textContent = elements.toggleTva.checked ? "Total TTC" : "Total HT";

      const serviceLabel = {
        visual: "Visuels 3D",
        interior: "Design intérieur",
        exterior: "Design extérieur"
      };

      elements.sumService.textContent = serviceLabel[data.service];
      elements.sumPack.textContent = data.service === "visual" ? "—" : data.pack;
      const totalPieces =
        data.service === "visual"
          ? data.volumes.scenes.small + data.volumes.scenes.medium + data.volumes.scenes.large
          : data.service === "interior"
          ? data.volumes.pieces.small + data.volumes.pieces.medium + data.volumes.pieces.large
          : data.volumes.zones.small + data.volumes.zones.medium + data.volumes.zones.large;
      elements.sumVolumes.textContent = data.m2Enabled ? `${data.m2Value} m²` : totalPieces;
      elements.sumVisuels.textContent = data.nbVisuels;
      elements.sumDelay.textContent = data.multipliersSelected.delay;
      elements.sumCycles.textContent = CONFIG.revisions.included;
      elements.sumTotal.textContent = formatCurrency(displayTotal);
      elements.minimumPill.style.display = data.minimumApplied ? "inline-flex" : "none";
      const isEmpty = totalPieces === 0 && data.nbVisuels === 0 && (!data.m2Enabled || data.m2Value === 0);
      elements.emptyWarning.style.display = isEmpty ? "block" : "none";

      elements.summaryAdvanced.innerHTML = `
        <div class="summary-item"><span>Base</span><span>${formatCurrency(data.base)}</span></div>
        <div class="summary-item"><span>Production</span><span>${formatCurrency(data.production)}</span></div>
        ${data.productionDetail.pieces ? `<div class="summary-item sub"><span>Pièces/Zones</span><span>${formatCurrency(data.productionDetail.pieces)}</span></div>` : ""}
        ${data.productionDetail.scenes ? `<div class="summary-item sub"><span>Scènes</span><span>${formatCurrency(data.productionDetail.scenes)}</span></div>` : ""}
        ${data.productionDetail.visuals ? `<div class="summary-item sub"><span>Visuels</span><span>${formatCurrency(data.productionDetail.visuals)}</span></div>` : ""}
        ${data.productionDetail.renders ? `<div class="summary-item sub"><span>Rendus</span><span>${formatCurrency(data.productionDetail.renders)}</span></div>` : ""}
        ${data.productionDetail.m2 ? `<div class="summary-item sub"><span>m²</span><span>${formatCurrency(data.productionDetail.m2)}</span></div>` : ""}
        <div class="summary-item"><span>Multiplicateur</span><span>x${data.multiplierTotal.toFixed(2)}</span></div>
        <div class="summary-item"><span>Sous-total</span><span>${formatCurrency(data.subTotal)}</span></div>
        <div class="summary-item"><span>Options</span><span>${formatCurrency(data.options)}</span></div>
        <div class="summary-item"><span>Retours</span><span>${formatCurrency(data.revisions)}</span></div>
        <div class="summary-item"><span>Frais</span><span>${formatCurrency(data.fees)}</span></div>
        <div class="summary-item"><span>Total brut</span><span>${formatCurrency(data.totalBrut)}</span></div>
        ${data.minimumApplied ? `<div class="summary-item"><span>Minimum appliqué</span><span>${formatCurrency(CONFIG.minimum)}</span></div>` : ""}
        <div class="summary-item"><span>Total final</span><span>${formatCurrency(data.totalFinal)}</span></div>
        ${elements.toggleTva.checked ? `<div class="summary-item"><span>TVA (${data.tvaRate}%)</span><span>${formatCurrency(data.tvaAmount)}</span></div>` : ""}
      `;

    }

    function setGroupDisabled(container, disabled) {
      container.classList.toggle("is-disabled", disabled);
      container.setAttribute("aria-disabled", disabled ? "true" : "false");
      container.querySelectorAll("input, select, textarea, button").forEach(control => {
        control.disabled = disabled;
      });
    }

    function updateVisibility() {
      const service = elements.service.value;
      const m2Active = elements.toggleM2.checked && service !== "visual";
      setGroupDisabled(elements.volumeInterior, service !== "interior" || m2Active);
      setGroupDisabled(elements.volumeExterior, service !== "exterior" || m2Active);
      setGroupDisabled(elements.volumeScenes, service !== "visual");
      elements.pack.disabled = service === "visual";
      elements.pack.style.opacity = service === "visual" ? 0.5 : 1;
      elements.animBlock.style.display = elements.optAnimation.checked ? "flex" : "none";
      elements.travelBlock.style.display = elements.optTravel.checked ? "flex" : "none";
      elements.toggleM2.disabled = service === "visual";
      elements.toggleM2.closest(".form-item").classList.toggle("is-disabled", service === "visual");
      if (service === "visual") elements.toggleM2.checked = false;
      setGroupDisabled(elements.m2Field, !(elements.toggleM2.checked && service !== "visual"));
      const landscapeLabel = elements.optLandscape.closest("label");
      setGroupDisabled(landscapeLabel, service === "interior");
    }

    function calculateAndRender() {
      updateVisibility();
      elements.cyclesIncluded.textContent = CONFIG.revisions.included;
      const data = calculate();
      render(data);
      syncStateFromInputs();
      saveUIState();
    }

    function bindSteppers() {
      document.querySelectorAll(".stepper button").forEach(button => {
        button.addEventListener("click", () => {
          const target = document.getElementById(button.dataset.target);
          const delta = Number(button.dataset.step);
          const current = Number(target.value) || 0;
          target.value = Math.max(0, current + delta);
          calculateAndRender();
        });
      });

    }

    function setMode(mode) {
      UI_STATE.mode = mode;
      document.body.className = `mode-${mode}`;
      elements.modeClient.classList.toggle("active", mode === "client");
      elements.modeAdvanced.classList.toggle("active", mode === "advanced");
      calculateAndRender();
    }

    function setCurrency(currency) {
      UI_STATE.currency = currency;
      elements.currencyMga.classList.toggle("active", currency === "MGA");
      elements.currencyEur.classList.toggle("active", currency === "EUR");
      calculateAndRender();
    }

    function buildSettingsForm() {
      const form = [];

      const addGroup = (title, inputs) => {
        form.push(`<div class="section-divider"><h3>${title}</h3><div class="settings-grid">${inputs.join("")}</div></div>`);
      };

      const inputField = (label, path, type = "number") => `
        <div>
          <label>${label}</label>
          <input data-path="${path}" type="${type}" />
        </div>`;

      addGroup("Bases", [
        inputField("Base visuel 3D", "base.visual"),
        inputField("Base intérieur", "base.interior"),
        inputField("Base extérieur", "base.exterior")
      ]);

      addGroup("Scènes 3D", [
        inputField("Scene small", "scenes.small"),
        inputField("Scene medium", "scenes.medium"),
        inputField("Scene large", "scenes.large")
      ]);

      addGroup("Pack intérieur - Concept", [
        inputField("Small", "packs.interior.concept.small"),
        inputField("Medium", "packs.interior.concept.medium"),
        inputField("Large", "packs.interior.concept.large")
      ]);

      addGroup("Pack intérieur - Standard", [
        inputField("Small", "packs.interior.standard.small"),
        inputField("Medium", "packs.interior.standard.medium"),
        inputField("Large", "packs.interior.standard.large")
      ]);

      addGroup("Pack intérieur - Premium", [
        inputField("Small", "packs.interior.premium.small"),
        inputField("Medium", "packs.interior.premium.medium"),
        inputField("Large", "packs.interior.premium.large")
      ]);

      addGroup("Pack extérieur - Concept", [
        inputField("Small", "packs.exterior.concept.small"),
        inputField("Medium", "packs.exterior.concept.medium"),
        inputField("Large", "packs.exterior.concept.large")
      ]);

      addGroup("Pack extérieur - Standard", [
        inputField("Small", "packs.exterior.standard.small"),
        inputField("Medium", "packs.exterior.standard.medium"),
        inputField("Large", "packs.exterior.standard.large")
      ]);

      addGroup("Pack extérieur - Premium", [
        inputField("Small", "packs.exterior.premium.small"),
        inputField("Medium", "packs.exterior.premium.medium"),
        inputField("Large", "packs.exterior.premium.large")
      ]);

      addGroup("Visuels 3D (unitaires)", [
        inputField("Concept", "visual_unit.concept"),
        inputField("Réaliste", "visual_unit.realistic"),
        inputField("Photoreal", "visual_unit.photoreal")
      ]);

      addGroup("Rendus unitaires", [
        inputField("Intérieur", "render_unit.interior"),
        inputField("Extérieur", "render_unit.exterior")
      ]);

      addGroup("Multiplicateurs", [
        inputField("Complexité simple", "multipliers.complexity.simple"),
        inputField("Complexité standard", "multipliers.complexity.standard"),
        inputField("Complexité complexe", "multipliers.complexity.complex"),
        inputField("Détails concept", "multipliers.details.concept"),
        inputField("Détails réaliste", "multipliers.details.realistic"),
        inputField("Détails photoreal", "multipliers.details.photoreal"),
        inputField("Délai standard", "multipliers.delay.standard"),
        inputField("Délai express", "multipliers.delay.express"),
        inputField("Délai urgent", "multipliers.delay.urgent"),
        inputField("Usage perso", "multipliers.usage.personal"),
        inputField("Usage commercial", "multipliers.usage.commercial"),
        inputField("Usage publicité", "multipliers.usage.ads")
      ]);

      addGroup("Options", [
        inputField("Moodboard", "options.moodboard"),
        inputField("Plan 2D", "options.plan2d"),
        inputField("Shopping list", "options.shopping"),
        inputField("Modélisation %", "options.modeling_pct"),
        inputField("Mobilier %", "options.furniture_pct"),
        inputField("Paysage %", "options.landscape_pct"),
        inputField("Rendu 4K %", "options.render4k_pct"),
        inputField("Sources %", "options.sources_pct"),
        inputField("Animation / sec", "options.animation_sec")
      ]);

      addGroup("Retours & frais", [
        inputField("Cycles inclus", "revisions.included"),
        inputField("Taux cycle", "revisions.rate"),
        inputField("Déplacement forfait", "travel.flat"),
        inputField("Prix km", "travel.km"),
        inputField("Minimum facturé", "minimum"),
        inputField("TVA défaut", "vat_rate"),
        inputField("Taux EUR-MGA", "eur_mga_rate")
      ]);

      addGroup("Toggles", [
        inputField("Tiers visuels", "toggles.enable_visual_tiers", "checkbox"),
        inputField("Tiers rendus", "toggles.enable_render_tiers", "checkbox"),
        inputField("Tiers m²", "toggles.enable_tiered_m2", "checkbox")
      ]);

      addGroup("Mapping mode client", [
        inputField("Standard → complexité", "client_mapping.standard.complexity", "text"),
        inputField("Standard → détails", "client_mapping.standard.details", "text"),
        inputField("Standard → usage", "client_mapping.standard.usage", "text"),
        inputField("Standard → délai", "client_mapping.standard.delay", "text"),
        inputField("Premium → complexité", "client_mapping.premium.complexity", "text"),
        inputField("Premium → détails", "client_mapping.premium.details", "text"),
        inputField("Premium → usage", "client_mapping.premium.usage", "text"),
        inputField("Premium → délai", "client_mapping.premium.delay", "text")
      ]);

      elements.settingsForm.innerHTML = form.join("");

      elements.settingsForm.querySelectorAll("input[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let value = CONFIG;
        path.forEach(key => {
          value = value[key];
        });
        if (input.type === "checkbox") {
          input.checked = Boolean(value);
        } else {
          input.value = value;
        }
      });
    }

    function readSettingsForm() {
      elements.settingsForm.querySelectorAll("input[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let target = CONFIG;
        for (let i = 0; i < path.length - 1; i++) {
          target = target[path[i]];
        }
        const key = path[path.length - 1];
        if (input.type === "checkbox") {
          target[key] = input.checked;
        } else if (input.type === "text") {
          target[key] = input.value;
        } else {
          target[key] = Number(input.value);
        }
      });
      saveConfig();
      calculateAndRender();
    }

    function openSettings() {
      buildSettingsForm();
      elements.settingsOverlay.style.display = "flex";
    }

    function closeSettings(event) {
      if (event.target === elements.settingsOverlay) {
        elements.settingsOverlay.style.display = "none";
      }
    }

    function exportConfig() {
      const blob = new Blob([JSON.stringify(CONFIG, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "config_devis.json";
      link.click();
    }

    function importConfig(file) {
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.base || !data.packs) throw new Error("JSON invalide");
          CONFIG = data;
          saveConfig();
          buildSettingsForm();
          calculateAndRender();
        } catch (error) {
          showToast("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function generateQuoteText(data) {
      const date = new Date().toLocaleDateString("fr-FR");
      const client = elements.clientName.value || "Client";
      const isClient = UI_STATE.mode === "client";
      const total = elements.toggleTva.checked ? data.totalTtc : data.totalFinal;
      const rate = Number(elements.rate.value) || CONFIG.eur_mga_rate;
      const totalEur = (total / rate).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      let text = `DEVIS ESTIMATIF - DESIGN 3D\n`;
      text += `Date: ${date}\n`;
      text += `Projet: ${client}\n`;
      text += `Service: ${data.service}\n`;
      text += `Pack: ${data.service === "visual" ? "-" : data.pack}\n`;
      text += `Visuels: ${data.nbVisuels}\n`;
      if (data.service === "visual") {
        text += `Scènes S/M/L: ${data.volumes.scenes.small}/${data.volumes.scenes.medium}/${data.volumes.scenes.large}\n`;
      } else if (data.m2Enabled) {
        text += `Surface: ${data.m2Value} m²\n`;
      } else if (data.service === "interior") {
        text += `Pièces S/M/L: ${data.volumes.pieces.small}/${data.volumes.pieces.medium}/${data.volumes.pieces.large}\n`;
      } else {
        text += `Zones S/M/L: ${data.volumes.zones.small}/${data.volumes.zones.medium}/${data.volumes.zones.large}\n`;
      }
      text += `Délai: ${data.multipliersSelected.delay}\n`;
      text += `Cycles inclus: ${CONFIG.revisions.included}\n`;

      if (!isClient) {
        text += `Multiplicateur total: x${data.multiplierTotal.toFixed(2)}\n`;
        text += `Base: ${Math.round(data.base)} Ar\n`;
        text += `Production: ${Math.round(data.production)} Ar\n`;
        text += `Options: ${Math.round(data.options)} Ar\n`;
        text += `Retours: ${Math.round(data.revisions)} Ar\n`;
        text += `Frais: ${Math.round(data.fees)} Ar\n`;
      }

      text += `Total ${elements.toggleTva.checked ? "TTC" : "HT"}: ${Math.round(total)} Ar\n`;
      text += `≈ ${totalEur} € (taux ${rate} Ar)\n`;
      text += `Estimation indicative — devis final après validation du brief.\n`;
      return text;
    }

    function copyQuote() {
      const data = calculate();
      const text = generateQuoteText(data);
      navigator.clipboard.writeText(text).then(() => showToast("Devis copié."));
    }

    function downloadQuote() {
      const data = calculate();
      const text = generateQuoteText(data);
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `devis_${new Date().toISOString().slice(0, 10)}.txt`;
      link.click();
    }

    function init() {
      setMode(UI_STATE.mode);
      setCurrency(UI_STATE.currency);
      elements.toggleTva.checked = UI_STATE.showTva;
      applyUIState();
      bindSteppers();

      document.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => {
          UI_STATE.showTva = elements.toggleTva.checked;
          calculateAndRender();
        });
        input.addEventListener("change", () => {
          UI_STATE.showTva = elements.toggleTva.checked;
          calculateAndRender();
        });
      });

      elements.modeClient.addEventListener("click", () => setMode("client"));
      elements.modeAdvanced.addEventListener("click", () => setMode("advanced"));
      elements.currencyMga.addEventListener("click", () => setCurrency("MGA"));
      elements.currencyEur.addEventListener("click", () => setCurrency("EUR"));
      elements.openSettings.addEventListener("click", openSettings);
      elements.settingsOverlay.addEventListener("click", closeSettings);
      elements.saveConfig.addEventListener("click", () => {
        readSettingsForm();
        elements.settingsOverlay.style.display = "none";
      });
      elements.resetConfig.addEventListener("click", resetConfig);
      elements.exportConfig.addEventListener("click", exportConfig);
      elements.importConfig.addEventListener("change", event => {
        if (event.target.files[0]) importConfig(event.target.files[0]);
      });
      elements.copyQuote.addEventListener("click", copyQuote);
      elements.downloadQuote.addEventListener("click", downloadQuote);

      calculateAndRender();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
