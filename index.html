<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Devis ‚Äî Design 3D & Architecture</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette Liquid Glass */
            --bg-gradient: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --glass-blur: blur(16px);
            
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --accent-color: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
            --danger: #ef4444;
            --success: #10b981;

            --radius-card: 24px;
            --radius-input: 12px;
            --transition: all 0.2s ease-in-out;
        }

        /* --- Global Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Noise Texture Overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
        }

        /* --- Utility Classes: Glassmorphism --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-card);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--glass-border);
            padding: 10px 20px;
            border-radius: var(--radius-input);
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            transition: var(--transition);
        }
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px var(--glass-border);
            transform: translateY(-1px);
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: #2563eb;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* --- Layout --- */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }

        /* --- Components --- */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 30px 0;
        }
        h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }

        /* Toggles */
        .toggle-group {
            display: flex;
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 50px;
        }
        .toggle-btn {
            padding: 6px 16px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: var(--transition);
        }
        .toggle-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: var(--accent-color);
        }

        /* Form Sections */
        .form-section {
            padding: 24px;
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
        }

        /* Inputs Grid */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        input[type="number"], input[type="text"], select {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid transparent;
            padding: 12px;
            border-radius: var(--radius-input);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }
        input:focus, select:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Checkbox Custom */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: var(--radius-input);
            cursor: pointer;
            transition: var(--transition);
        }
        .checkbox-wrapper:hover { background: rgba(255,255,255,0.6); }
        .checkbox-wrapper input { transform: scale(1.2); cursor: pointer; }

        /* --- Sticky Sidebar --- */
        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        .summary-card {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .total-display {
            text-align: right;
        }
        .total-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .total-amount { font-size: 2.5rem; font-weight: 700; color: var(--text-main); line-height: 1.1; }
        .total-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }
        
        .breakdown-list {
            list-style: none;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        .breakdown-item.main { font-weight: 600; color: var(--text-main); margin-top: 5px; }
        .breakdown-item.sub { color: var(--text-muted); padding-left: 10px; font-size: 0.85rem; }

        /* --- Settings Modal --- */
        #settings-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none; /* hidden by default */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .settings-group h4 { grid-column: 1 / -1; margin: 10px 0 5px; font-size: 0.9rem; color: var(--accent-color); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; }

        /* --- Hide/Show Elements based on Mode --- */
        body.mode-client .advanced-only { display: none !important; }
        body.mode-advanced .client-only { display: none !important; }

        /* --- Responsive --- */
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; padding-bottom: 120px; }
            .sidebar {
                position: fixed;
                bottom: 0; left: 0; right: 0;
                top: auto;
                z-index: 100;
                margin: 0;
                padding: 10px;
                background: transparent;
                pointer-events: none; /* Let clicks pass through margin areas */
            }
            .summary-card {
                pointer-events: auto;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(20px);
                border-top: 1px solid var(--glass-border);
                border-radius: 24px 24px 0 0;
                padding: 20px;
                box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
                /* Simplification for mobile */
                gap: 10px;
            }
            .breakdown-list { display: none; } /* Hide detailed breakdown on mobile/client by default, simplified view */
            body.mode-advanced .breakdown-list { display: flex; max-height: 150px; overflow-y: auto; }
            .total-amount { font-size: 1.8rem; }
        }
    </style>
</head>
<body class="mode-client">

    <div class="app-container">
        <header>
            <h1>Calculateur <span style="font-weight: 300; opacity: 0.7;">Devis 3D</span></h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="toggle-group">
                    <div class="toggle-btn active" id="btn-mode-client" onclick="setMode('client')">Client</div>
                    <div class="toggle-btn" id="btn-mode-advanced" onclick="setMode('advanced')">Avanc√©</div>
                </div>
                <button class="btn-glass advanced-only" onclick="openSettings()" title="Param√®tres">‚öô</button>
            </div>
        </header>

        <main>
            <div class="glass-panel form-section">
                <div class="input-grid">
                    <div class="form-group">
                        <label>Nom du Client / Projet</label>
                        <input type="text" id="client_name" placeholder="ex: Appartement Haussmannien">
                    </div>
                </div>
            </div>

            <div class="glass-panel form-section">
                <div class="section-title">üìê Service & Volume</div>
                <div class="input-grid">
                    <div class="form-group">
                        <label>Type de Service</label>
                        <select id="service_type" onchange="updateUI(); calculate()">
                            <option value="3d_visual">Visuel 3D (Rendu seul)</option>
                            <option value="interior">Design Int√©rieur</option>
                            <option value="exterior">Design Ext√©rieur</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="group-rooms">
                        <label>Nombre de pi√®ces (int√©rieur)</label>
                        <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px;">
                            <input type="number" id="rooms_small" value="0" min="0" oninput="calculate()" placeholder="Small">
                            <input type="number" id="rooms_medium" value="0" min="0" oninput="calculate()" placeholder="Medium">
                            <input type="number" id="rooms_large" value="0" min="0" oninput="calculate()" placeholder="Large">
                        </div>
                        <small style="color:var(--text-muted)">Small / Medium / Large</small>
                    </div>
                    <div class="form-group" id="group-exterior-rooms" style="display: none;">
                        <label>Volumes ext√©rieurs</label>
                        <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px;">
                            <input type="number" id="exterior_small" value="0" min="0" oninput="calculate()" placeholder="Small">
                            <input type="number" id="exterior_medium" value="0" min="0" oninput="calculate()" placeholder="Medium">
                            <input type="number" id="exterior_large" value="0" min="0" oninput="calculate()" placeholder="Large">
                        </div>
                        <small style="color:var(--text-muted)">Fa√ßades, terrasses, jardins, etc.</small>
                    </div>
                    <div class="form-group" id="group-visuals">
                        <label>Nombre de visuels</label>
                        <input type="number" id="nb_visuals" value="1" min="0" oninput="calculate()">
                    </div>
                    
                    <div class="form-group" id="group-pack">
                        <label>Pack Design</label>
                        <select id="pack_design" onchange="calculate()">
                            <option value="concept">Concept / Mood</option>
                            <option value="standard" selected>Standard</option>
                            <option value="premium">Premium / Ex√©c</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="glass-panel form-section">
                <div class="section-title">üé® Niveau de prestation</div>
                
                <div class="input-grid client-only">
                    <div class="form-group">
                        <label>Niveau global</label>
                        <select id="client_level" onchange="calculate()">
                            <option value="standard">Standard (Pro)</option>
                            <option value="premium">Premium (Haut de gamme + Urgent)</option>
                        </select>
                        <small style="color:var(--text-muted)">Influe sur la qualit√©, les d√©lais et la priorit√©.</small>
                    </div>
                </div>

                <div class="input-grid advanced-only">
                    <div class="form-group">
                        <label>Complexit√©</label>
                        <select id="complexity" onchange="calculate()">
                            <option value="simple">Simple</option>
                            <option value="standard" selected>Standard</option>
                            <option value="complex">Complexe</option>
                        </select>
                    </div>
                    <div class="form-group" id="group-details">
                        <label>Niveau de D√©tail (3D)</label>
                        <select id="details_level" onchange="calculate()">
                            <option value="concept">Conceptuel</option>
                            <option value="realistic" selected>R√©aliste</option>
                            <option value="photoreal">Phototr√©aliste</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>D√©lai</label>
                        <select id="delay" onchange="calculate()">
                            <option value="standard">Standard</option>
                            <option value="express">Express</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Usage (Droits)</label>
                        <select id="usage" onchange="calculate()">
                            <option value="personal">Personnel / Interne</option>
                            <option value="commercial">Commercial</option>
                            <option value="ads">Publicit√© / Broadcast</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="glass-panel form-section">
                <div class="section-title">‚ú® Options</div>
                <div class="input-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
                    <label class="checkbox-wrapper"><input type="checkbox" id="opt_moodboard" onchange="calculate()"> Moodboard</label>
                    <label class="checkbox-wrapper"><input type="checkbox" id="opt_2dplan" onchange="calculate()"> Plan 2D</label>
                    <label class="checkbox-wrapper"><input type="checkbox" id="opt_shopping" onchange="calculate()"> Shopping List</label>
                    <label class="checkbox-wrapper advanced-only"><input type="checkbox" id="opt_modeling" onchange="calculate()"> Mod√©. Sur mesure</label>
                    <label class="checkbox-wrapper advanced-only"><input type="checkbox" id="opt_furniture" onchange="calculate()"> Mobilier/D√©co</label>
                    <label class="checkbox-wrapper advanced-only"><input type="checkbox" id="opt_landscape" onchange="calculate()"> Paysage/V√©g√©t.</label>
                    <label class="checkbox-wrapper"><input type="checkbox" id="opt_4k" onchange="calculate()"> Rendu 4K</label>
                    <label class="checkbox-wrapper advanced-only"><input type="checkbox" id="opt_sources" onchange="calculate()"> Fichiers Sources</label>
                </div>
                
                <div style="margin-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                    <label class="checkbox-wrapper" style="width: fit-content;"><input type="checkbox" id="opt_animation" onchange="updateUI(); calculate()"> Animation Vid√©o</label>
                    <div id="anim-settings" style="margin-top: 10px; display: none;">
                        <label>Dur√©e (secondes) : <span id="anim-dur-display">0</span>s</label>
                        <input type="range" id="anim_duration" min="0" max="120" value="10" step="5" style="width: 100%" oninput="calculate()">
                    </div>
                </div>
            </div>

            <div class="glass-panel form-section">
                <div class="section-title">üîÑ Retours & Logistique</div>
                <div class="input-grid">
                    <div class="form-group">
                        <label>Cycles de retours demand√©s</label>
                        <input type="number" id="cycles_asked" value="2" min="1" oninput="calculate()">
                        <small class="client-only" style="color:var(--success)">2 cycles inclus par d√©faut</small>
                    </div>
                    <div class="form-group">
                         <label class="checkbox-wrapper" style="margin-top: 25px;">
                             <input type="checkbox" id="opt_travel" onchange="updateUI(); calculate()"> D√©placement
                         </label>
                    </div>
                    <div class="form-group" id="group-km" style="display: none;">
                        <label>Distance (km)</label>
                        <input type="number" id="travel_km" value="0" min="0" oninput="calculate()">
                    </div>
                </div>
            </div>
            
            <p style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 20px;">
                Note : Les retours inclus concernent des ajustements mineurs sur le brief initial valid√©.
            </p>
        </main>

        <aside class="sidebar">
            <div class="glass-panel summary-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="toggle-group" style="scale: 0.8; transform-origin: left;">
                        <div class="toggle-btn" id="curr-eur" onclick="setCurrency('EUR')">EUR</div>
                        <div class="toggle-btn active" id="curr-mga" onclick="setCurrency('MGA')">MGA</div>
                    </div>
                    <div style="font-size: 0.8rem;">
                        <label class="checkbox-wrapper" style="padding: 4px 8px; background: none;">
                            <input type="checkbox" id="toggle-tva" onchange="calculate()"> TVA
                        </label>
                    </div>
                </div>

                <div class="total-display">
                    <div class="total-label">Estimation Totale <span id="label-tax">HT</span></div>
                    <div class="total-amount" id="display-total">0.00 ‚Ç¨</div>
                    <div class="total-sub" id="display-sub-currency">approx 0 Ar</div>
                </div>

                <ul class="breakdown-list">
                    <li class="breakdown-item main"><span>Production</span> <span id="bd-prod">0</span></li>
                    
                    <div class="advanced-only">
                        <li class="breakdown-item sub"><span>Base</span> <span id="bd-base">0</span></li>
                        <li class="breakdown-item sub"><span>Coef. Tech</span> <span id="bd-multi">x1.0</span></li>
                    </div>

                    <li class="breakdown-item main"><span>Options</span> <span id="bd-opts">0</span></li>
                    <li class="breakdown-item main advanced-only"><span>Retours supp.</span> <span id="bd-revs">0</span></li>
                    <li class="breakdown-item main advanced-only"><span>Frais</span> <span id="bd-fees">0</span></li>
                    
                    <li class="breakdown-item main" style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                        <span>Sous-total</span> <span id="bd-subtotal">0</span>
                    </li>
                    <li class="breakdown-item sub" id="row-tva" style="display:none;"><span>TVA</span> <span id="bd-tva">0</span></li>
                </ul>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-glass" style="flex:1" onclick="exportQuote('copy')">üìã Copier</button>
                    <button class="btn-glass btn-primary" style="flex:1" onclick="exportQuote('txt')">‚¨á TXT</button>
                </div>

                <div class="client-only" style="text-align: center; font-size: 0.75rem; opacity: 0.7;">
                    Estimation indicative ‚Äî Devis final apr√®s brief.
                </div>
            </div>
        </aside>
    </div>

    <div id="settings-modal">
        <div class="glass-panel modal-content">
            <div class="modal-header">
                <h3>Param√®tres & Tarifs</h3>
                <button class="btn-glass" style="padding: 5px 10px;" onclick="closeSettings()">‚úï</button>
            </div>
            
            <div id="settings-container">
                </div>

            <div class="form-group" style="margin-top: 20px;">
                <h4>Zone Technique</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label>TVA (%)</label>
                        <input type="number" id="setting_vat_rate" class="config-input">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Taux EUR/MGA</label>
                        <input type="number" id="setting_eur_mga_rate" class="config-input">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-glass" onclick="downloadConfig()">Exporter JSON</button>
                    <label class="btn-glass" style="cursor: pointer;">
                        Importer JSON <input type="file" id="file-import" style="display: none;" onchange="importConfig(this)">
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-glass" style="color: var(--danger)" onclick="resetConfig()">R√©initialiser d√©faut</button>
                <button class="btn-glass btn-primary" onclick="saveSettings()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================
           1. CONFIGURATION & STATE
           ========================================= */
        const CONFIG_DEFAULT = {
            base: { visual: 150, interior: 200, exterior: 240 },
            visual_unit: { concept: 140, realistic: 260, photoreal: 480 },
            visual_room: { small: 60, medium: 110, large: 180 },
            interior_room: {
                concept: { small: 120, medium: 200, large: 320 },
                standard: { small: 180, medium: 280, large: 420 },
                premium: { small: 260, medium: 380, large: 560 }
            },
            interior_render: 220,
            exterior_room: {
                concept: { small: 140, medium: 220, large: 340 },
                standard: { small: 200, medium: 300, large: 460 },
                premium: { small: 280, medium: 420, large: 620 }
            },
            exterior_render: 260,
            
            multipliers: {
                complexity: { simple: 1.0, standard: 1.2, complex: 1.5 },
                details: { concept: 1.0, realistic: 1.25, photoreal: 1.6 },
                delay: { standard: 1.0, express: 1.2, urgent: 1.35 },
                usage: { personal: 1.0, commercial: 1.15, ads: 1.3 }
            },
            
            options: {
                moodboard: 80, plan2d: 160, shopping: 120,
                modeling_pct: 0.20, furniture_pct: 0.15, landscape_pct: 0.18,
                render4k_pct: 0.10, sources_pct: 0.20,
                anim_sec: 35
            },
            
            revisions: { included: 2, rate: 0.10 },
            travel: { flat: 25, km: 0.5 },
            min_fee: 250,
            
            vat_rate: 20,
            eur_mga_rate: 4800
        };

        let CONFIG = JSON.parse(JSON.stringify(CONFIG_DEFAULT));
        
        let state = {
            mode: 'client', // client | advanced
            currency: 'MGA', // EUR | MGA
            showTva: false
        };

        function mergeDefaults(defaults, override) {
            if (!override || typeof override !== 'object') return JSON.parse(JSON.stringify(defaults));
            const output = Array.isArray(defaults) ? [] : {};
            Object.keys(defaults).forEach((key) => {
                if (typeof defaults[key] === 'object' && defaults[key] !== null) {
                    output[key] = mergeDefaults(defaults[key], override[key]);
                } else {
                    output[key] = override[key] ?? defaults[key];
                }
            });
            Object.keys(override).forEach((key) => {
                if (!(key in output)) output[key] = override[key];
            });
            return output;
        }

        /* =========================================
           2. STORAGE & INIT
           ========================================= */
        function init() {
            // Load Config
            const storedConfig = localStorage.getItem('tk_quote_calc_config_v1');
            if (storedConfig) {
                try {
                    CONFIG = mergeDefaults(CONFIG_DEFAULT, JSON.parse(storedConfig));
                } catch(e) { console.error("Config invalide", e); }
            }

            // Load UI State
            const storedUI = localStorage.getItem('tk_quote_calc_ui_v1');
            if (storedUI) {
                const ui = JSON.parse(storedUI);
                state.mode = ui.mode || 'client';
                state.currency = ui.currency || 'MGA';
                state.showTva = ui.showTva || false;
            }

            // Apply UI
            setMode(state.mode);
            setCurrency(state.currency);
            document.getElementById('toggle-tva').checked = state.showTva;
            
            // Build Settings Panel once
            buildSettingsPanel();
            
            updateUI();
            calculate();
        }

        function saveState() {
            localStorage.setItem('tk_quote_calc_ui_v1', JSON.stringify(state));
        }

        /* =========================================
           3. LOGIC & CALCULATION
           ========================================= */
        function calculate() {
            // Get DOM Inputs
            const service = document.getElementById('service_type').value;
            const nb_visuals = parseFloat(document.getElementById('nb_visuals').value) || 0;
            const pack = document.getElementById('pack_design').value;
            const roomCounts = {
                small: parseFloat(document.getElementById('rooms_small').value) || 0,
                medium: parseFloat(document.getElementById('rooms_medium').value) || 0,
                large: parseFloat(document.getElementById('rooms_large').value) || 0
            };
            const exteriorCounts = {
                small: parseFloat(document.getElementById('exterior_small').value) || 0,
                medium: parseFloat(document.getElementById('exterior_medium').value) || 0,
                large: parseFloat(document.getElementById('exterior_large').value) || 0
            };
            
            // Get Multipliers inputs
            let complexityKey = document.getElementById('complexity').value;
            let detailsKey = document.getElementById('details_level').value;
            let delayKey = document.getElementById('delay').value;
            let usageKey = document.getElementById('usage').value;

            // CLIENT MODE OVERRIDES
            if (state.mode === 'client') {
                const clientLvl = document.getElementById('client_level').value;
                if (clientLvl === 'standard') {
                    complexityKey = 'standard';
                    detailsKey = 'realistic'; // Good middle ground
                    delayKey = 'standard';
                    usageKey = 'commercial';
                } else { // Premium
                    complexityKey = 'complex'; // Bump complexity buffer
                    detailsKey = 'photoreal';
                    delayKey = 'express';
                    usageKey = 'commercial';
                }
            }

            // 1. BASE
            let base_price = 0;
            if (service === '3d_visual') base_price = CONFIG.base.visual;
            else if (service === 'interior') base_price = CONFIG.base.interior;
            else if (service === 'exterior') base_price = CONFIG.base.exterior;

            // 2. PRODUCTION
            let production_cost = 0;
            const getRoomCost = (counts, pricing) => {
                return Object.keys(counts).reduce((sum, size) => {
                    const price = pricing?.[size] ?? 0;
                    return sum + (counts[size] * price);
                }, 0);
            };

            if (service === '3d_visual') {
                const p_visu = CONFIG.visual_unit[detailsKey] || 0;
                const rooms_cost = getRoomCost(roomCounts, CONFIG.visual_room);
                production_cost = (nb_visuals * p_visu) + rooms_cost;
            } 
            else if (service === 'interior') {
                production_cost = getRoomCost(roomCounts, CONFIG.interior_room?.[pack]);
                if (nb_visuals > 0) production_cost += (nb_visuals * CONFIG.interior_render);
            }
            else if (service === 'exterior') {
                production_cost = getRoomCost(exteriorCounts, CONFIG.exterior_room?.[pack]);
                if (nb_visuals > 0) production_cost += (nb_visuals * CONFIG.exterior_render);
            }

            // 3. MULTIPLIERS
            const m_comp = CONFIG.multipliers.complexity[complexityKey];
            const m_det = (service === '3d_visual') ? 1.0 : CONFIG.multipliers.details[detailsKey]; // details already in unit price for 3d_visual
            const m_del = CONFIG.multipliers.delay[delayKey];
            const m_use = CONFIG.multipliers.usage[usageKey];
            
            const total_multiplier = m_comp * m_det * m_del * m_use;
            let sub_total_tech = (base_price + production_cost) * total_multiplier;

            // 4. OPTIONS
            let options_cost = 0;
            if (document.getElementById('opt_moodboard').checked) options_cost += CONFIG.options.moodboard;
            if (document.getElementById('opt_2dplan').checked) options_cost += CONFIG.options.plan2d;
            if (document.getElementById('opt_shopping').checked) options_cost += CONFIG.options.shopping;
            
            // Percentage Options (applied on Production usually, or Subtotal)
            if (document.getElementById('opt_modeling').checked) options_cost += production_cost * CONFIG.options.modeling_pct;
            if (document.getElementById('opt_furniture').checked) options_cost += production_cost * CONFIG.options.furniture_pct;
            if (document.getElementById('opt_landscape').checked) options_cost += production_cost * CONFIG.options.landscape_pct;
            if (document.getElementById('opt_4k').checked) options_cost += production_cost * CONFIG.options.render4k_pct;
            
            // Animation
            if (document.getElementById('opt_animation').checked) {
                const secs = parseFloat(document.getElementById('anim_duration').value) || 0;
                options_cost += secs * CONFIG.options.anim_sec;
                document.getElementById('anim-dur-display').textContent = secs;
            }

            // Sources (applied on subtotal usually as it's IP buyout)
            if (document.getElementById('opt_sources').checked) options_cost += sub_total_tech * CONFIG.options.sources_pct;

            // 5. RETOURS
            const cycles_asked = parseFloat(document.getElementById('cycles_asked').value) || 1;
            const cycles_extra = Math.max(0, cycles_asked - CONFIG.revisions.included);
            const revisions_cost = cycles_extra * (base_price + production_cost) * CONFIG.revisions.rate;

            // 6. FRAIS
            let fees_cost = 0;
            if (document.getElementById('opt_travel').checked) {
                const km = parseFloat(document.getElementById('travel_km').value) || 0;
                fees_cost = CONFIG.travel.flat + (km * CONFIG.travel.km);
            }

            // 7. TOTAL & MINIMUM
            let total_pre_min = sub_total_tech + options_cost + revisions_cost + fees_cost;
            let total_final_ht = Math.max(CONFIG.min_fee, total_pre_min);

            // TVA
            state.showTva = document.getElementById('toggle-tva').checked;
            saveState();
            
            let tva_amt = 0;
            if (state.showTva) {
                tva_amt = total_final_ht * (CONFIG.vat_rate / 100);
            }
            let total_ttc = total_final_ht + tva_amt;

            // RENDER DATA
            renderResults({
                production: production_cost,
                base: base_price,
                multiplier: total_multiplier,
                options: options_cost,
                revisions: revisions_cost,
                fees: fees_cost,
                subtotal: sub_total_tech, // raw tech subtotal
                total_ht: total_final_ht,
                tva: tva_amt,
                total_ttc: total_ttc
            });
        }

        function renderResults(data) {
            const isMGA = state.currency === 'MGA';
            const rate = CONFIG.eur_mga_rate;

            const fmt = (val, currency) => {
                if (currency === 'MGA') {
                    // MGA: No decimals, round to 100 Ar usually but just round here
                    return Math.round(val * rate).toLocaleString('fr-FR') + ' Ar';
                }
                return val.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
            };

            const displayVal = state.showTva ? data.total_ttc : data.total_ht;

            // Main Display
            document.getElementById('display-total').textContent = fmt(displayVal, state.currency);
            document.getElementById('label-tax').textContent = state.showTva ? 'TTC' : 'HT';
            
            // Sub Display (Alternative Currency)
            const altCurr = isMGA ? 'EUR' : 'MGA';
            const altVal = fmt(displayVal, altCurr);
            document.getElementById('display-sub-currency').textContent = `approx ${altVal}`;

            // Breakdown
            document.getElementById('bd-prod').textContent = fmt(data.production, state.currency);
            document.getElementById('bd-base').textContent = fmt(data.base, state.currency);
            document.getElementById('bd-multi').textContent = 'x' + data.multiplier.toFixed(2);
            document.getElementById('bd-opts').textContent = fmt(data.options, state.currency);
            document.getElementById('bd-revs').textContent = fmt(data.revisions, state.currency);
            document.getElementById('bd-fees').textContent = fmt(data.fees, state.currency);
            document.getElementById('bd-subtotal').textContent = fmt(data.total_ht, state.currency);
            
            // TVA Row
            const rowTva = document.getElementById('row-tva');
            if (state.showTva) {
                rowTva.style.display = 'flex';
                document.getElementById('bd-tva').textContent = fmt(data.tva, state.currency);
            } else {
                rowTva.style.display = 'none';
            }
        }

        /* =========================================
           4. UI HELPERS
           ========================================= */
        function updateUI() {
            const service = document.getElementById('service_type').value;
            
            // Fields visibility based on Service
            const sViz = service === '3d_visual';
            const sInt = service === 'interior';
            const sExt = service === 'exterior';

            // 3D Visual specific
            document.getElementById('group-pack').style.display = sViz ? 'none' : 'flex';
            document.getElementById('group-details').style.display = sViz ? 'flex' : 'none'; // detail level drives price in 3D Visu

            // Room fields
            document.getElementById('group-rooms').style.display = sExt ? 'none' : 'flex';
            document.getElementById('group-exterior-rooms').style.display = sExt ? 'flex' : 'none';
            
            // Animation
            const anim = document.getElementById('opt_animation').checked;
            document.getElementById('anim-settings').style.display = anim ? 'block' : 'none';

            // Travel
            const travel = document.getElementById('opt_travel').checked;
            document.getElementById('group-km').style.display = travel ? 'flex' : 'none';
        }

        function setMode(m) {
            state.mode = m;
            document.body.className = `mode-${m}`;
            document.getElementById('btn-mode-client').className = `toggle-btn ${m === 'client' ? 'active' : ''}`;
            document.getElementById('btn-mode-advanced').className = `toggle-btn ${m === 'advanced' ? 'active' : ''}`;
            saveState();
            calculate();
        }

        function setCurrency(c) {
            state.currency = c;
            document.getElementById('curr-eur').className = `toggle-btn ${c === 'EUR' ? 'active' : ''}`;
            document.getElementById('curr-mga').className = `toggle-btn ${c === 'MGA' ? 'active' : ''}`;
            saveState();
            calculate();
        }

        /* =========================================
           5. EXPORT
           ========================================= */
        function getQuoteText() {
            const date = new Date().toLocaleDateString('fr-FR');
            const client = document.getElementById('client_name').value || 'Client';
            const total = document.getElementById('display-total').textContent;
            const isClientMode = state.mode === 'client';
            
            let txt = `DEVIS ESTIMATIF - DESIGN 3D & ARCHI\n`;
            txt += `Date: ${date}\n`;
            txt += `Projet: ${client}\n`;
            txt += `--------------------------------\n`;
            
            // Services
            const sMap = { '3d_visual': 'Visuel 3D', 'interior': 'Design Int√©rieur', 'exterior': 'Design Ext√©rieur' };
            txt += `Service: ${sMap[document.getElementById('service_type').value]}\n`;
            txt += `Visuels: ${document.getElementById('nb_visuals').value}\n`;
            const service = document.getElementById('service_type').value;
            if (service === 'exterior') {
                txt += `Ext√©rieur Small/Med/Large: ${document.getElementById('exterior_small').value}/${document.getElementById('exterior_medium').value}/${document.getElementById('exterior_large').value}\n`;
            } else {
                txt += `Pi√®ces Small/Med/Large: ${document.getElementById('rooms_small').value}/${document.getElementById('rooms_medium').value}/${document.getElementById('rooms_large').value}\n`;
            }
            
            if (isClientMode) {
                txt += `Niveau: ${document.getElementById('client_level').value.toUpperCase()}\n`;
            } else {
                txt += `Pack: ${document.getElementById('pack_design').value}\n`;
                txt += `Complexit√©: ${document.getElementById('complexity').value}\n`;
                txt += `Usage: ${document.getElementById('usage').value}\n`;
            }

            txt += `\nOPTIONS INCLUSES:\n`;
            const checks = document.querySelectorAll('input[type="checkbox"]:checked');
            if(checks.length === 0) txt += "- Aucune\n";
            checks.forEach(c => {
                if(c.id !== 'toggle-tva') txt += `- ${c.parentNode.textContent.trim()}\n`;
            });

            txt += `--------------------------------\n`;
            txt += `TOTAL ${state.showTva ? 'TTC' : 'HT'}: ${total}\n`;
            txt += `--------------------------------\n`;
            txt += `Note: Ce devis est une estimation indicative.\n`;
            
            return txt;
        }

        function exportQuote(type) {
            const txt = getQuoteText();
            if (type === 'copy') {
                navigator.clipboard.writeText(txt).then(() => alert('Devis copi√© !'));
            } else {
                const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `devis_${new Date().toISOString().slice(0,10)}.txt`;
                link.click();
            }
        }

        /* =========================================
           6. SETTINGS PANEL LOGIC
           ========================================= */
        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
            populateSettingsInputs();
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function buildSettingsPanel() {
            // Helper to create inputs mapping to CONFIG object structure is tricky recursively.
            // Simplified approach: Manually map key sections for robustness.
            // But to save space here, I'll rely on populateSettingsInputs to fill specific IDs
            // and saveSettings to read them back.
            
            // Generating HTML for Base Prices
            let html = `<div class="settings-group"><h4>Prix de Base (Setup)</h4><div class="settings-grid">`;
            html += mkInput('Base Visuel 3D', 'base.visual');
            html += mkInput('Base Int√©rieur', 'base.interior');
            html += mkInput('Base Ext√©rieur', 'base.exterior');
            html += `</div></div>`;

            html += `<div class="settings-group"><h4>Production Visuel 3D (par pi√®ce)</h4><div class="settings-grid">`;
            html += mkInput('Visuel Small', 'visual_room.small');
            html += mkInput('Visuel Medium', 'visual_room.medium');
            html += mkInput('Visuel Large', 'visual_room.large');
            html += `</div></div>`;

            html += `<div class="settings-group"><h4>Production Int√©rieur (par pi√®ce)</h4><div class="settings-grid">`;
            html += mkInput('Int. Concept Small', 'interior_room.concept.small');
            html += mkInput('Int. Concept Medium', 'interior_room.concept.medium');
            html += mkInput('Int. Concept Large', 'interior_room.concept.large');
            html += mkInput('Int. Standard Small', 'interior_room.standard.small');
            html += mkInput('Int. Standard Medium', 'interior_room.standard.medium');
            html += mkInput('Int. Standard Large', 'interior_room.standard.large');
            html += mkInput('Int. Premium Small', 'interior_room.premium.small');
            html += mkInput('Int. Premium Medium', 'interior_room.premium.medium');
            html += mkInput('Int. Premium Large', 'interior_room.premium.large');
            html += `</div></div>`;

            html += `<div class="settings-group"><h4>Production Ext√©rieur (par pi√®ce)</h4><div class="settings-grid">`;
            html += mkInput('Ext. Concept Small', 'exterior_room.concept.small');
            html += mkInput('Ext. Concept Medium', 'exterior_room.concept.medium');
            html += mkInput('Ext. Concept Large', 'exterior_room.concept.large');
            html += mkInput('Ext. Standard Small', 'exterior_room.standard.small');
            html += mkInput('Ext. Standard Medium', 'exterior_room.standard.medium');
            html += mkInput('Ext. Standard Large', 'exterior_room.standard.large');
            html += mkInput('Ext. Premium Small', 'exterior_room.premium.small');
            html += mkInput('Ext. Premium Medium', 'exterior_room.premium.medium');
            html += mkInput('Ext. Premium Large', 'exterior_room.premium.large');
            html += `</div></div>`;

            html += `<div class="settings-group"><h4>Options (‚Ç¨ forfaitaire)</h4><div class="settings-grid">`;
            html += mkInput('Moodboard', 'options.moodboard');
            html += mkInput('Plan 2D', 'options.plan2d');
            html += mkInput('Shopping List', 'options.shopping');
            html += mkInput('Animation /sec', 'options.anim_sec');
            html += `</div></div>`;

            document.getElementById('settings-container').innerHTML = html;
        }

        function mkInput(label, keyPath) {
            return `
            <div class="form-group">
                <label>${label}</label>
                <input type="number" step="0.01" data-path="${keyPath}" class="config-input">
            </div>`;
        }

        function populateSettingsInputs() {
            // Fill auto-generated
            document.querySelectorAll('input[data-path]').forEach(input => {
                const keys = input.dataset.path.split('.');
                let val = CONFIG;
                keys.forEach(k => val = val[k]);
                input.value = val;
            });

            // Fill manual ones
            document.getElementById('setting_vat_rate').value = CONFIG.vat_rate;
            document.getElementById('setting_eur_mga_rate').value = CONFIG.eur_mga_rate;
        }

        function saveSettings() {
            // Save auto-generated
            document.querySelectorAll('input[data-path]').forEach(input => {
                const keys = input.dataset.path.split('.');
                let obj = CONFIG;
                for(let i=0; i<keys.length-1; i++) obj = obj[keys[i]];
                obj[keys[keys.length-1]] = parseFloat(input.value);
            });

            // Save manual
            CONFIG.vat_rate = parseFloat(document.getElementById('setting_vat_rate').value);
            CONFIG.eur_mga_rate = parseFloat(document.getElementById('setting_eur_mga_rate').value);

            localStorage.setItem('tk_quote_calc_config_v1', JSON.stringify(CONFIG));
            closeSettings();
            calculate();
            alert('Param√®tres sauvegard√©s');
        }

        function resetConfig() {
            if(confirm('Restaurer les valeurs par d√©faut ?')) {
                CONFIG = JSON.parse(JSON.stringify(CONFIG_DEFAULT));
                populateSettingsInputs();
                localStorage.setItem('tk_quote_calc_config_v1', JSON.stringify(CONFIG));
                calculate();
            }
        }

        function downloadConfig() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(CONFIG));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", "config_devis.json");
            link.click();
        }

        function importConfig(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newConfig = JSON.parse(e.target.result);
                    // Basic validation: check if base exists
                    if(newConfig.base && newConfig.options) {
                        CONFIG = newConfig;
                        populateSettingsInputs();
                        alert('Configuration charg√©e avec succ√®s !');
                    } else {
                        throw new Error('Format invalide');
                    }
                } catch(err) {
                    alert('Erreur: Fichier JSON invalide.');
                }
            };
            reader.readAsText(file);
        }

        // --- Start ---
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
