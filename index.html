<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de devis modulable — 3D & Design</title>
  <style>
    :root {
      --bg-1: #e6f0ff;
      --bg-2: #d8dcff;
      --bg-3: #f3f7ff;
      --bg-4: #d3f4ff;
      --glass: rgba(255, 255, 255, 0.35);
      --glass-strong: rgba(255, 255, 255, 0.65);
      --border: rgba(255, 255, 255, 0.5);
      --shadow: 0 24px 60px rgba(12, 25, 58, 0.16);
      --accent: #3b82f6;
      --accent-2: #7c3aed;
      --accent-3: #06b6d4;
      --success: #14b8a6;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #6b7280;
      --radius-xl: 26px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --transition: 180ms ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", Roboto, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.18), transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(6, 182, 212, 0.2), transparent 35%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.16), transparent 35%),
        linear-gradient(135deg, var(--bg-1), var(--bg-3) 55%, #ffffff 100%);
      min-height: 100vh;
      padding: 28px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.6), transparent 38%),
        radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.45), transparent 35%),
        radial-gradient(circle at 30% 80%, rgba(255, 255, 255, 0.35), transparent 40%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
      z-index: -1;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 10% 10% auto auto;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.35), transparent 70%);
      filter: blur(25px);
      opacity: 0.6;
      pointer-events: none;
      z-index: -1;
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .content {
      display: flex;
      align-items: flex-start;
      gap: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 12px 18px;
      border-radius: var(--radius-xl);
      background: rgba(255, 255, 255, 0.25);
      border: none;
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(14px);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .subtle {
      color: var(--muted);
    }

    .glass {
      background: var(--glass);
      border: none;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(22px) saturate(160%);
      -webkit-backdrop-filter: blur(22px) saturate(160%);
      position: relative;
      overflow: hidden;
    }

    .glass::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: none;
      pointer-events: none;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6),
        inset 0 -10px 20px rgba(255, 255, 255, 0.15);
    }

    .glass::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.5), transparent 45%);
      opacity: 0.7;
      pointer-events: none;
    }

    .panel {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .panel h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .toggle-group {
      display: inline-flex;
      align-self: flex-start;
      width: fit-content;
      background: rgba(255, 255, 255, 0.35);
      border: none;
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.6);
    }

    .toggle-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
    }

    .toggle-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: #1d4ed8;
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.2);
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.55);
      border: none;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(59, 130, 246, 0.2);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .grid > div {
      flex: 1 1 220px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .form-item {
      flex: 1 1 240px;
      min-width: 240px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .is-disabled {
      opacity: 0.45;
      filter: grayscale(0.4);
      position: relative;
      pointer-events: none;
    }

    .is-disabled input,
    .is-disabled select,
    .is-disabled button {
      background: rgba(255, 255, 255, 0.35);
      box-shadow: none;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px;
      font-size: 1rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.55);
      transition: var(--transition);
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      padding: 0;
      margin: 0;
      border-radius: 4px;
      box-shadow: none;
      background: rgba(255, 255, 255, 0.9);
      accent-color: var(--accent-2);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: transparent;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(255, 255, 255, 0.92);
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stepper button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.6);
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .stepper button:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 8px 16px rgba(16, 24, 40, 0.12);
    }

    .helper {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .options > label {
      flex: 1 1 180px;
      min-width: 180px;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 13.5px 12px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.5);
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .checkbox input {
      flex: 0 0 auto;
    }

    .checkbox:hover {
      background: rgba(255, 255, 255, 0.85);
    }

    .sidebar {
      position: sticky;
      top: 24px;
      height: fit-content;
      flex: 0 0 360px;
    }

    .summary {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-currency {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .total {
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-align: right;
    }

    .total strong {
      font-size: 2.3rem;
    }

    .summary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .summary-item.sub {
      color: var(--muted);
      font-size: 0.82rem;
      padding-left: 10px;
    }

    .summary-item.total {
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      font-weight: 800;
    }

    .summary-toggle {
      border: none;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
    }

    .summary-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .summary-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .deliverables {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .deliverables-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .deliverables-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .deliverables h3 {
      margin: 0;
      font-size: 1rem;
    }

    .deliverables-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 0.9rem;
    }

    .deliverables-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
    }

    .deliverables-section h4 {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .deliverables-section ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
    }

    .deliverables-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .deliverables-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .deliverables-badge--warn {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
    }

    .deliverables-note {
      display: block;
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .deliverables-empty {
      margin: 0;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.45);
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
    }

    .deliverables-toggle {
      border: none;
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.78rem;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
      display: none;
    }

    .deliverables-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.12);
      color: var(--success);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      font-size: 0.85rem;
      display: none;
    }

    .drawer {
      display: none;
    }

    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 20px;
    }

    .settings-panel {
      width: min(980px, 95vw);
      max-height: 85vh;
      overflow: auto;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px) saturate(170%);
    }

    .billing-panel {
      width: min(1100px, 96vw);
    }

    .billing-layout {
      display: grid;
      grid-template-columns: minmax(280px, 1fr) minmax(280px, 1fr);
      gap: 20px;
      align-items: start;
    }

    .billing-section {
      padding: 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.55);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .billing-section h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .billing-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .billing-preview {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 18px;
      padding: 20px;
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.7);
    }

    .invoice {
      font-family: "Segoe UI", "Inter", sans-serif;
      color: #0f172a;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 18px;
      border-radius: 20px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.88), rgba(248, 250, 255, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      backdrop-filter: blur(18px);
    }

    .invoice-hero {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      padding: 16px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(124, 58, 237, 0.2));
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    .invoice-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 220px;
    }

    .invoice-logo {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.8);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #1d4ed8;
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
    }

    .invoice-brand span {
      display: block;
      font-size: 0.75rem;
      color: #475569;
    }

    .invoice-brand strong {
      font-size: 1.05rem;
      display: block;
    }

    .invoice-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .invoice-status {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.16);
      color: #0f766e;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .invoice-status.is-draft {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .invoice-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      width: min(360px, 100%);
    }

    .invoice-meta-item {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 0.82rem;
    }

    .invoice-meta-item strong {
      display: block;
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .invoice-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .invoice-card {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
    }

    .invoice-card h4 {
      margin: 0 0 6px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .invoice-total-card {
      padding: 14px;
      border-radius: 16px;
      background: rgba(59, 130, 246, 0.14);
      border: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
    }

    .invoice-total-card span {
      font-size: 0.8rem;
      color: #1d4ed8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .invoice-total-amount {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .invoice-block {
      flex: 1 1 220px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .invoice-block h4 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    .invoice-table th,
    .invoice-table td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      text-align: left;
    }

    .invoice-table th {
      background: rgba(59, 130, 246, 0.12);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #1d4ed8;
    }

    .invoice-table td:last-child,
    .invoice-table th:last-child {
      text-align: right;
    }

    .invoice-total {
      font-weight: 700;
      font-size: 1rem;
    }

    .invoice-total td {
      border-top: 1px solid rgba(148, 163, 184, 0.3);
    }

    .invoice-footer {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .invoice-note {
      font-size: 0.85rem;
      color: var(--muted);
      white-space: pre-wrap;
    }

    .custom-field-row {
      display: grid;
      grid-template-columns: minmax(120px, 1fr) minmax(120px, 1fr) auto;
      gap: 10px;
      align-items: center;
    }

    .custom-field-row button {
      padding: 10px 12px;
    }

    @media (max-width: 980px) {
      .billing-layout {
        grid-template-columns: 1fr;
      }
    }

    .settings-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .settings-grid > div {
      flex: 1 1 220px;
      min-width: 220px;
    }

    .section-divider {
      margin-top: 8px;
      border-top: none;
      padding-top: 16px;
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .inline input,
    .inline select,
    .inline textarea {
      width: auto;
      flex: 1 1 120px;
      min-width: 0;
    }

    .inline .helper {
      white-space: nowrap;
    }

    .tag {
      background: rgba(99, 102, 241, 0.12);
      color: #4338ca;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
    }


    @media (max-width: 980px) {
      .content {
        flex-direction: column;
        padding-bottom: 160px;
      }

      .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        padding: 16px;
        z-index: 20;
      }

      .summary {
        border-radius: 22px 22px 0 0;
        background: var(--glass-strong);
      }

      .drawer {
        display: block;
        margin-bottom: 6px;
      }

      .deliverables-toggle {
        display: inline-flex;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Calculateur de devis modulable</h1>
        <p class="subtle">Visuels 3D · Design intérieur · Design extérieur</p>
      </div>
      <div class="inline">
        <button class="btn" id="open-settings" type="button">⚙ Paramètres</button>
      </div>
    </header>

    <div class="content">
      <main style="display: flex; flex-direction: column; gap: 24px;">
        <section class="glass panel" aria-label="Identité">
          <h2>Projet</h2>
          <div class="grid">
            <div>
              <label for="client-name">Nom client / Projet</label>
              <input id="client-name" type="text" placeholder="Villa Oceanis" autocomplete="off" />
            </div>
          </div>
        </section>

      <section class="glass panel" aria-label="Service">
        <h2>Service & volume</h2>
        <div class="grid">
          <div>
            <label for="service">Service</label>
            <select id="service">
              <option value="visual">Visuels 3D</option>
              <option value="interior">Design intérieur</option>
              <option value="exterior">Design extérieur</option>
            </select>
          </div>
          <div>
            <label for="pack">Pack</label>
            <select id="pack">
              <option value="concept">Concept</option>
              <option value="standard" selected>Standard</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <div>
            <label for="nb-visuels">Nombre de visuels finaux</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="nb-visuels">-</button>
              <input id="nb-visuels" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="nb-visuels">+</button>
            </div>
          </div>
        </div>
        <div class="grid" id="volume-interior">
          <div>
            <label>Pièces Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-small">-</button>
              <input id="pieces-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-small">+</button>
            </div>
          </div>
          <div>
            <label>Pièces Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-medium">-</button>
              <input id="pieces-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-medium">+</button>
            </div>
          </div>
          <div>
            <label>Pièces Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="pieces-large">-</button>
              <input id="pieces-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="pieces-large">+</button>
            </div>
          </div>
        </div>
        <div class="grid" id="volume-exterior">
          <div>
            <label>Zones Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-small">-</button>
              <input id="zones-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-small">+</button>
            </div>
          </div>
          <div>
            <label>Zones Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-medium">-</button>
              <input id="zones-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-medium">+</button>
            </div>
          </div>
          <div>
            <label>Zones Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="zones-large">-</button>
              <input id="zones-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="zones-large">+</button>
            </div>
          </div>
        </div>
        <div class="grid" id="volume-scenes">
          <div>
            <label>Scènes Small</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-small">-</button>
              <input id="scenes-small" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-small">+</button>
            </div>
          </div>
          <div>
            <label>Scènes Medium</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-medium">-</button>
              <input id="scenes-medium" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-medium">+</button>
            </div>
          </div>
          <div>
            <label>Scènes Large</label>
            <div class="stepper">
              <button type="button" data-step="-1" data-target="scenes-large">-</button>
              <input id="scenes-large" type="number" min="0" value="0" />
              <button type="button" data-step="1" data-target="scenes-large">+</button>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-item">
            <label class="checkbox">
              <input type="checkbox" id="toggle-m2" />
              Mesure en m² (optionnel)
            </label>
          </div>
          <div class="form-item" id="m2-field">
            <label for="m2-value">Surface (m²)</label>
            <input id="m2-value" type="number" min="0" value="0" />
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Paramètres créatifs">
        <h2>Niveau de prestation</h2>
        <div class="grid">
          <div>
            <label for="complexity">Complexité</label>
            <select id="complexity">
              <option value="simple">Simple</option>
              <option value="standard" selected>Standard</option>
              <option value="complex">Complexe</option>
            </select>
          </div>
          <div>
            <label for="details">Détails</label>
            <select id="details">
              <option value="concept">Concept</option>
              <option value="realistic" selected>Réaliste</option>
              <option value="photoreal">Photoreal</option>
            </select>
          </div>
          <div>
            <label for="usage">Usage</label>
            <select id="usage">
              <option value="personal">Perso</option>
              <option value="commercial" selected>Commercial</option>
              <option value="ads">Publicité</option>
            </select>
          </div>
          <div>
            <label for="delay">Délais</label>
            <select id="delay">
              <option value="standard">Standard</option>
              <option value="express">Express</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Options">
        <h2>Options</h2>
        <div class="options">
          <label class="checkbox"><input type="checkbox" id="opt-moodboard" /> Moodboard</label>
          <label class="checkbox"><input type="checkbox" id="opt-plan" /> Plan 2D</label>
          <label class="checkbox"><input type="checkbox" id="opt-shopping" /> Shopping list</label>
          <label class="checkbox"><input type="checkbox" id="opt-modeling" /> Modélisation sur mesure</label>
          <label class="checkbox"><input type="checkbox" id="opt-furniture" /> Mobilier / déco</label>
          <label class="checkbox"><input type="checkbox" id="opt-landscape" /> Paysage / végétation</label>
          <label class="checkbox"><input type="checkbox" id="opt-4k" /> Rendu 4K</label>
          <label class="checkbox"><input type="checkbox" id="opt-sources" /> Fichiers sources</label>
        </div>
        <div class="grid">
          <div>
            <label class="checkbox"><input type="checkbox" id="opt-animation" /> Animation</label>
            <div class="inline" id="anim-block" style="display:none;">
              <input id="anim-seconds" type="number" min="0" max="120" value="0" />
              <span class="helper">secondes (0-120)</span>
            </div>
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Retours">
        <h2>Retours & logistique</h2>
        <div class="form-row">
          <div class="form-item">
            <label for="cycles">
              Cycles de retours demandés
              <span class="helper">(Cycles inclus : <strong id="cycles-included">2</strong>)</span>
            </label>
            <input id="cycles" type="number" min="1" value="2" />
          </div>
          <div class="form-item">
            <label class="checkbox"><input type="checkbox" id="opt-travel" /> Déplacement</label>
            <div class="inline" id="travel-block">
              <input id="travel-km" type="number" min="0" value="0" />
              <span class="helper">km</span>
            </div>
          </div>
        </div>
      </section>

      <section class="glass panel" aria-label="Export">
        <h2>Export devis</h2>
        <div class="inline">
          <button class="btn btn-primary" id="export-snapshot" type="button">Exporter le devis</button>
          <label class="btn" style="cursor:pointer;">
            Importer un devis
            <input type="file" id="import-snapshot" accept="application/json" style="display:none;" />
          </label>
          <button class="btn" id="open-billing" type="button">Générer une facture</button>
        </div>
      </section>
      </main>

      <aside class="sidebar">
        <div class="glass summary">
          <div class="drawer">
            <span class="tag">Récapitulatif</span>
          </div>
          <div class="total">
            <span class="subtle" id="total-label">Total HT</span>
            <strong id="total-main">0 Ar</strong>
            <span class="helper" id="total-alt">≈ 0 €</span>
          </div>
          <div class="sidebar-currency">
            <label for="currency">Devise d'affichage</label>
            <div class="toggle-group" role="tablist" aria-label="Devise">
              <button class="toggle-btn active" id="currency-mga" role="tab" aria-selected="true">MGA</button>
              <button class="toggle-btn" id="currency-eur" role="tab" aria-selected="false">EUR</button>
            </div>
          </div>
          <div class="alert" id="empty-warning">Ajoute au moins 1 pièce, 1 scène ou 1 visuel.</div>
          <div class="pill" id="minimum-pill" style="display:none;">Minimum appliqué</div>
          <div class="summary-list" id="summary-advanced"></div>
          <div class="deliverables" id="deliverables">
            <div class="deliverables-header">
              <h3>Livrables inclus</h3>
              <div class="deliverables-header-actions">
                <div class="deliverables-badges" id="deliverables-badges"></div>
                <button class="deliverables-toggle" id="deliverables-toggle" type="button" aria-expanded="true">
                  Masquer les livrables
                </button>
              </div>
            </div>
            <div class="deliverables-body" id="deliverables-body"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="settings-overlay" id="settings-overlay" aria-modal="true" role="dialog">
    <div class="settings-panel">
      <div class="inline" style="justify-content: space-between;">
        <h2>Paramètres</h2>
        <div class="inline">
          <button class="btn" id="export-config" type="button">Exporter JSON</button>
          <label class="btn" style="cursor:pointer;">
            Importer JSON
            <input type="file" id="import-config" accept="application/json" style="display:none;" />
          </label>
          <button class="btn" id="reset-config" type="button">Réinitialiser</button>
          <button class="btn btn-primary" id="save-config" type="button">Sauvegarder</button>
        </div>
      </div>
      <div class="section-divider">
        <h3>TVA & conversion</h3>
        <div class="settings-grid">
          <div>
            <label class="checkbox"><input type="checkbox" id="toggle-tva" /> Ajouter TVA</label>
            <div class="inline">
              <input id="tva-rate" type="number" min="0" value="0" />
              <span class="helper">%</span>
            </div>
          </div>
          <div>
            <label for="rate">Taux EUR → MGA</label>
            <input id="rate" type="number" min="0" value="4800" />
          </div>
        </div>
      </div>
      <div id="settings-form" class="section-divider"></div>
    </div>
  </div>

  <div class="settings-overlay" id="billing-overlay" aria-modal="true" role="dialog">
    <div class="settings-panel billing-panel">
      <div class="inline" style="justify-content: space-between;">
        <div>
          <h2>Informations de facturation</h2>
          <p class="helper">Les données sont stockées localement sur ce navigateur.</p>
        </div>
        <div class="billing-actions">
          <button class="btn" id="copy-invoice" type="button">Copier facture</button>
          <button class="btn" id="download-invoice" type="button">Télécharger .html</button>
          <button class="btn btn-primary" id="print-invoice" type="button">Imprimer / PDF</button>
        </div>
      </div>
      <div class="billing-layout section-divider">
        <div class="billing-section">
          <h3>Émetteur (entreprise)</h3>
          <div class="grid">
            <div>
              <label for="company-name">Nom / Société</label>
              <input id="company-name" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-address">Adresse</label>
              <input id="company-address" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-country">Pays</label>
              <input id="company-country" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-postal">Code postal</label>
              <input id="company-postal" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-phone">Numéro / téléphone</label>
              <input id="company-phone" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-nif">NIF/STAT</label>
              <input id="company-nif" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="company-email">Email (optionnel)</label>
              <input id="company-email" type="email" autocomplete="off" />
            </div>
          </div>
        </div>
        <div class="billing-section">
          <h3>Client</h3>
          <div class="grid">
            <div>
              <label for="client-billing-name">Nom</label>
              <input id="client-billing-name" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-address">Adresse</label>
              <input id="client-billing-address" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-country">Pays</label>
              <input id="client-billing-country" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-postal">Code postal</label>
              <input id="client-billing-postal" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-phone">Téléphone</label>
              <input id="client-billing-phone" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-nif">NIF/STAT</label>
              <input id="client-billing-nif" type="text" autocomplete="off" />
            </div>
            <div>
              <label for="client-billing-email">Email (optionnel)</label>
              <input id="client-billing-email" type="email" autocomplete="off" />
            </div>
          </div>
        </div>
        <div class="billing-section">
          <h3>Facture</h3>
          <div class="grid">
            <div>
              <label for="invoice-number">Numéro</label>
              <input id="invoice-number" type="text" placeholder="FAC-YYYYMMDD-XXX" autocomplete="off" />
            </div>
            <div>
              <label for="invoice-date">Date</label>
              <input id="invoice-date" type="date" />
            </div>
            <div>
              <label for="invoice-due-date">Échéance (optionnel)</label>
              <input id="invoice-due-date" type="date" />
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" id="invoice-show-details" />
            Afficher détail (Base/Production/Options/Retours/Frais/TVA)
          </label>
          <div>
            <label for="invoice-notes">Notes / conditions</label>
            <textarea id="invoice-notes" rows="4" placeholder="Conditions de paiement, modalités..."></textarea>
          </div>
        </div>
        <div class="billing-section">
          <h3>Champs personnalisés</h3>
          <div id="custom-fields"></div>
          <button class="btn" id="add-custom-field" type="button">+ Ajouter un champ</button>
        </div>
        <div class="billing-preview">
          <div class="inline" style="justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Aperçu facture</h3>
            <span class="tag" id="invoice-status">Brouillon</span>
          </div>
          <div id="invoice-preview" class="section-divider"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG_DEFAULT = {
      base: { visual: 250000, interior: 300000, exterior: 350000 },
      packs: {
        interior: {
          concept: { small: 250000, medium: 420000, large: 650000 },
          standard: { small: 380000, medium: 650000, large: 980000 },
          premium: { small: 520000, medium: 920000, large: 1400000 }
        },
        exterior: {
          concept: { small: 320000, medium: 560000, large: 900000 },
          standard: { small: 480000, medium: 850000, large: 1350000 },
          premium: { small: 650000, medium: 1200000, large: 1900000 }
        }
      },
      scenes: { small: 220000, medium: 420000, large: 850000 },
      visual_tiers: {
        concept: [
          { upTo: 2, unit: 180000 },
          { upTo: 6, unit: 140000 },
          { upTo: 12, unit: 110000 },
          { upTo: Infinity, unit: 90000 }
        ],
        realistic: [
          { upTo: 2, unit: 320000 },
          { upTo: 6, unit: 260000 },
          { upTo: 12, unit: 210000 },
          { upTo: Infinity, unit: 170000 }
        ],
        photoreal: [
          { upTo: 2, unit: 560000 },
          { upTo: 6, unit: 450000 },
          { upTo: 12, unit: 360000 },
          { upTo: Infinity, unit: 290000 }
        ]
      },
      render_tiers: {
        interior: [
          { upTo: 2, unit: 260000 },
          { upTo: 6, unit: 210000 },
          { upTo: 12, unit: 170000 },
          { upTo: Infinity, unit: 140000 }
        ],
        exterior: [
          { upTo: 2, unit: 300000 },
          { upTo: 6, unit: 240000 },
          { upTo: 12, unit: 200000 },
          { upTo: Infinity, unit: 160000 }
        ]
      },
      visual_unit: { concept: 180000, realistic: 320000, photoreal: 560000 },
      render_unit: { interior: 260000, exterior: 300000 },
      multipliers: {
        complexity: { simple: 1.0, standard: 1.2, complex: 1.5 },
        details: { concept: 1.0, realistic: 1.25, photoreal: 1.6 },
        delay: { standard: 1.0, express: 1.2, urgent: 1.35 },
        usage: { personal: 1.0, commercial: 1.15, ads: 1.3 }
      },
      options: {
        moodboard: 120000,
        plan2d: 220000,
        shopping: 150000,
        modeling_pct: 0.2,
        furniture_pct: 0.15,
        landscape_pct: 0.18,
        render4k_pct: 0.1,
        sources_pct: 0.2,
        animation_sec: 40000
      },
      revisions: { included: 2, rate: 0.1 },
      travel: { flat: 50000, km: 1500 },
      minimum: 350000,
      vat_rate: 0,
      eur_mga_rate: 4800,
      toggles: {
        enable_visual_tiers: true,
        enable_render_tiers: true,
        enable_tiered_m2: true
      },
      tiered_m2: [
        { upTo: 30, unit: 18000 },
        { upTo: 80, unit: 14000 },
        { upTo: Infinity, unit: 11000 }
      ]
    };

    const LIVRABLES = {
      interior: {
        concept: {
          client: [
            "Concept board d'ambiance + palette principale",
            "Proposition d'agencement par pièce",
            "Vue 3D d'intention par pièce"
          ],
          advanced: [
            "Concept board + palette (PDF)",
            "Implantation initiale + zoning",
            "Vue 3D d'intention par pièce (JPG 1920px)"
          ]
        },
        standard: {
          client: [
            "Direction artistique claire & cohérente",
            "Proposition d'aménagement optimisée",
            "Rendus réalistes par pièce"
          ],
          advanced: [
            "DA + références (PDF)",
            "Plans d'implantation détaillés",
            "Rendus réalistes 2K (JPG/PNG)"
          ]
        },
        premium: {
          client: [
            "Direction artistique complète + variantes",
            "Rendus photoréalistes premium",
            "Synthèse shopping détaillée"
          ],
          advanced: [
            "DA complète + variantes validées",
            "Rendus photoréalistes 4K (JPG/PNG)",
            "Exports techniques pour artisans (PDF)"
          ]
        }
      },
      exterior: {
        concept: {
          client: [
            "Concept board extérieur & palette matériaux",
            "Proposition d'aménagement global",
            "Vue 3D d'intention par zone"
          ],
          advanced: [
            "Moodboard matériaux + palette (PDF)",
            "Zoning extérieur + implantation",
            "Vue 3D d'intention par zone (JPG 1920px)"
          ]
        },
        standard: {
          client: [
            "Direction extérieure structurée",
            "Mise en scène réaliste des volumes",
            "Rendus réalistes par zone"
          ],
          advanced: [
            "DA extérieure + références (PDF)",
            "Implantation détaillée des volumes",
            "Rendus réalistes 2K (JPG/PNG)"
          ]
        },
        premium: {
          client: [
            "Direction artistique complète + variantes",
            "Rendus photoréalistes jour / nuit",
            "Synthèse paysagère & matériaux"
          ],
          advanced: [
            "DA complète + variantes validées",
            "Rendus photoréalistes 4K jour/nuit",
            "Exports techniques + palette matériaux (PDF)"
          ]
        }
      },
      visual: {
        concept: {
          client: [
            "Storyboard visuel d'intention",
            "Angles de vue clés",
            "Rendus HD prêts à partager"
          ],
          advanced: [
            "Storyboard + plan de caméras",
            "Rendus HD (JPG 1920px)",
            "Corrections incluses sur cadrage/lumière"
          ]
        },
        standard: {
          client: [
            "Angles de vue optimisés",
            "Rendus réalistes haute définition",
            "Formats web & présentation"
          ],
          advanced: [
            "Plan de caméras + variantes",
            "Rendus 2K (JPG/PNG)",
            "Formats web/print (RGB/CMYK)"
          ]
        },
        premium: {
          client: [
            "Mise en scène premium + variantes",
            "Rendus photoréalistes",
            "Formats haute définition"
          ],
          advanced: [
            "Plan de caméras + focales détaillées",
            "Rendus 4K (JPG/PNG)",
            "Formats print + web (RGB/CMYK)"
          ]
        }
      }
    };

    const UI_DEFAULT = {
      currency: "MGA",
      deliverablesExpanded: true,
      tax: {
        enabled: false,
        tvaRate: CONFIG_DEFAULT.vat_rate,
        rate: CONFIG_DEFAULT.eur_mga_rate
      }
    };

    const BILLING_DEFAULT = {
      issuer: {
        company_name: "",
        company_address: "",
        company_country: "",
        company_postal: "",
        company_phone: "",
        company_nif: "",
        company_email: ""
      },
      client: {
        client_name: "",
        client_address: "",
        client_country: "",
        client_postal: "",
        client_phone: "",
        client_nif: "",
        client_email: ""
      },
      invoice: {
        invoice_number: "",
        invoice_date: "",
        due_date: "",
        notes: "",
        show_details: true
      },
      customFields: []
    };

    let CONFIG = loadConfig();
    let UI_STATE = loadUIState();
    let BILLING = loadBilling();

    const elements = {
      service: document.getElementById("service"),
      pack: document.getElementById("pack"),
      nbVisuels: document.getElementById("nb-visuels"),
      piecesSmall: document.getElementById("pieces-small"),
      piecesMedium: document.getElementById("pieces-medium"),
      piecesLarge: document.getElementById("pieces-large"),
      zonesSmall: document.getElementById("zones-small"),
      zonesMedium: document.getElementById("zones-medium"),
      zonesLarge: document.getElementById("zones-large"),
      scenesSmall: document.getElementById("scenes-small"),
      scenesMedium: document.getElementById("scenes-medium"),
      scenesLarge: document.getElementById("scenes-large"),
      complexity: document.getElementById("complexity"),
      details: document.getElementById("details"),
      usage: document.getElementById("usage"),
      delay: document.getElementById("delay"),
      toggleM2: document.getElementById("toggle-m2"),
      m2Value: document.getElementById("m2-value"),
      toggleTva: document.getElementById("toggle-tva"),
      tvaRate: document.getElementById("tva-rate"),
      rate: document.getElementById("rate"),
      cycles: document.getElementById("cycles"),
      optTravel: document.getElementById("opt-travel"),
      travelKm: document.getElementById("travel-km"),
      optMoodboard: document.getElementById("opt-moodboard"),
      optPlan: document.getElementById("opt-plan"),
      optShopping: document.getElementById("opt-shopping"),
      optModeling: document.getElementById("opt-modeling"),
      optFurniture: document.getElementById("opt-furniture"),
      optLandscape: document.getElementById("opt-landscape"),
      opt4k: document.getElementById("opt-4k"),
      optSources: document.getElementById("opt-sources"),
      optAnimation: document.getElementById("opt-animation"),
      animSeconds: document.getElementById("anim-seconds"),
      clientName: document.getElementById("client-name"),
      currencyMga: document.getElementById("currency-mga"),
      currencyEur: document.getElementById("currency-eur"),
      summaryAdvanced: document.getElementById("summary-advanced"),
      deliverables: document.getElementById("deliverables"),
      deliverablesBody: document.getElementById("deliverables-body"),
      deliverablesToggle: document.getElementById("deliverables-toggle"),
      deliverablesBadges: document.getElementById("deliverables-badges"),
      totalMain: document.getElementById("total-main"),
      totalAlt: document.getElementById("total-alt"),
      totalLabel: document.getElementById("total-label"),
      cyclesIncluded: document.getElementById("cycles-included"),
      minimumPill: document.getElementById("minimum-pill"),
      emptyWarning: document.getElementById("empty-warning"),
      animBlock: document.getElementById("anim-block"),
      travelBlock: document.getElementById("travel-block"),
      volumeInterior: document.getElementById("volume-interior"),
      volumeExterior: document.getElementById("volume-exterior"),
      volumeScenes: document.getElementById("volume-scenes"),
      m2Field: document.getElementById("m2-field"),
      openSettings: document.getElementById("open-settings"),
      settingsOverlay: document.getElementById("settings-overlay"),
      settingsForm: document.getElementById("settings-form"),
      saveConfig: document.getElementById("save-config"),
      resetConfig: document.getElementById("reset-config"),
      exportConfig: document.getElementById("export-config"),
      importConfig: document.getElementById("import-config"),
      exportSnapshot: document.getElementById("export-snapshot"),
      importSnapshot: document.getElementById("import-snapshot"),
      openBilling: document.getElementById("open-billing"),
      billingOverlay: document.getElementById("billing-overlay"),
      copyInvoice: document.getElementById("copy-invoice"),
      downloadInvoice: document.getElementById("download-invoice"),
      printInvoice: document.getElementById("print-invoice"),
      companyName: document.getElementById("company-name"),
      companyAddress: document.getElementById("company-address"),
      companyCountry: document.getElementById("company-country"),
      companyPostal: document.getElementById("company-postal"),
      companyPhone: document.getElementById("company-phone"),
      companyNif: document.getElementById("company-nif"),
      companyEmail: document.getElementById("company-email"),
      clientBillingName: document.getElementById("client-billing-name"),
      clientBillingAddress: document.getElementById("client-billing-address"),
      clientBillingCountry: document.getElementById("client-billing-country"),
      clientBillingPostal: document.getElementById("client-billing-postal"),
      clientBillingPhone: document.getElementById("client-billing-phone"),
      clientBillingNif: document.getElementById("client-billing-nif"),
      clientBillingEmail: document.getElementById("client-billing-email"),
      invoiceNumber: document.getElementById("invoice-number"),
      invoiceDate: document.getElementById("invoice-date"),
      invoiceDueDate: document.getElementById("invoice-due-date"),
      invoiceNotes: document.getElementById("invoice-notes"),
      invoiceShowDetails: document.getElementById("invoice-show-details"),
      customFields: document.getElementById("custom-fields"),
      addCustomField: document.getElementById("add-custom-field"),
      invoicePreview: document.getElementById("invoice-preview"),
      invoiceStatus: document.getElementById("invoice-status")
    };

    function loadConfig() {
      const stored = localStorage.getItem("tk_quote_calc_config_v1");
      if (!stored) return structuredClone(CONFIG_DEFAULT);
      try {
        const parsed = JSON.parse(stored);
        if (!parsed.base || !parsed.packs || !parsed.multipliers) {
          throw new Error("Invalid config");
        }
        return parsed;
      } catch (error) {
        showToast("Configuration locale invalide. Valeurs par défaut appliquées.");
        return structuredClone(CONFIG_DEFAULT);
      }
    }

    function saveConfig() {
      localStorage.setItem("tk_quote_calc_config_v1", JSON.stringify(CONFIG));
    }

    function resetConfig() {
      CONFIG = structuredClone(CONFIG_DEFAULT);
      saveConfig();
      buildSettingsForm();
      calculateAndRender();
    }

    function loadUIState() {
      const stored = localStorage.getItem("tk_quote_calc_ui_v1");
      if (!stored) return structuredClone(UI_DEFAULT);
      try {
        return normalizeUIState(JSON.parse(stored));
      } catch (error) {
        return structuredClone(UI_DEFAULT);
      }
    }

    function saveUIState() {
      localStorage.setItem("tk_quote_calc_ui_v1", JSON.stringify(UI_STATE));
    }

    function normalizeUIState(state) {
      const base = {
        ...structuredClone(UI_DEFAULT),
        ...(state || {})
      };
      const legacyForm = state?.form || {};
      const tax = {
        enabled: state?.tax?.enabled ?? state?.showTva ?? UI_DEFAULT.tax.enabled,
        tvaRate: state?.tax?.tvaRate ?? legacyForm.tvaRate ?? UI_DEFAULT.tax.tvaRate,
        rate: state?.tax?.rate ?? legacyForm.rate ?? UI_DEFAULT.tax.rate
      };
      const form = { ...(state?.form || {}) };
      delete form.tvaRate;
      delete form.rate;
      const { showTva, ...rest } = base;
      return { ...rest, tax, form };
    }

    function loadBilling() {
      const stored = localStorage.getItem("tk_quote_calc_billing_v1");
      if (!stored) return structuredClone(BILLING_DEFAULT);
      try {
        const parsed = JSON.parse(stored);
        return {
          ...structuredClone(BILLING_DEFAULT),
          ...parsed,
          issuer: { ...BILLING_DEFAULT.issuer, ...parsed.issuer },
          client: { ...BILLING_DEFAULT.client, ...parsed.client },
          invoice: { ...BILLING_DEFAULT.invoice, ...parsed.invoice },
          customFields: Array.isArray(parsed.customFields) ? parsed.customFields : []
        };
      } catch (error) {
        return structuredClone(BILLING_DEFAULT);
      }
    }

    function saveBilling() {
      localStorage.setItem("tk_quote_calc_billing_v1", JSON.stringify(BILLING));
    }

    function showToast(message) {
      const alert = document.createElement("div");
      alert.textContent = message;
      alert.style.position = "fixed";
      alert.style.bottom = "24px";
      alert.style.right = "24px";
      alert.style.padding = "12px 16px";
      alert.style.background = "rgba(15, 23, 42, 0.9)";
      alert.style.color = "#fff";
      alert.style.borderRadius = "12px";
      alert.style.zIndex = "40";
      alert.style.fontSize = "0.85rem";
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3200);
    }

    const packLabelMap = {
      concept: "Concept",
      standard: "Standard",
      premium: "Premium"
    };

    const serviceLabelMap = {
      visual: "Visuels 3D",
      interior: "Design intérieur",
      exterior: "Design extérieur"
    };

    function clamp(n, min, max) {
      return Math.min(max, Math.max(min, n));
    }

    function debounce(fn, wait = 60) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), wait);
      };
    }

    function applyTieredPricing(qty, tiers) {
      let remaining = qty;
      let total = 0;
      let previousLimit = 0;
      for (const tier of tiers) {
        const tierLimit = tier.upTo === Infinity ? remaining : Math.max(0, tier.upTo - previousLimit);
        const units = Math.min(remaining, tierLimit);
        if (units <= 0) {
          previousLimit = tier.upTo;
          continue;
        }
        total += units * tier.unit;
        remaining -= units;
        previousLimit = tier.upTo;
        if (remaining <= 0) break;
      }
      return total;
    }

    function formatCurrency(valueMga) {
      const rate = Number(elements.rate.value) || CONFIG.eur_mga_rate;
      const displayCurrency = UI_STATE.currency;
      if (displayCurrency === "MGA") {
        return `${Math.round(valueMga).toLocaleString("fr-FR")} Ar`;
      }
      const eur = valueMga / rate;
      return `${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
    }

    function formatAltCurrency(valueMga) {
      const rate = Number(elements.rate.value) || CONFIG.eur_mga_rate;
      if (UI_STATE.currency === "MGA") {
        const eur = valueMga / rate;
        return `≈ ${eur.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
      }
      return `≈ ${Math.round(valueMga).toLocaleString("fr-FR")} Ar`;
    }

    function getVisualTier(details) {
      const map = {
        concept: "concept",
        realistic: "standard",
        photoreal: "premium"
      };
      return map[details] || "standard";
    }

    function getResolution(packKey, is4k) {
      if (is4k) return "4K";
      const map = { concept: "HD", standard: "2K", premium: "4K" };
      return map[packKey] || "2K";
    }

    function setDeliverablesExpanded(expanded) {
      UI_STATE.deliverablesExpanded = expanded;
      elements.deliverablesBody.hidden = !expanded;
      elements.deliverablesToggle.textContent = expanded ? "Masquer les livrables" : "Voir les livrables";
      elements.deliverablesToggle.setAttribute("aria-expanded", String(expanded));
      saveUIState();
    }

    function getVolumes() {
      return {
        pieces: {
          small: Math.max(0, Number(elements.piecesSmall.value) || 0),
          medium: Math.max(0, Number(elements.piecesMedium.value) || 0),
          large: Math.max(0, Number(elements.piecesLarge.value) || 0)
        },
        zones: {
          small: Math.max(0, Number(elements.zonesSmall.value) || 0),
          medium: Math.max(0, Number(elements.zonesMedium.value) || 0),
          large: Math.max(0, Number(elements.zonesLarge.value) || 0)
        },
        scenes: {
          small: Math.max(0, Number(elements.scenesSmall.value) || 0),
          medium: Math.max(0, Number(elements.scenesMedium.value) || 0),
          large: Math.max(0, Number(elements.scenesLarge.value) || 0)
        }
      };
    }

    function applyUIState() {
      const form = UI_STATE.form || {};
      elements.toggleTva.checked = UI_STATE.tax?.enabled ?? false;
      elements.service.value = form.service || "visual";
      elements.pack.value = form.pack || "standard";
      elements.nbVisuels.value = form.nbVisuels ?? 0;
      elements.piecesSmall.value = form.piecesSmall ?? 0;
      elements.piecesMedium.value = form.piecesMedium ?? 0;
      elements.piecesLarge.value = form.piecesLarge ?? 0;
      elements.zonesSmall.value = form.zonesSmall ?? 0;
      elements.zonesMedium.value = form.zonesMedium ?? 0;
      elements.zonesLarge.value = form.zonesLarge ?? 0;
      elements.scenesSmall.value = form.scenesSmall ?? 0;
      elements.scenesMedium.value = form.scenesMedium ?? 0;
      elements.scenesLarge.value = form.scenesLarge ?? 0;
      elements.complexity.value = form.complexity || "standard";
      elements.details.value = form.details || "realistic";
      elements.usage.value = form.usage || "commercial";
      elements.delay.value = form.delay || "standard";
      elements.toggleM2.checked = form.toggleM2 ?? false;
      elements.m2Value.value = form.m2Value ?? 0;
      elements.cycles.value = form.cycles ?? 2;
      elements.optTravel.checked = form.optTravel ?? false;
      elements.travelKm.value = form.travelKm ?? 0;
      elements.optMoodboard.checked = form.optMoodboard ?? false;
      elements.optPlan.checked = form.optPlan ?? false;
      elements.optShopping.checked = form.optShopping ?? false;
      elements.optModeling.checked = form.optModeling ?? false;
      elements.optFurniture.checked = form.optFurniture ?? false;
      elements.optLandscape.checked = form.optLandscape ?? false;
      elements.opt4k.checked = form.opt4k ?? false;
      elements.optSources.checked = form.optSources ?? false;
      elements.optAnimation.checked = form.optAnimation ?? false;
      elements.animSeconds.value = form.animSeconds ?? 0;
      elements.clientName.value = form.clientName || "";
      elements.tvaRate.value = UI_STATE.tax?.tvaRate ?? CONFIG.vat_rate;
      elements.rate.value = UI_STATE.tax?.rate ?? CONFIG.eur_mga_rate;
    }

    function syncStateFromInputs() {
      UI_STATE.tax = {
        enabled: elements.toggleTva.checked,
        tvaRate: Number(elements.tvaRate.value) || 0,
        rate: Number(elements.rate.value) || CONFIG.eur_mga_rate
      };
      UI_STATE.form = {
        service: elements.service.value,
        pack: elements.pack.value,
        nbVisuels: Number(elements.nbVisuels.value) || 0,
        piecesSmall: Number(elements.piecesSmall.value) || 0,
        piecesMedium: Number(elements.piecesMedium.value) || 0,
        piecesLarge: Number(elements.piecesLarge.value) || 0,
        zonesSmall: Number(elements.zonesSmall.value) || 0,
        zonesMedium: Number(elements.zonesMedium.value) || 0,
        zonesLarge: Number(elements.zonesLarge.value) || 0,
        scenesSmall: Number(elements.scenesSmall.value) || 0,
        scenesMedium: Number(elements.scenesMedium.value) || 0,
        scenesLarge: Number(elements.scenesLarge.value) || 0,
        complexity: elements.complexity.value,
        details: elements.details.value,
        usage: elements.usage.value,
        delay: elements.delay.value,
        toggleM2: elements.toggleM2.checked,
        m2Value: Number(elements.m2Value.value) || 0,
        cycles: Number(elements.cycles.value) || 1,
        optTravel: elements.optTravel.checked,
        travelKm: Number(elements.travelKm.value) || 0,
        optMoodboard: elements.optMoodboard.checked,
        optPlan: elements.optPlan.checked,
        optShopping: elements.optShopping.checked,
        optModeling: elements.optModeling.checked,
        optFurniture: elements.optFurniture.checked,
        optLandscape: elements.optLandscape.checked,
        opt4k: elements.opt4k.checked,
        optSources: elements.optSources.checked,
        optAnimation: elements.optAnimation.checked,
        animSeconds: Number(elements.animSeconds.value) || 0,
        clientName: elements.clientName.value
      };
    }

    function getTodayInputValue() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function buildInvoiceNumber() {
      const today = new Date();
      const dateStamp = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;
      const randomSuffix = String(Math.floor(Math.random() * 900) + 100);
      return `FAC-${dateStamp}-${randomSuffix}`;
    }

    function ensureInvoiceDefaults() {
      let updated = false;
      if (!BILLING.invoice.invoice_date) {
        BILLING.invoice.invoice_date = getTodayInputValue();
        updated = true;
      }
      if (!BILLING.invoice.invoice_number) {
        BILLING.invoice.invoice_number = buildInvoiceNumber();
        updated = true;
      }
      if (updated) {
        saveBilling();
      }
      elements.invoiceDate.value = BILLING.invoice.invoice_date;
      elements.invoiceNumber.value = BILLING.invoice.invoice_number;
    }

    function applyBillingState() {
      elements.companyName.value = BILLING.issuer.company_name || "";
      elements.companyAddress.value = BILLING.issuer.company_address || "";
      elements.companyCountry.value = BILLING.issuer.company_country || "";
      elements.companyPostal.value = BILLING.issuer.company_postal || "";
      elements.companyPhone.value = BILLING.issuer.company_phone || "";
      elements.companyNif.value = BILLING.issuer.company_nif || "";
      elements.companyEmail.value = BILLING.issuer.company_email || "";
      elements.clientBillingName.value = BILLING.client.client_name || "";
      elements.clientBillingAddress.value = BILLING.client.client_address || "";
      elements.clientBillingCountry.value = BILLING.client.client_country || "";
      elements.clientBillingPostal.value = BILLING.client.client_postal || "";
      elements.clientBillingPhone.value = BILLING.client.client_phone || "";
      elements.clientBillingNif.value = BILLING.client.client_nif || "";
      elements.clientBillingEmail.value = BILLING.client.client_email || "";
      elements.invoiceNumber.value = BILLING.invoice.invoice_number || "";
      elements.invoiceDate.value = BILLING.invoice.invoice_date || "";
      elements.invoiceDueDate.value = BILLING.invoice.due_date || "";
      elements.invoiceNotes.value = BILLING.invoice.notes || "";
      elements.invoiceShowDetails.checked = BILLING.invoice.show_details ?? true;
      renderCustomFields();
    }

    function syncBillingFromForm() {
      BILLING.issuer = {
        company_name: elements.companyName.value,
        company_address: elements.companyAddress.value,
        company_country: elements.companyCountry.value,
        company_postal: elements.companyPostal.value,
        company_phone: elements.companyPhone.value,
        company_nif: elements.companyNif.value,
        company_email: elements.companyEmail.value
      };
      BILLING.client = {
        client_name: elements.clientBillingName.value,
        client_address: elements.clientBillingAddress.value,
        client_country: elements.clientBillingCountry.value,
        client_postal: elements.clientBillingPostal.value,
        client_phone: elements.clientBillingPhone.value,
        client_nif: elements.clientBillingNif.value,
        client_email: elements.clientBillingEmail.value
      };
      BILLING.invoice = {
        invoice_number: elements.invoiceNumber.value,
        invoice_date: elements.invoiceDate.value,
        due_date: elements.invoiceDueDate.value,
        notes: elements.invoiceNotes.value,
        show_details: elements.invoiceShowDetails.checked
      };
      saveBilling();
    }

    function renderCustomFields() {
      elements.customFields.innerHTML = "";
      if (!Array.isArray(BILLING.customFields)) {
        BILLING.customFields = [];
      }
      BILLING.customFields.forEach((field, index) => {
        const row = document.createElement("div");
        row.className = "custom-field-row";
        row.innerHTML = `
          <input type="text" placeholder="Libellé" value="${field.label || ""}" />
          <input type="text" placeholder="Valeur" value="${field.value || ""}" />
          <button class="btn" type="button">Supprimer</button>
        `;
        const [labelInput, valueInput, deleteButton] = row.querySelectorAll("input, button");
        labelInput.addEventListener("input", event => {
          BILLING.customFields[index].label = event.target.value;
          saveBilling();
          updateInvoicePreview();
        });
        valueInput.addEventListener("input", event => {
          BILLING.customFields[index].value = event.target.value;
          saveBilling();
          updateInvoicePreview();
        });
        deleteButton.addEventListener("click", () => {
          BILLING.customFields.splice(index, 1);
          saveBilling();
          renderCustomFields();
          updateInvoicePreview();
        });
        elements.customFields.appendChild(row);
      });
    }

    function getSelectedMultipliers(service) {
      return {
        complexity: elements.complexity.value,
        details: elements.details.value,
        usage: elements.usage.value,
        delay: elements.delay.value
      };
    }

    function calculate() {
      const service = elements.service.value;
      const pack = elements.pack.value;
      const nbVisuels = Math.max(0, Number(elements.nbVisuels.value) || 0);
      const volumes = getVolumes();
      const m2Enabled = elements.toggleM2.checked && CONFIG.toggles.enable_tiered_m2;
      const m2Value = Math.max(0, Number(elements.m2Value.value) || 0);
      const multipliersSelected = getSelectedMultipliers(service);

      let base = CONFIG.base[service === "visual" ? "visual" : service];
      let production = 0;
      let productionDetail = {
        pieces: 0,
        scenes: 0,
        visuals: 0,
        renders: 0,
        m2: 0
      };

      if (service === "visual") {
        productionDetail.scenes =
          volumes.scenes.small * CONFIG.scenes.small +
          volumes.scenes.medium * CONFIG.scenes.medium +
          volumes.scenes.large * CONFIG.scenes.large;
        if (CONFIG.toggles.enable_visual_tiers) {
          productionDetail.visuals = applyTieredPricing(nbVisuels, CONFIG.visual_tiers[multipliersSelected.details]);
        } else {
          productionDetail.visuals = nbVisuels * CONFIG.visual_unit[multipliersSelected.details];
        }
        production = productionDetail.scenes + productionDetail.visuals;
      }

      if (service === "interior") {
        if (m2Enabled) {
          productionDetail.m2 = applyTieredPricing(m2Value, CONFIG.tiered_m2);
          production = productionDetail.m2;
        } else {
          const pricing = CONFIG.packs.interior[pack];
          productionDetail.pieces =
            volumes.pieces.small * pricing.small +
            volumes.pieces.medium * pricing.medium +
            volumes.pieces.large * pricing.large;
          production = productionDetail.pieces;
        }
        if (nbVisuels > 0) {
          productionDetail.renders = CONFIG.toggles.enable_render_tiers
            ? applyTieredPricing(nbVisuels, CONFIG.render_tiers.interior)
            : nbVisuels * CONFIG.render_unit.interior;
          production += productionDetail.renders;
        }
      }

      if (service === "exterior") {
        if (m2Enabled) {
          productionDetail.m2 = applyTieredPricing(m2Value, CONFIG.tiered_m2);
          production = productionDetail.m2;
        } else {
          const pricing = CONFIG.packs.exterior[pack];
          productionDetail.pieces =
            volumes.zones.small * pricing.small +
            volumes.zones.medium * pricing.medium +
            volumes.zones.large * pricing.large;
          production = productionDetail.pieces;
        }
        if (nbVisuels > 0) {
          productionDetail.renders = CONFIG.toggles.enable_render_tiers
            ? applyTieredPricing(nbVisuels, CONFIG.render_tiers.exterior)
            : nbVisuels * CONFIG.render_unit.exterior;
          production += productionDetail.renders;
        }
      }

      const multiplierTotal =
        CONFIG.multipliers.complexity[multipliersSelected.complexity] *
        CONFIG.multipliers.details[multipliersSelected.details] *
        CONFIG.multipliers.delay[multipliersSelected.delay] *
        CONFIG.multipliers.usage[multipliersSelected.usage];

      const subTotal = (base + production) * multiplierTotal;
      const animSeconds = clamp(Number(elements.animSeconds.value) || 0, 0, 120);
      elements.animSeconds.value = animSeconds;

      let options = 0;
      if (elements.optMoodboard.checked) options += CONFIG.options.moodboard;
      if (elements.optPlan.checked) options += CONFIG.options.plan2d;
      if (elements.optShopping.checked) options += CONFIG.options.shopping;
      if (elements.optModeling.checked) options += production * CONFIG.options.modeling_pct;
      if (elements.optFurniture.checked) options += production * CONFIG.options.furniture_pct;
      if (elements.optLandscape.checked) options += production * CONFIG.options.landscape_pct;
      if (elements.opt4k.checked) options += production * CONFIG.options.render4k_pct;
      if (elements.optSources.checked) options += subTotal * CONFIG.options.sources_pct;
      if (elements.optAnimation.checked) {
        options += animSeconds * CONFIG.options.animation_sec;
      }

      const cyclesAsked = Math.max(1, Number(elements.cycles.value) || 1);
      const cyclesExtra = Math.max(0, cyclesAsked - CONFIG.revisions.included);
      const revisions = cyclesExtra * (base + production) * CONFIG.revisions.rate;

      let fees = 0;
      if (elements.optTravel.checked) {
        fees = CONFIG.travel.flat + (Number(elements.travelKm.value) || 0) * CONFIG.travel.km;
      }

      const totalBrut = subTotal + options + revisions + fees;
      const totalFinal = Math.max(CONFIG.minimum, totalBrut);
      const minimumApplied = totalBrut < CONFIG.minimum;
      const tvaRate = elements.toggleTva.checked ? Number(elements.tvaRate.value) || 0 : 0;
      const tvaAmount = totalFinal * (tvaRate / 100);
      const totalTtc = totalFinal + tvaAmount;

      return {
        service,
        pack,
        nbVisuels,
        volumes,
        m2Enabled,
        m2Value,
        multipliersSelected,
        base,
        production,
        productionDetail,
        multiplierTotal,
        subTotal,
        options,
        revisions,
        fees,
        totalBrut,
        minimumApplied,
        totalFinal,
        tvaRate,
        tvaAmount,
        totalTtc
      };
    }

    function render(data) {
      const showTva = elements.toggleTva.checked;
      const totalHT = data.totalFinal;
      const totalTTC = data.totalTtc;
      const grandTotal = showTva ? totalTTC : totalHT;
      elements.totalMain.textContent = formatCurrency(grandTotal);
      elements.totalAlt.textContent = formatAltCurrency(grandTotal);
      elements.totalLabel.textContent = showTva ? "Total TTC" : "Total HT";

      const totalPieces =
        data.service === "visual"
          ? data.volumes.scenes.small + data.volumes.scenes.medium + data.volumes.scenes.large
          : data.service === "interior"
          ? data.volumes.pieces.small + data.volumes.pieces.medium + data.volumes.pieces.large
          : data.volumes.zones.small + data.volumes.zones.medium + data.volumes.zones.large;
      elements.minimumPill.style.display = data.minimumApplied ? "inline-flex" : "none";
      const isEmpty = totalPieces === 0 && data.nbVisuels === 0 && (!data.m2Enabled || data.m2Value === 0);
      elements.emptyWarning.style.display = isEmpty ? "block" : "none";

      const lines = [
        `<div class="summary-item"><span>Base</span><span>${formatCurrency(data.base)}</span></div>`,
        `<div class="summary-item"><span>Production</span><span>${formatCurrency(data.production)}</span></div>`,
        data.productionDetail.pieces
          ? `<div class="summary-item sub"><span>Pièces/Zones</span><span>${formatCurrency(data.productionDetail.pieces)}</span></div>`
          : "",
        data.productionDetail.scenes
          ? `<div class="summary-item sub"><span>Scènes</span><span>${formatCurrency(data.productionDetail.scenes)}</span></div>`
          : "",
        data.productionDetail.visuals
          ? `<div class="summary-item sub"><span>Visuels</span><span>${formatCurrency(data.productionDetail.visuals)}</span></div>`
          : "",
        data.productionDetail.renders
          ? `<div class="summary-item sub"><span>Rendus</span><span>${formatCurrency(data.productionDetail.renders)}</span></div>`
          : "",
        data.productionDetail.m2
          ? `<div class="summary-item sub"><span>Surface (m²)</span><span>${formatCurrency(data.productionDetail.m2)}</span></div>`
          : "",
        `<div class="summary-item"><span>Sous-total (HT)</span><span>${formatCurrency(data.subTotal)}</span></div>`,
        `<div class="summary-item"><span>Multiplicateur (complexité × détails × délais × usage)</span><span>x${data.multiplierTotal.toFixed(2)}</span></div>`,
        data.options ? `<div class="summary-item"><span>Options</span><span>${formatCurrency(data.options)}</span></div>` : "",
        data.revisions ? `<div class="summary-item"><span>Retours</span><span>${formatCurrency(data.revisions)}</span></div>` : "",
        data.fees ? `<div class="summary-item"><span>Frais</span><span>${formatCurrency(data.fees)}</span></div>` : "",
        data.minimumApplied
          ? `<div class="summary-item"><span>Minimum appliqué</span><span>${formatCurrency(CONFIG.minimum)}</span></div>`
          : "",
        showTva
          ? `<div class="summary-item"><span>TVA (${data.tvaRate}%)</span><span>${formatCurrency(data.tvaAmount)}</span></div>`
          : "",
        `<div class="summary-item total"><span>Total ${showTva ? "TTC" : "HT"}</span><span>${formatCurrency(grandTotal)}</span></div>`
      ].filter(Boolean);

      elements.summaryAdvanced.innerHTML = lines.join("");

      renderDeliverables(data);
    }

    function renderDeliverables(data) {
      const modeKey = "advanced";
      const packKey = data.service === "visual" ? getVisualTier(data.multipliersSelected.details) : data.pack;
      const baseItems = LIVRABLES[data.service]?.[packKey]?.[modeKey] || [];
      const totalScenes = data.volumes.scenes.small + data.volumes.scenes.medium + data.volumes.scenes.large;
      const totalPieces =
        data.service === "visual"
          ? totalScenes
          : data.service === "interior"
          ? data.volumes.pieces.small + data.volumes.pieces.medium + data.volumes.pieces.large
          : data.volumes.zones.small + data.volumes.zones.medium + data.volumes.zones.large;
      const hasQuantities = !(totalPieces === 0 && data.nbVisuels === 0 && (!data.m2Enabled || data.m2Value === 0));

      if (!hasQuantities) {
        elements.deliverablesBody.innerHTML = `<p class="deliverables-empty">Ajoute des volumes pour voir les livrables.</p>`;
        elements.deliverablesBadges.innerHTML = "";
        return;
      }

      const optionItems = [];
      if (elements.optMoodboard.checked) {
        optionItems.push("Moodboard détaillé (PDF)");
      }
      if (elements.optPlan.checked) {
        optionItems.push("Plan 2D (PDF + DWG)");
      }
      if (elements.optShopping.checked) {
        optionItems.push("Shopping list détaillée (liens & références)");
      }
      if (elements.optModeling.checked) {
        optionItems.push("Modélisation sur mesure (assets dédiés)");
      }
      if (elements.optFurniture.checked) {
        optionItems.push("Sélection mobilier/déco (références produit)");
      }
      if (elements.optLandscape.checked) {
        optionItems.push("Plan paysager & végétation (species)");
      }
      if (elements.optSources.checked) {
        const sourcesText = "Fichiers sources (.blend/.max/.skp selon pipeline)";
        optionItems.push(`${sourcesText}<span class="deliverables-note">Support & modifications non inclus.</span>`);
      }

      const volumeItems = [];
      if (data.service === "visual") {
        if (totalScenes > 0) {
          volumeItems.push(
            `Scènes S/M/L : ${data.volumes.scenes.small}/${data.volumes.scenes.medium}/${data.volumes.scenes.large} (total ${totalScenes})`
          );
        }
        volumeItems.push("Plan de caméras + focales");
      } else if (data.m2Enabled && data.m2Value > 0) {
        volumeItems.push(
          `Zoning & plans d'aménagement sur ${data.m2Value} m² (PDF)`
        );
      } else if (totalPieces > 0) {
        const label = data.service === "interior" ? "pièce" : "zone";
        volumeItems.push(
          `${totalPieces} ${label}${totalPieces > 1 ? "s" : ""} (S/M/L)`
        );
      }

      if (data.nbVisuels > 0) {
        const resolution = getResolution(packKey, elements.opt4k.checked);
        volumeItems.push(`Rendus : ${data.nbVisuels} image${data.nbVisuels > 1 ? "s" : ""} (${resolution})`);
      }

      if (elements.optAnimation.checked) {
        const seconds = clamp(Number(elements.animSeconds.value) || 0, 0, 120);
        const resolution = getResolution(packKey, elements.opt4k.checked);
        volumeItems.push(
          `Animation ${seconds}s (MP4/H.264, ${resolution}, 25fps)`
        );
      }

      const cycleText = `Retours : ${CONFIG.revisions.included} cycles inclus, cycles supplémentaires facturés à ${CONFIG.revisions.rate}%.`;
      const planningItems = [cycleText];
      if (data.multipliersSelected.delay !== "standard") {
        const delayLabel = data.multipliersSelected.delay === "express" ? "Express" : "Urgent";
        planningItems.push(
          `Planning prioritaire (${delayLabel}) — jalons validés en 24/48h.`
        );
      }

      const sections = [
        { title: "Base du pack", items: baseItems },
        { title: "Volumes & rendus", items: volumeItems },
        optionItems.length ? { title: "Options activées", items: optionItems } : null,
        { title: "Retours & planning", items: planningItems }
      ].filter(Boolean);

      const badges = [];
      if (data.multipliersSelected.delay !== "standard") {
        badges.push({ label: "Planning prioritaire", type: "warn" });
      }
      if (elements.opt4k.checked) {
        badges.push({ label: "4K activé", type: "info" });
      }
      if (elements.optSources.checked) {
        badges.push({ label: "Sources", type: "warn" });
      }

      elements.deliverablesBadges.innerHTML = badges
        .map(
          badge =>
            `<span class="deliverables-badge${badge.type === "warn" ? " deliverables-badge--warn" : ""}">${badge.label}</span>`
        )
        .join("");

      elements.deliverablesBody.innerHTML = sections
        .map(
          section => `
            <div class="deliverables-section">
              <h4>${section.title}</h4>
              <ul>${section.items.map(item => `<li>${item}</li>`).join("")}</ul>
            </div>
          `
        )
        .join("");
    }

    function setGroupDisabled(container, disabled) {
      container.classList.toggle("is-disabled", disabled);
      container.setAttribute("aria-disabled", disabled ? "true" : "false");
      container.querySelectorAll("input, select, textarea, button").forEach(control => {
        control.disabled = disabled;
      });
    }

    function setGroupVisibility(container, visible) {
      container.style.display = visible ? "" : "none";
      container.setAttribute("aria-hidden", visible ? "false" : "true");
      container.querySelectorAll("input, select, textarea, button").forEach(control => {
        control.disabled = !visible;
      });
    }

    function updateVisibility() {
      const service = elements.service.value;
      const m2Active = elements.toggleM2.checked && service !== "visual";
      setGroupVisibility(elements.volumeInterior, service === "interior" && !m2Active);
      setGroupVisibility(elements.volumeExterior, service === "exterior" && !m2Active);
      setGroupVisibility(elements.volumeScenes, service === "visual");
      elements.pack.disabled = service === "visual";
      elements.pack.style.opacity = service === "visual" ? 0.5 : 1;
      elements.animBlock.style.display = elements.optAnimation.checked ? "flex" : "none";
      setGroupDisabled(elements.travelBlock, !elements.optTravel.checked);
      elements.toggleM2.disabled = service === "visual";
      elements.toggleM2.closest(".form-item").classList.toggle("is-disabled", service === "visual");
      if (service === "visual") elements.toggleM2.checked = false;
      setGroupDisabled(elements.m2Field, !(elements.toggleM2.checked && service !== "visual"));
      const landscapeLabel = elements.optLandscape.closest("label");
      setGroupDisabled(landscapeLabel, service === "interior");
    }

    function calculateAndRender() {
      updateVisibility();
      elements.cyclesIncluded.textContent = CONFIG.revisions.included;
      const data = calculate();
      render(data);
      syncStateFromInputs();
      saveUIState();
      updateInvoicePreview();
    }

    function bindSteppers() {
      document.querySelectorAll(".stepper button").forEach(button => {
        button.addEventListener("click", () => {
          const target = document.getElementById(button.dataset.target);
          const delta = Number(button.dataset.step);
          const current = Number(target.value) || 0;
          target.value = Math.max(0, current + delta);
          calculateAndRender();
        });
      });

    }

    function setCurrency(currency) {
      UI_STATE.currency = currency;
      elements.currencyMga.classList.toggle("active", currency === "MGA");
      elements.currencyEur.classList.toggle("active", currency === "EUR");
      elements.currencyMga.setAttribute("aria-selected", currency === "MGA" ? "true" : "false");
      elements.currencyEur.setAttribute("aria-selected", currency === "EUR" ? "true" : "false");
      calculateAndRender();
    }

    function buildSettingsForm() {
      const form = [];

      const addGroup = (title, inputs) => {
        form.push(`<div class="section-divider"><h3>${title}</h3><div class="settings-grid">${inputs.join("")}</div></div>`);
      };

      const inputField = (label, path, type = "number") => `
        <div>
          <label>${label}</label>
          <input data-path="${path}" type="${type}" />
        </div>`;

      addGroup("Bases", [
        inputField("Base visuel 3D", "base.visual"),
        inputField("Base intérieur", "base.interior"),
        inputField("Base extérieur", "base.exterior")
      ]);

      addGroup("Scènes 3D", [
        inputField("Scene small", "scenes.small"),
        inputField("Scene medium", "scenes.medium"),
        inputField("Scene large", "scenes.large")
      ]);

      addGroup("Pack intérieur - Concept", [
        inputField("Small", "packs.interior.concept.small"),
        inputField("Medium", "packs.interior.concept.medium"),
        inputField("Large", "packs.interior.concept.large")
      ]);

      addGroup("Pack intérieur - Standard", [
        inputField("Small", "packs.interior.standard.small"),
        inputField("Medium", "packs.interior.standard.medium"),
        inputField("Large", "packs.interior.standard.large")
      ]);

      addGroup("Pack intérieur - Premium", [
        inputField("Small", "packs.interior.premium.small"),
        inputField("Medium", "packs.interior.premium.medium"),
        inputField("Large", "packs.interior.premium.large")
      ]);

      addGroup("Pack extérieur - Concept", [
        inputField("Small", "packs.exterior.concept.small"),
        inputField("Medium", "packs.exterior.concept.medium"),
        inputField("Large", "packs.exterior.concept.large")
      ]);

      addGroup("Pack extérieur - Standard", [
        inputField("Small", "packs.exterior.standard.small"),
        inputField("Medium", "packs.exterior.standard.medium"),
        inputField("Large", "packs.exterior.standard.large")
      ]);

      addGroup("Pack extérieur - Premium", [
        inputField("Small", "packs.exterior.premium.small"),
        inputField("Medium", "packs.exterior.premium.medium"),
        inputField("Large", "packs.exterior.premium.large")
      ]);

      addGroup("Visuels 3D (unitaires)", [
        inputField("Concept", "visual_unit.concept"),
        inputField("Réaliste", "visual_unit.realistic"),
        inputField("Photoreal", "visual_unit.photoreal")
      ]);

      addGroup("Rendus unitaires", [
        inputField("Intérieur", "render_unit.interior"),
        inputField("Extérieur", "render_unit.exterior")
      ]);

      addGroup("Multiplicateurs", [
        inputField("Complexité simple", "multipliers.complexity.simple"),
        inputField("Complexité standard", "multipliers.complexity.standard"),
        inputField("Complexité complexe", "multipliers.complexity.complex"),
        inputField("Détails concept", "multipliers.details.concept"),
        inputField("Détails réaliste", "multipliers.details.realistic"),
        inputField("Détails photoreal", "multipliers.details.photoreal"),
        inputField("Délai standard", "multipliers.delay.standard"),
        inputField("Délai express", "multipliers.delay.express"),
        inputField("Délai urgent", "multipliers.delay.urgent"),
        inputField("Usage perso", "multipliers.usage.personal"),
        inputField("Usage commercial", "multipliers.usage.commercial"),
        inputField("Usage publicité", "multipliers.usage.ads")
      ]);

      addGroup("Options", [
        inputField("Moodboard", "options.moodboard"),
        inputField("Plan 2D", "options.plan2d"),
        inputField("Shopping list", "options.shopping"),
        inputField("Modélisation %", "options.modeling_pct"),
        inputField("Mobilier %", "options.furniture_pct"),
        inputField("Paysage %", "options.landscape_pct"),
        inputField("Rendu 4K %", "options.render4k_pct"),
        inputField("Sources %", "options.sources_pct"),
        inputField("Animation / sec", "options.animation_sec")
      ]);

      addGroup("Retours & frais", [
        inputField("Cycles inclus", "revisions.included"),
        inputField("Taux cycle", "revisions.rate"),
        inputField("Déplacement forfait", "travel.flat"),
        inputField("Prix km", "travel.km"),
        inputField("Minimum facturé", "minimum"),
        inputField("TVA défaut", "vat_rate"),
        inputField("Taux EUR-MGA", "eur_mga_rate")
      ]);

      addGroup("Toggles", [
        inputField("Tiers visuels", "toggles.enable_visual_tiers", "checkbox"),
        inputField("Tiers rendus", "toggles.enable_render_tiers", "checkbox"),
        inputField("Tiers m²", "toggles.enable_tiered_m2", "checkbox")
      ]);

      elements.settingsForm.innerHTML = form.join("");

      elements.settingsForm.querySelectorAll("input[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let value = CONFIG;
        path.forEach(key => {
          value = value[key];
        });
        if (input.type === "checkbox") {
          input.checked = Boolean(value);
        } else {
          input.value = value;
        }
      });
    }

    function readSettingsForm() {
      elements.settingsForm.querySelectorAll("input[data-path]").forEach(input => {
        const path = input.dataset.path.split(".");
        let target = CONFIG;
        for (let i = 0; i < path.length - 1; i++) {
          target = target[path[i]];
        }
        const key = path[path.length - 1];
        if (input.type === "checkbox") {
          target[key] = input.checked;
        } else if (input.type === "text") {
          target[key] = input.value;
        } else {
          target[key] = Number(input.value);
        }
      });
      saveConfig();
      calculateAndRender();
    }

    function openSettings() {
      buildSettingsForm();
      elements.settingsOverlay.style.display = "flex";
    }

    function closeSettings(event) {
      if (event.target === elements.settingsOverlay) {
        elements.settingsOverlay.style.display = "none";
      }
    }

    function openBilling() {
      elements.billingOverlay.style.display = "flex";
      ensureInvoiceDefaults();
      applyBillingState();
      updateInvoicePreview();
    }

    function closeBilling(event) {
      if (event.target === elements.billingOverlay) {
        elements.billingOverlay.style.display = "none";
      }
    }

    function exportConfig() {
      const blob = new Blob([JSON.stringify(CONFIG, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "config_devis.json";
      link.click();
    }

    function exportSnapshot() {
      syncStateFromInputs();
      syncBillingFromForm();
      const uiSnapshot = structuredClone(UI_STATE);
      const taxSnapshot = structuredClone(UI_STATE.tax || {});
      delete uiSnapshot.tax;
      const payload = {
        version: 2,
        exported_at: new Date().toISOString(),
        parameters: structuredClone(CONFIG),
        inputs: {
          ui: uiSnapshot,
          tax: taxSnapshot,
          billing: structuredClone(BILLING)
        }
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "devis_parametres_champs.json";
      link.click();
    }

    function importConfig(file) {
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.base || !data.packs) throw new Error("JSON invalide");
          CONFIG = data;
          saveConfig();
          buildSettingsForm();
          calculateAndRender();
        } catch (error) {
          showToast("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function importSnapshot(file) {
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.parameters || !data.inputs) throw new Error("JSON invalide");
          CONFIG = data.parameters;
          const rawUi = data.inputs.ui || {};
          const rawTax = data.inputs.tax || rawUi.tax;
          UI_STATE = normalizeUIState({ ...rawUi, tax: rawTax });
          BILLING = {
            ...structuredClone(BILLING_DEFAULT),
            ...(data.inputs.billing || {}),
            issuer: { ...BILLING_DEFAULT.issuer, ...(data.inputs.billing?.issuer || {}) },
            client: { ...BILLING_DEFAULT.client, ...(data.inputs.billing?.client || {}) },
            invoice: { ...BILLING_DEFAULT.invoice, ...(data.inputs.billing?.invoice || {}) },
            customFields: Array.isArray(data.inputs.billing?.customFields) ? data.inputs.billing.customFields : []
          };
          saveConfig();
          saveUIState();
          saveBilling();
          buildSettingsForm();
          applyUIState();
          applyBillingState();
          updateInvoicePreview();
          calculateAndRender();
        } catch (error) {
          showToast("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function formatInvoiceDate(dateValue) {
      if (!dateValue) return "—";
      const [year, month, day] = dateValue.split("-");
      return `${day}/${month}/${year}`;
    }

    function buildInvoiceLines(data, showDetails) {
      const showTva = elements.toggleTva.checked;
      if (!showDetails) {
        const totalBase = data.totalFinal;
        const lines = [{ label: "Prestation", amount: totalBase }];
        if (showTva) {
          lines.push({ label: `TVA (${data.tvaRate}%)`, amount: data.tvaAmount });
        }
        return lines;
      }
      const lines = [
        { label: "Base", amount: data.base },
        { label: "Production", amount: data.production }
      ];
      if (data.options) lines.push({ label: "Options", amount: data.options });
      if (data.revisions) lines.push({ label: "Retours", amount: data.revisions });
      if (data.fees) lines.push({ label: "Frais", amount: data.fees });
      if (showTva) lines.push({ label: `TVA (${data.tvaRate}%)`, amount: data.tvaAmount });
      return lines;
    }

    function buildInvoiceMarkup(data) {
      ensureInvoiceDefaults();
      const showDetails = BILLING.invoice.show_details ?? true;
      const showTva = elements.toggleTva.checked;
      const lines = buildInvoiceLines(data, showDetails);
      const totalLabel = showTva ? "Total TTC" : "Total HT";
      const totalValue = showTva ? data.totalTtc : data.totalFinal;

      const issuerLines = [
        BILLING.issuer.company_name,
        BILLING.issuer.company_address,
        BILLING.issuer.company_postal,
        BILLING.issuer.company_country,
        BILLING.issuer.company_phone,
        BILLING.issuer.company_nif,
        BILLING.issuer.company_email
      ].filter(Boolean);
      const clientLines = [
        BILLING.client.client_name,
        BILLING.client.client_address,
        BILLING.client.client_postal,
        BILLING.client.client_country,
        BILLING.client.client_phone,
        BILLING.client.client_nif,
        BILLING.client.client_email
      ].filter(Boolean);

      const customFields = BILLING.customFields
        .filter(field => field.label || field.value)
        .map(
          field =>
            `<div class="invoice-card"><h4>${field.label || "Champ"}</h4><div>${field.value || "—"}</div></div>`
        )
        .join("");

      const isDraft = !BILLING.invoice.invoice_number;

      return `
        <div class="invoice">
          <div class="invoice-hero">
            <div class="invoice-brand">
              <div class="invoice-logo">3D</div>
              <div>
                <span>Studio visuels</span>
                <strong>Design & Rendus</strong>
                <span>Facture professionnelle</span>
              </div>
            </div>
            <div class="invoice-meta">
              <div class="invoice-status ${isDraft ? "is-draft" : ""}">
                ${isDraft ? "Brouillon" : "Prêt"}
              </div>
              <div class="invoice-meta-grid">
                <div class="invoice-meta-item">
                  <strong>Numéro</strong>
                  ${BILLING.invoice.invoice_number || "—"}
                </div>
                <div class="invoice-meta-item">
                  <strong>Date</strong>
                  ${formatInvoiceDate(BILLING.invoice.invoice_date)}
                </div>
                <div class="invoice-meta-item">
                  <strong>Échéance</strong>
                  ${formatInvoiceDate(BILLING.invoice.due_date)}
                </div>
              </div>
            </div>
          </div>
          <div class="invoice-card-grid">
            <div class="invoice-card">
              <h4>Émetteur</h4>
              <div>${issuerLines.length ? issuerLines.join("<br />") : "—"}</div>
            </div>
            <div class="invoice-card">
              <h4>Client</h4>
              <div>${clientLines.length ? clientLines.join("<br />") : "—"}</div>
            </div>
            <div class="invoice-total-card">
              <span>${totalLabel}</span>
              <div class="invoice-total-amount">${formatCurrency(totalValue)}</div>
              <div>${showTva ? "TVA incluse" : "Montant HT"}</div>
            </div>
          </div>
          <table class="invoice-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Montant</th>
              </tr>
            </thead>
            <tbody>
              ${lines
                .map(line => `<tr><td>${line.label}</td><td>${formatCurrency(line.amount)}</td></tr>`)
                .join("")}
              <tr class="invoice-total">
                <td>${totalLabel}</td>
                <td>${formatCurrency(totalValue)}</td>
              </tr>
            </tbody>
          </table>
          <div class="invoice-footer">
            ${BILLING.invoice.notes ? `<div class="invoice-note">${BILLING.invoice.notes}</div>` : ""}
            ${customFields ? `<div class="invoice-card-grid">${customFields}</div>` : ""}
          </div>
        </div>
      `;
    }

    function buildInvoiceDocument(markup) {
      return `
        <!DOCTYPE html>
        <html lang="fr">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Facture ${BILLING.invoice.invoice_number || ""}</title>
            <style>
              body { font-family: "Segoe UI", "Inter", sans-serif; margin: 32px; color: #0f172a; background: #f8fafc; }
              .invoice { display: flex; flex-direction: column; gap: 18px; padding: 20px; border-radius: 18px; background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08); }
              .invoice-hero { display: flex; justify-content: space-between; gap: 16px; flex-wrap: wrap; padding: 16px; border-radius: 16px; background: linear-gradient(135deg, #dbeafe, #ede9fe); border: 1px solid #dbeafe; }
              .invoice-brand { display: flex; align-items: center; gap: 12px; min-width: 220px; }
              .invoice-logo { width: 46px; height: 46px; border-radius: 14px; background: #ffffff; display: grid; place-items: center; font-weight: 700; color: #1d4ed8; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.15); }
              .invoice-brand span { display: block; font-size: 0.75rem; color: #475569; }
              .invoice-brand strong { font-size: 1.05rem; display: block; }
              .invoice-meta { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
              .invoice-status { padding: 6px 12px; border-radius: 999px; background: #ccfbf1; color: #0f766e; font-weight: 600; font-size: 0.8rem; }
              .invoice-status.is-draft { background: #fee2e2; color: #b91c1c; }
              .invoice-meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; width: min(360px, 100%); }
              .invoice-meta-item { padding: 10px 12px; border-radius: 12px; background: #ffffff; border: 1px solid #e2e8f0; font-size: 0.82rem; }
              .invoice-meta-item strong { display: block; font-size: 0.72rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px; }
              .invoice-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
              .invoice-card { padding: 12px; border-radius: 14px; background: #ffffff; border: 1px solid #e2e8f0; }
              .invoice-card h4 { margin: 0 0 6px; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
              .invoice-total-card { padding: 14px; border-radius: 16px; background: #eff6ff; border: 1px solid #dbeafe; display: flex; flex-direction: column; gap: 6px; align-items: flex-end; text-align: right; }
              .invoice-total-card span { font-size: 0.8rem; color: #1d4ed8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
              .invoice-total-amount { font-size: 1.6rem; font-weight: 700; }
              .invoice-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
              .invoice-table th, .invoice-table td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; text-align: left; }
              .invoice-table th { background: #eff6ff; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #1d4ed8; }
              .invoice-table td:last-child, .invoice-table th:last-child { text-align: right; }
              .invoice-total { font-weight: 700; font-size: 1rem; }
              .invoice-total td { border-top: 1px solid #e2e8f0; }
              .invoice-footer { display: flex; flex-direction: column; gap: 12px; }
              .invoice-note { font-size: 0.85rem; color: #64748b; white-space: pre-wrap; }
            </style>
          </head>
          <body>
            ${markup}
          </body>
        </html>
      `;
    }

    function updateInvoicePreview() {
      const data = calculate();
      const markup = buildInvoiceMarkup(data);
      elements.invoicePreview.innerHTML = markup;
      elements.invoiceStatus.textContent = BILLING.invoice.invoice_number ? "Prêt" : "Brouillon";
    }

    function copyInvoice() {
      const markup = buildInvoiceMarkup(calculate());
      const html = buildInvoiceDocument(markup);
      navigator.clipboard.writeText(html).then(() => showToast("Facture copiée."));
    }

    function downloadInvoice() {
      const markup = buildInvoiceMarkup(calculate());
      const html = buildInvoiceDocument(markup);
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `facture_${new Date().toISOString().slice(0, 10)}.html`;
      link.click();
    }

    function printInvoice() {
      const markup = buildInvoiceMarkup(calculate());
      const html = buildInvoiceDocument(markup);
      const printWindow = window.open("", "_blank");
      if (!printWindow) {
        showToast("Impossible d'ouvrir la fenêtre d'impression.");
        return;
      }
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    function init() {
      setCurrency(UI_STATE.currency);
      elements.toggleTva.checked = UI_STATE.tax?.enabled ?? false;
      const hasStoredUi = Boolean(localStorage.getItem("tk_quote_calc_ui_v1"));
      const deliverablesMedia = window.matchMedia("(max-width: 980px)");
      if (!hasStoredUi && deliverablesMedia.matches) {
        UI_STATE.deliverablesExpanded = false;
      }
      setDeliverablesExpanded(UI_STATE.deliverablesExpanded);
      deliverablesMedia.addEventListener("change", event => {
        if (!event.matches) {
          setDeliverablesExpanded(true);
        } else if (!hasStoredUi) {
          setDeliverablesExpanded(false);
        }
      });
      applyBillingState();
      applyUIState();
      bindSteppers();

      const debouncedCalculateAndRender = debounce(() => {
        calculateAndRender();
      }, 70);

      document.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => {
          UI_STATE.tax.enabled = elements.toggleTva.checked;
          debouncedCalculateAndRender();
        });
        input.addEventListener("change", () => {
          UI_STATE.tax.enabled = elements.toggleTva.checked;
          debouncedCalculateAndRender();
        });
      });

      elements.currencyMga.addEventListener("click", () => setCurrency("MGA"));
      elements.currencyEur.addEventListener("click", () => setCurrency("EUR"));
      elements.openSettings.addEventListener("click", openSettings);
      elements.settingsOverlay.addEventListener("click", closeSettings);
      elements.openBilling.addEventListener("click", openBilling);
      elements.billingOverlay.addEventListener("click", closeBilling);
      elements.saveConfig.addEventListener("click", () => {
        readSettingsForm();
        elements.settingsOverlay.style.display = "none";
      });
      elements.resetConfig.addEventListener("click", resetConfig);
      elements.exportConfig.addEventListener("click", exportConfig);
      elements.importConfig.addEventListener("change", event => {
        if (event.target.files[0]) importConfig(event.target.files[0]);
      });
      elements.exportSnapshot.addEventListener("click", exportSnapshot);
      elements.importSnapshot.addEventListener("change", event => {
        if (event.target.files[0]) importSnapshot(event.target.files[0]);
      });
      elements.copyInvoice.addEventListener("click", copyInvoice);
      elements.downloadInvoice.addEventListener("click", downloadInvoice);
      elements.printInvoice.addEventListener("click", printInvoice);
      elements.deliverablesToggle.addEventListener("click", () =>
        setDeliverablesExpanded(!UI_STATE.deliverablesExpanded)
      );

      [
        elements.companyName,
        elements.companyAddress,
        elements.companyCountry,
        elements.companyPostal,
        elements.companyPhone,
        elements.companyNif,
        elements.companyEmail,
        elements.clientBillingName,
        elements.clientBillingAddress,
        elements.clientBillingCountry,
        elements.clientBillingPostal,
        elements.clientBillingPhone,
        elements.clientBillingNif,
        elements.clientBillingEmail,
        elements.invoiceNumber,
        elements.invoiceDate,
        elements.invoiceDueDate,
        elements.invoiceNotes,
        elements.invoiceShowDetails
      ].forEach(input => {
        input.addEventListener("input", () => {
          syncBillingFromForm();
          updateInvoicePreview();
        });
        input.addEventListener("change", () => {
          syncBillingFromForm();
          updateInvoicePreview();
        });
      });

      elements.addCustomField.addEventListener("click", () => {
        BILLING.customFields.push({ label: "", value: "" });
        saveBilling();
        renderCustomFields();
        updateInvoicePreview();
      });

      document.addEventListener("keydown", event => {
        if (event.key !== "Escape") return;
        if (elements.settingsOverlay.style.display === "flex") {
          elements.settingsOverlay.style.display = "none";
        }
        if (elements.billingOverlay.style.display === "flex") {
          elements.billingOverlay.style.display = "none";
        }
      });

      calculateAndRender();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
